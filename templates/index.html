<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keyword Research Command Center</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            color: #e2e8f0;
            min-height: 100vh;
        }

        .container { max-width: 1900px; margin: 0 auto; padding: 20px; }

        /* Header */
        header {
            text-align: center;
            padding: 30px 0;
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #a78bfa, #f472b6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        header p { color: #94a3b8; font-size: 1.1rem; }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 24px;
            background: rgba(15, 23, 42, 0.5);
            padding: 4px;
            border-radius: 12px;
            width: fit-content;
        }

        .tab {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab:hover { color: #e2e8f0; }
        .tab.active { background: #3b82f6; color: white; }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Research Section */
        .research-box {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .research-box h2 {
            font-size: 1.3rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .research-form {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .form-group label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-group input, .form-group select {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            min-width: 250px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #60a5fa;
        }

        .research-btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            padding: 12px 28px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .research-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        .research-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .research-btn .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .stat-card h3 {
            color: #94a3b8;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .stat-card .value.green { color: #4ade80; }
        .stat-card .value.blue { color: #60a5fa; }
        .stat-card .value.purple { color: #a78bfa; }
        .stat-card .value.orange { color: #fb923c; }
        .stat-card .value.red { color: #f87171; }
        .stat-card .value.yellow { color: #fbbf24; }

        /* Filters */
        .filters {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            align-items: flex-end;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .filter-group select, .filter-group input[type="text"] {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            min-width: 150px;
        }

        .filter-group input[type="text"] { min-width: 240px; }

        .tier-buttons { display: flex; gap: 6px; }

        .tier-btn {
            padding: 10px 16px;
            border-radius: 8px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tier-btn:hover { border-color: #60a5fa; color: #60a5fa; }
        .tier-btn.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .tier-btn.tier-a.active { background: #22c55e; border-color: #22c55e; }
        .tier-btn.tier-b.active { background: #3b82f6; border-color: #3b82f6; }
        .tier-btn.tier-c.active { background: #f59e0b; border-color: #f59e0b; }
        .tier-btn.tier-d.active { background: #6b7280; border-color: #6b7280; }

        /* Label filter buttons */
        .label-buttons { display: flex; gap: 6px; }

        .label-btn {
            padding: 8px 14px;
            border-radius: 6px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: rgba(15, 23, 42, 0.8);
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .label-btn:hover { border-color: #60a5fa; }
        .label-btn.active { background: #6366f1; border-color: #6366f1; color: white; }

        /* Table */
        .table-container {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .table-header {
            padding: 16px 20px;
            background: rgba(15, 23, 42, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
        }

        .table-header h2 { font-size: 1.1rem; }
        .results-count { color: #94a3b8; font-size: 0.85rem; }

        .table-scroll { overflow-x: auto; max-height: 600px; overflow-y: auto; }

        table { width: 100%; border-collapse: collapse; }

        th {
            background: rgba(15, 23, 42, 0.9);
            padding: 12px 14px;
            text-align: left;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #94a3b8;
            cursor: pointer;
            position: sticky;
            top: 0;
            z-index: 10;
            font-weight: 600;
        }

        th:hover { color: #60a5fa; }
        th.sorted { color: #60a5fa; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background: rgba(96, 165, 250, 0.1); }
        th.sorted::after { content: ' ‚Üì'; }
        th.sorted.asc::after { content: ' ‚Üë'; }
        th.no-sort { cursor: default; }
        th.no-sort:hover { color: #94a3b8; }

        td {
            padding: 12px 14px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.1);
            font-size: 0.85rem;
        }

        tr:hover { background: rgba(71, 85, 105, 0.2); }

        /* Labels and badges */
        .keyword-cell {
            font-weight: 500;
            color: #f8fafc;
            max-width: 260px;
        }

        .action-cell { width: 120px; }

        .action-buttons {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            background: rgba(71, 85, 105, 0.1);
            color: #94a3b8;
            cursor: pointer;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .action-btn:hover { background: rgba(71, 85, 105, 0.3); }
        .action-btn.favorite { color: #fbbf24; border-color: rgba(251, 191, 36, 0.3); }
        .action-btn.favorite.active { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
        .action-btn.interested { color: #4ade80; border-color: rgba(74, 222, 128, 0.3); }
        .action-btn.not-interested { color: #f87171; border-color: rgba(248, 113, 113, 0.3); }
        .action-btn.maybe { color: #60a5fa; border-color: rgba(96, 165, 250, 0.3); }

        .label-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .label-none { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .label-interested { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .label-not_interested { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .label-maybe { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .label-researching { background: rgba(168, 85, 247, 0.2); color: #c084fc; }
        .label-content_created { background: rgba(20, 184, 166, 0.2); color: #2dd4bf; }

        .tier-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .tier-a { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .tier-b { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .tier-c { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.3); }
        .tier-d { background: rgba(107, 114, 128, 0.2); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); }

        .pattern-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
        }

        .pattern-distributed { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .pattern-top_heavy { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .pattern-winner_take_all { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .pattern-no_data { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        .conversion-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
        }
        .conversion-very-high { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .conversion-high { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .conversion-medium { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .conversion-low { background: rgba(239, 68, 68, 0.2); color: #f87171; }

        .trend-badge {
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            cursor: default;
        }

        .trend-rising { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .trend-stable { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .trend-declining { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .trend-unknown { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }

        .trend-cell { min-width: 90px; }

        .fetch-trend-btn {
            background: rgba(71, 85, 105, 0.2);
            border: 1px solid rgba(71, 85, 105, 0.3);
            color: #64748b;
            padding: 2px 6px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.65rem;
            transition: all 0.2s;
        }

        .fetch-trend-btn:hover { border-color: #60a5fa; color: #60a5fa; }

        .number-cell {
            font-family: 'SF Mono', Monaco, 'Courier New', monospace;
            text-align: right;
            color: #cbd5e1;
        }

        .priority-cell { display: flex; align-items: center; gap: 8px; }

        .priority-bar {
            width: 60px;
            height: 6px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 3px;
            overflow: hidden;
        }

        .priority-fill {
            height: 100%;
            border-radius: 3px;
            background: linear-gradient(90deg, #f59e0b, #22c55e);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            padding: 20px;
            background: rgba(15, 23, 42, 0.5);
        }

        .pagination button {
            padding: 8px 16px;
            background: rgba(71, 85, 105, 0.5);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .pagination button:hover:not(:disabled) {
            background: rgba(71, 85, 105, 0.8);
            border-color: #60a5fa;
        }

        .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .pagination span { color: #94a3b8; font-size: 0.85rem; }

        /* Export button */
        .export-btn {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .export-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        }

        /* Vote buttons */
        .vote-cell {
            width: 80px;
            text-align: center;
        }

        .vote-container {
            display: flex;
            align-items: center;
            gap: 2px;
            justify-content: center;
        }

        .vote-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid rgba(71, 85, 105, 0.3);
            background: rgba(71, 85, 105, 0.1);
            color: #64748b;
            cursor: pointer;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 0;
        }

        .vote-btn:hover { background: rgba(71, 85, 105, 0.3); }
        .vote-btn.upvote:hover, .vote-btn.upvote.active { color: #4ade80; border-color: rgba(74, 222, 128, 0.5); background: rgba(74, 222, 128, 0.15); }
        .vote-btn.downvote:hover, .vote-btn.downvote.active { color: #f87171; border-color: rgba(248, 113, 113, 0.5); background: rgba(248, 113, 113, 0.15); }

        .vote-score {
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }

        .vote-score.positive { color: #4ade80; }
        .vote-score.negative { color: #f87171; }
        .vote-score.neutral { color: #64748b; }

        /* Comment button in table */
        .comment-cell { width: 70px; text-align: center; }

        .comment-btn {
            background: rgba(71, 85, 105, 0.1);
            border: 1px solid rgba(71, 85, 105, 0.3);
            color: #94a3b8;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
        }

        .comment-btn:hover { border-color: #60a5fa; color: #60a5fa; background: rgba(96, 165, 250, 0.1); }
        .comment-btn.has-comments { border-color: rgba(96, 165, 250, 0.4); color: #60a5fa; background: rgba(96, 165, 250, 0.1); }

        /* Comments modal */
        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .comment-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid rgba(71, 85, 105, 0.3);
        }

        .comment-item .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .comment-item .comment-author {
            font-weight: 600;
            font-size: 0.8rem;
            color: #a78bfa;
        }

        .comment-item .comment-date {
            font-size: 0.7rem;
            color: #64748b;
        }

        .comment-item .comment-text {
            font-size: 0.85rem;
            color: #e2e8f0;
            line-height: 1.4;
        }

        .comment-item .comment-delete {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .comment-item .comment-delete:hover {
            color: #f87171;
            background: rgba(248, 113, 113, 0.1);
        }

        .comment-input-area {
            display: flex;
            gap: 8px;
        }

        .comment-input-area textarea {
            flex: 1;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            padding: 10px;
            border-radius: 8px;
            resize: vertical;
            min-height: 60px;
            font-size: 0.85rem;
            font-family: inherit;
        }

        .comment-input-area textarea:focus { outline: none; border-color: #60a5fa; }

        .add-to-library-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .add-to-library-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .add-to-library-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .add-to-library-btn.added {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
            cursor: default;
        }

        /* Research Results */
        .research-results {
            margin-top: 24px;
        }

        .result-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .result-card.seed { border-left: 4px solid #8b5cf6; }
        .result-card.related { border-left: 4px solid #3b82f6; }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .result-keyword {
            font-size: 1.1rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .result-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 16px;
        }

        .metric {
            text-align: center;
        }

        .metric-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: #60a5fa;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active { display: flex; }

        .modal {
            background: #1e293b;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h3 { margin-bottom: 16px; }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            border: none;
        }

        .modal-btn.primary { background: #3b82f6; color: white; }
        .modal-btn.secondary { background: rgba(71, 85, 105, 0.5); color: #e2e8f0; }

        /* $3K Opportunity Finder */
        .opp-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .opp-stat {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            text-align: center;
        }

        .opp-stat .opp-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .opp-stat .opp-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .feasibility-bar {
            width: 80px;
            height: 8px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 4px;
            overflow: hidden;
            display: inline-block;
            vertical-align: middle;
            margin-right: 6px;
        }

        .feasibility-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }

        .opp-lever {
            font-size: 0.7rem;
            color: #94a3b8;
            padding: 2px 6px;
            background: rgba(71, 85, 105, 0.3);
            border-radius: 4px;
            display: inline-block;
            margin: 1px;
        }

        .opp-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: border-color 0.2s;
        }

        .opp-card:hover {
            border-color: rgba(96, 165, 250, 0.3);
        }

        .opp-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .opp-card-rank {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            flex-shrink: 0;
        }

        .opp-card-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
        }

        .opp-metric {
            text-align: center;
        }

        .opp-metric-value {
            font-size: 1rem;
            font-weight: 600;
        }

        .opp-metric-label {
            font-size: 0.7rem;
            color: #64748b;
            margin-top: 2px;
        }

        .opp-progress-ring {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .opp-gap-bar {
            flex: 1;
            height: 12px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .opp-gap-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .opp-gap-target {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6rem;
            color: #94a3b8;
        }

        .opp-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .opp-filter-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            background: transparent;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s;
        }

        .opp-filter-btn:hover { border-color: #60a5fa; color: #e2e8f0; }
        .opp-filter-btn.active { background: #3b82f6; color: white; border-color: #3b82f6; }

        /* Universe Map */
        .universe-grand {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .universe-grand-stat {
            background: rgba(15, 23, 42, 0.6);
            padding: 24px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            text-align: center;
        }

        .universe-grand-stat .ug-value {
            font-size: 2.2rem;
            font-weight: 700;
        }

        .universe-grand-stat .ug-label {
            font-size: 0.75rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .niche-universe-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(148, 163, 184, 0.1);
        }

        .niche-universe-card:hover {
            border-color: rgba(96, 165, 250, 0.3);
        }

        .coverage-bar {
            height: 24px;
            background: rgba(71, 85, 105, 0.5);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }

        .coverage-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: 600;
            min-width: 40px;
        }

        .category-bar-container {
            display: grid;
            grid-template-columns: 120px 1fr 60px;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .cat-bar {
            height: 14px;
            background: rgba(71, 85, 105, 0.4);
            border-radius: 3px;
            overflow: hidden;
        }

        .cat-bar-fill {
            height: 100%;
            border-radius: 3px;
        }

        .gap-keyword-chip {
            display: inline-block;
            font-size: 0.7rem;
            padding: 3px 8px;
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #fbbf24;
            border-radius: 4px;
            margin: 2px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .gap-keyword-chip:hover {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }

        /* Smart Picks */
        .smart-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            transition: border-color 0.2s, transform 0.1s;
        }

        .smart-card:hover {
            border-color: rgba(139, 92, 246, 0.4);
            transform: translateY(-1px);
        }

        .smart-rank {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .smart-difficulty {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .smart-difficulty.easy { background: rgba(74,222,128,0.15); color: #4ade80; }
        .smart-difficulty.medium { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .smart-difficulty.hard { background: rgba(248,113,113,0.15); color: #f87171; }
        .smart-difficulty.unknown { background: rgba(148,163,184,0.15); color: #94a3b8; }

        .smart-money {
            font-size: 1.1rem;
            letter-spacing: -1px;
        }

        .smart-reason {
            font-size: 0.8rem;
            color: #94a3b8;
            padding: 3px 0;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .smart-reason::before {
            content: '‚úì';
            color: #4ade80;
            font-size: 0.7rem;
        }

        .smart-video-title {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(139, 92, 246, 0.2);
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 0.85rem;
            color: #e2e8f0;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .smart-video-title:hover {
            border-color: rgba(139, 92, 246, 0.5);
        }

        .smart-score-ring {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        /* Content Gap Analysis */
        .cg-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .cg-stat {
            background: rgba(15, 23, 42, 0.6);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.1);
            text-align: center;
        }
        .cg-stat .cg-value { font-size: 1.8rem; font-weight: 700; }
        .cg-stat .cg-label { font-size: 0.75rem; color: #94a3b8; text-transform: uppercase; margin-top: 4px; }
        .cg-comp-card {
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(71, 85, 105, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .cg-comp-card:hover { border-color: rgba(139, 92, 246, 0.5); }
        .cg-comp-card.selected { border-color: #ec4899; background: rgba(236, 72, 153, 0.1); }
        .cg-rank-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .cg-rank-badge.top3 { background: rgba(74,222,128,0.15); color: #4ade80; }
        .cg-rank-badge.top5 { background: rgba(96,165,250,0.15); color: #60a5fa; }
        .cg-rank-badge.top10 { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .cg-rank-badge.none { background: rgba(248,113,113,0.1); color: #f87171; }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 { font-size: 1.8rem; }
            .research-form { flex-direction: column; }
            .form-group input, .form-group select { min-width: 100%; }
            .filters { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header style="position:relative;">
            <h1>üî¨ Keyword Research Command Center</h1>
            <p>Research, analyze, and prioritize affiliate keywords with real data</p>

            <!-- User Info (when logged in) -->
            {% if user %}
            <div style="position:absolute;top:0;right:0;display:flex;align-items:center;gap:12px;background:rgba(30,41,59,0.8);padding:8px 16px;border-radius:12px;border:1px solid rgba(71,85,105,0.5);">
                {% if user.picture %}
                <img src="{{ user.picture }}" alt="Profile" style="width:32px;height:32px;border-radius:50%;">
                {% endif %}
                <div style="text-align:right;">
                    <div style="font-size:0.85rem;color:#e2e8f0;">{{ user.name or user.email }}</div>
                    <div style="font-size:0.7rem;color:#64748b;">{{ user.email }}</div>
                </div>
                <a href="/logout" style="background:rgba(239,68,68,0.2);color:#f87171;padding:6px 12px;border-radius:6px;text-decoration:none;font-size:0.75rem;border:1px solid rgba(239,68,68,0.3);">Logout</a>
            </div>
            {% endif %}
        </header>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" data-tab="smart">üöÄ Smart Picks</button>
            <button class="tab" data-tab="research">üîç Research</button>
            <button class="tab" data-tab="library">üìö Keyword Library</button>
            <button class="tab" data-tab="domination">üëë Domination Score</button>
            <button class="tab" data-tab="planner">üìù Content Planner</button>
            <button class="tab" data-tab="analytics">üìä Analytics</button>
            <button class="tab" data-tab="opportunity">üí∞ $3K Finder</button>
            <button class="tab" data-tab="universe">üåê Universe Map</button>
            <button class="tab" data-tab="contentgap">üîç Content Gap</button>
        </div>

        <!-- Smart Picks Tab (default) -->
        <div class="tab-content active" id="smart-tab">
            <div class="research-box" style="text-align:center;padding:24px;background:linear-gradient(135deg, rgba(99,102,241,0.15), rgba(139,92,246,0.15));border-color:rgba(139,92,246,0.3);">
                <h2 style="margin-bottom:8px;">üöÄ What should I make a video about?</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">Pick a niche and we'll tell you the best keywords to target ‚Äî ranked by how easy they are to rank for and how much money they can make.</p>
                <div style="display:flex;gap:12px;justify-content:center;align-items:center;flex-wrap:wrap;">
                    <select id="smart-niche-filter" style="padding:10px 16px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:8px;font-size:0.9rem;min-width:200px;">
                        <option value="">All Niches</option>
                        <option value="vpn">VPN</option>
                        <option value="home_security">Home Security</option>
                        <option value="web_hosting">Web Hosting</option>
                        <option value="identity_theft">Identity Theft</option>
                        <option value="data_broker_removal">Data Broker Removal</option>
                        <option value="parental_control">Parental Control</option>
                        <option value="email_marketing">Email Marketing</option>
                        <option value="antivirus">Antivirus</option>
                        <option value="pet_insurance">Pet Insurance</option>
                        <option value="gps_dog_fence">GPS Dog Fence</option>
                        <option value="credit_repair">Credit Repair</option>
                    </select>
                    <button class="research-btn" id="smart-load-btn" onclick="loadSmartPicks()" style="background:linear-gradient(135deg, #8b5cf6, #6366f1);padding:10px 24px;">
                        <span id="smart-btn-text">Show Me the Best Keywords</span>
                        <div class="spinner" id="smart-spinner" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <!-- Niche Overview -->
            <div id="smart-niche-overview" style="display:none;margin-top:20px;">
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:12px;margin-bottom:20px;" id="smart-niche-cards"></div>
            </div>

            <!-- Results Header -->
            <div id="smart-results-header" style="display:none;margin-top:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3 id="smart-results-title" style="color:#e2e8f0;">Top Picks</h3>
                    <div style="display:flex;gap:8px;align-items:center;">
                        <span style="color:#64748b;font-size:0.8rem;" id="smart-results-count"></span>
                        <select id="smart-sort" onchange="sortSmartPicks(this.value)" style="padding:6px 12px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:6px;font-size:0.8rem;">
                            <option value="smartScore">Best Overall</option>
                            <option value="revenue">Highest Revenue</option>
                            <option value="easy">Easiest to Rank</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Pick Cards -->
            <div id="smart-picks-container"></div>

            <!-- Show More -->
            <div id="smart-show-more" style="text-align:center;padding:20px;display:none;">
                <button class="research-btn" onclick="showMoreSmartPicks()" style="background:rgba(71,85,105,0.5);padding:10px 30px;">
                    Show More Keywords
                </button>
            </div>
        </div>

        <!-- Research Tab -->
        <div class="tab-content" id="research-tab">
            <!-- Seed Keyword Research -->
            <div class="research-box">
                <h2>üéØ Research New Keywords</h2>
                <div class="research-form">
                    <div class="form-group">
                        <label>Seed Keyword</label>
                        <input type="text" id="seed-keyword" placeholder="e.g., best vpn for streaming">
                    </div>
                    <div class="form-group">
                        <label>Niche</label>
                        <select id="research-niche">
                            <option value="general">General</option>
                            <option value="vpn">VPN</option>
                            <option value="web_hosting">Web Hosting</option>
                            <option value="antivirus">Antivirus</option>
                            <option value="identity_theft">Identity Theft</option>
                            <option value="data_broker_removal">Data Broker Removal</option>
                            <option value="parental_control">Parental Control</option>
                            <option value="email_marketing">Email Marketing</option>
                            <option value="home_security">Home Security</option>
                            <option value="pet_tech">Pet Tech</option>
                        </select>
                    </div>
                    <button class="research-btn" id="research-btn" onclick="researchKeyword()">
                        <span id="research-btn-text">üöÄ Research Keyword</span>
                        <div class="spinner" id="research-spinner" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <!-- Trending Gaps Discovery -->
            <div class="research-box" style="margin-top:20px;">
                <h2>üìà Trending Topics Not Covered</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Discover rising search topics from Google Trends that aren't in your keyword library yet. Uses your silo primary keywords as seeds.
                </p>
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;">
                    <select id="trending-silo-filter" style="padding:8px 12px;background:#1e293b;border:1px solid #334155;border-radius:8px;color:#e2e8f0;font-size:0.9rem;">
                        <option value="all">All Silos</option>
                        <option value="id_theft">ID Theft</option>
                        <option value="dog">Dog/Pet Tech</option>
                        <option value="data_broker">Data Broker</option>
                        <option value="parental_control">Parental Control</option>
                    </select>
                    <button class="research-btn" id="trending-btn" onclick="discoverTrendingGaps()" style="padding:10px 24px;">
                        <span id="trending-btn-text">üî• Discover Trending Gaps</span>
                        <div class="spinner" id="trending-spinner" style="display:none;"></div>
                    </button>
                </div>
                <div id="trending-results" style="margin-top:20px;"></div>
            </div>

            <!-- Channel Keyword Analysis -->
            <div class="research-box" style="margin-top:20px;">
                <h2>üì∫ Channel Keyword Analysis</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Analyze a YouTube channel to see keyword publishing patterns, republish frequency, and content strategy.
                </p>
                <div class="research-form">
                    <div class="form-group">
                        <label>Channel Name or Handle</label>
                        <input type="text" id="channel-input" placeholder="e.g., @consumerresearchstudios or channel name">
                    </div>
                    <button class="research-btn" id="channel-btn" onclick="analyzeChannel()" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);">
                        <span id="channel-btn-text">üì∫ Analyze Channel</span>
                        <div class="spinner" id="channel-spinner" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <!-- Channel Analysis Results -->
            <div id="channel-results" style="display:none;">
                <!-- Channel Stats -->
                <div class="research-box" id="channel-stats-box">
                    <h3>üìä Channel Publishing Stats</h3>
                    <div id="channel-stats" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;margin-top:16px;"></div>
                </div>

                <!-- Top Keywords -->
                <div class="research-box">
                    <h3>üéØ Most Frequently Used Keywords</h3>
                    <p style="color:#64748b;font-size:0.85rem;margin-bottom:16px;">
                        Keywords that appear in 2+ video titles, sorted by frequency.
                    </p>
                    <div style="margin-bottom:16px;display:flex;gap:12px;align-items:center;">
                        <button onclick="addSelectedToLibrary()" class="research-btn" style="padding:8px 16px;font-size:0.85rem;background:linear-gradient(135deg, #4ade80, #22c55e);">
                            ‚ûï Add Selected to Library
                        </button>
                        <button onclick="addAllToLibrary()" class="research-btn" style="padding:8px 16px;font-size:0.85rem;background:linear-gradient(135deg, #60a5fa, #3b82f6);">
                            üìö Add All to Library
                        </button>
                        <span id="add-to-library-status" style="color:#94a3b8;font-size:0.85rem;"></span>
                    </div>
                    <div style="overflow-x:auto;">
                        <table id="channel-keywords-table">
                            <thead>
                                <tr>
                                    <th style="width:40px;"><input type="checkbox" id="select-all-keywords" onchange="toggleAllKeywords(this)"></th>
                                    <th class="sortable" data-sort="keyword" onclick="sortChannelTable('keyword')">Keyword ‚áÖ</th>
                                    <th class="sortable" data-sort="niche" onclick="sortChannelTable('niche')">Niche ‚áÖ</th>
                                    <th class="sortable" data-sort="keyword_type" onclick="sortChannelTable('keyword_type')">Type ‚áÖ</th>
                                    <th class="sortable" data-sort="count" onclick="sortChannelTable('count')">Videos ‚áÖ</th>
                                    <th class="sortable" data-sort="recent_count" onclick="sortChannelTable('recent_count')">12mo ‚áÖ</th>
                                    <th class="sortable" data-sort="view_pattern" onclick="sortChannelTable('view_pattern')">View Dist. ‚áÖ</th>
                                    <th class="sortable" data-sort="conversion_immediacy" onclick="sortChannelTable('conversion_immediacy')">Conv. ‚áÖ</th>
                                    <th class="sortable" data-sort="willingness_to_spend" onclick="sortChannelTable('willingness_to_spend')">Will Pay ‚áÖ</th>
                                    <th class="sortable" data-sort="revenue_potential" onclick="sortChannelTable('revenue_potential')">Est. Rev ‚áÖ</th>
                                    <th class="sortable" data-sort="avg_views" onclick="sortChannelTable('avg_views')">Avg Views ‚áÖ</th>
                                    <th class="sortable" data-sort="republish_interval_days" onclick="sortChannelTable('republish_interval_days')">Interval ‚áÖ</th>
                                </tr>
                            </thead>
                            <tbody id="channel-keywords-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Hot Keywords (Republished in Last 12 Months) -->
                <div class="research-box" id="hot-keywords-box">
                    <h3>üî• Hot Keywords <span style="font-size:0.8rem;color:#f97316;">(Republished 2+ times in last 12 months)</span></h3>
                    <p style="color:#64748b;font-size:0.85rem;margin-bottom:16px;">
                        Keywords the channel is actively updating - indicates high-priority topics.
                    </p>
                    <div id="hot-keywords-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;"></div>
                </div>

                <!-- Republish Analysis -->
                <div class="research-box">
                    <h3>üîÑ Republish Strategy Analysis</h3>
                    <p style="color:#64748b;font-size:0.85rem;margin-bottom:16px;">
                        Keywords with the shortest republish intervals (most frequently updated topics).
                    </p>
                    <div id="republish-analysis" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:16px;"></div>
                </div>

                <!-- All Videos -->
                <div class="research-box">
                    <h3>üìπ Channel Videos</h3>
                    <p style="color:#64748b;font-size:0.85rem;margin-bottom:16px;">
                        Videos found from this channel (sorted by date).
                    </p>
                    <div style="overflow-x:auto;">
                        <table id="channel-videos-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Views</th>
                                    <th>Published</th>
                                </tr>
                            </thead>
                            <tbody id="channel-videos-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="research-results" id="research-results"></div>
        </div>

        <!-- Library Tab -->
        <div class="tab-content" id="library-tab">
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Keywords</h3>
                    <div class="value blue" id="stat-total">-</div>
                </div>
                <div class="stat-card">
                    <h3>Revenue Potential</h3>
                    <div class="value green" id="stat-revenue">-</div>
                </div>
                <div class="stat-card">
                    <h3>A-Tier</h3>
                    <div class="value purple" id="stat-atier">-</div>
                </div>
                <div class="stat-card">
                    <h3>Favorites</h3>
                    <div class="value yellow" id="stat-favorites">0</div>
                </div>
                <div class="stat-card">
                    <h3>Interested</h3>
                    <div class="value green" id="stat-interested">0</div>
                </div>
                <div class="stat-card">
                    <h3>Not Interested</h3>
                    <div class="value red" id="stat-notinterested">0</div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label>Search</label>
                    <input type="text" id="search" placeholder="Type to search...">
                </div>
                <div class="filter-group">
                    <label>Niche</label>
                    <select id="niche-filter">
                        <option value="">All Niches</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tier</label>
                    <div class="tier-buttons">
                        <button class="tier-btn active" data-tier="">All</button>
                        <button class="tier-btn tier-a" data-tier="A - Top Priority">A</button>
                        <button class="tier-btn tier-b" data-tier="B - High Value">B</button>
                        <button class="tier-btn tier-c" data-tier="C - Growth">C</button>
                        <button class="tier-btn tier-d" data-tier="D - Nurture">D</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Label</label>
                    <div class="label-buttons">
                        <button class="label-btn active" data-label="">All</button>
                        <button class="label-btn" data-label="interested">‚úì Interested</button>
                        <button class="label-btn" data-label="maybe">? Maybe</button>
                        <button class="label-btn" data-label="not_interested">‚úó Not Int.</button>
                        <button class="label-btn" data-label="favorite">‚≠ê Favorites</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label>Source</label>
                    <select id="source-filter" onchange="applyFilters()">
                        <option value="">All Sources</option>
                    </select>
                </div>
                <div class="filter-group" style="margin-left: auto;">
                    <label>&nbsp;</label>
                    <div style="display:flex;gap:8px;">
                        <button class="export-btn" onclick="collectTrendsData()" id="collect-trends-btn" style="background:linear-gradient(135deg, #10b981, #059669);font-size:0.8rem;padding:8px 14px;">
                            üìà Collect Trends
                        </button>
                        <button class="export-btn" onclick="exportFiltered()">‚Üì Export CSV</button>
                    </div>
                </div>
                <div id="trends-status" style="display:none;padding:4px 0;font-size:0.75rem;color:#94a3b8;width:100%;text-align:right;"></div>
            </div>

            <div class="table-container">
                <div class="table-header" style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                    <h2 style="margin:0;">Keyword Library</h2>
                    <button onclick="showAddKeywordModal()" style="background:#3b82f6;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">+ Add Keywords</button>
                    <button onclick="refreshKeywordsFromDB()" id="refresh-kw-btn" style="background:#10b981;color:white;border:none;padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;font-weight:600;">Refresh from DB</button>
                    <span class="results-count" id="results-count" style="margin-left:auto;">Loading...</span>
                </div>

                <!-- Add Keyword Modal -->
                <div id="add-keyword-modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:1000;align-items:center;justify-content:center;">
                    <div style="background:#1e293b;border-radius:12px;padding:24px;max-width:500px;width:90%;border:1px solid #334155;">
                        <h3 style="color:#f1f5f9;margin-top:0;">Add Keywords to Library</h3>
                        <p style="color:#94a3b8;font-size:0.85rem;">Enter keywords separated by commas or newlines. They'll be added to the shared library for the whole team.</p>
                        <textarea id="add-kw-input" placeholder="keyword 1, keyword 2&#10;keyword 3" style="width:100%;height:100px;background:#0f172a;color:#f1f5f9;border:1px solid #334155;border-radius:8px;padding:10px;font-size:0.9rem;resize:vertical;box-sizing:border-box;"></textarea>
                        <div style="margin-top:10px;">
                            <label style="color:#94a3b8;font-size:0.8rem;">Niche:</label>
                            <select id="add-kw-niche" style="background:#0f172a;color:#f1f5f9;border:1px solid #334155;border-radius:6px;padding:4px 8px;font-size:0.85rem;margin-left:6px;">
                                <option value="general">General</option>
                                <option value="vpn">VPN</option>
                                <option value="identity_theft">Identity Theft</option>
                                <option value="data_broker_removal">Data Broker Removal</option>
                                <option value="antivirus">Antivirus</option>
                                <option value="home_security">Home Security</option>
                                <option value="web_hosting">Web Hosting</option>
                                <option value="email_marketing">Email Marketing</option>
                                <option value="parental_control">Parental Control</option>
                                <option value="pet_tech">Pet Tech</option>
                                <option value="credit_repair">Credit Repair</option>
                            </select>
                        </div>
                        <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end;">
                            <button onclick="hideAddKeywordModal()" style="background:#334155;color:#f1f5f9;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">Cancel</button>
                            <button onclick="submitNewKeywords()" id="add-kw-submit" style="background:#3b82f6;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-weight:600;">Add Keywords</button>
                        </div>
                        <div id="add-kw-result" style="margin-top:12px;display:none;"></div>
                    </div>
                </div>
                <div class="table-scroll">
                    <table id="keywords-table">
                        <thead>
                            <tr>
                                <th class="no-sort">Actions</th>
                                <th data-sort="keyword">Keyword</th>
                                <th data-sort="voteScore">Votes</th>
                                <th class="no-sort">Comments</th>
                                <th data-sort="label">Label</th>
                                <th data-sort="tier">Tier</th>
                                <th data-sort="priority">Priority</th>
                                <th data-sort="niche">Niche</th>
                                <th data-sort="revenue">Revenue</th>
                                <th data-sort="conversionLikelihood">Conversion</th>
                                <th data-sort="willingness">Will Pay</th>
                                <th data-sort="idealBrand">Ideal Brand</th>
                                <th data-sort="timeToConvert">Time to Convert</th>
                                <th data-sort="ytViews">YT Views</th>
                                <th data-sort="ytPattern">Pattern</th>
                                <th data-sort="volume">Volume</th>
                                <th data-sort="trendInterest">Trend</th>
                                <th data-sort="source">Source</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <tr><td colspan="18" style="text-align:center;padding:40px;color:#94a3b8;">Loading keywords...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination">
                    <button id="prev-btn" onclick="prevPage()">‚Üê Previous</button>
                    <span id="page-info">Page 1 of 1</span>
                    <button id="next-btn" onclick="nextPage()">Next ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Domination Score Tab -->
        <div class="tab-content" id="domination-tab">
            <div class="research-box">
                <h2>üëë YouTube SERP Domination Score</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Track how many positions you own in the top 5 for your priority keywords.
                    Domination formula: Position 1 = 50%, Position 2 = 25%, Position 3 = 15%, Position 4 & 5 = 5% each.
                </p>

                <div style="display:flex;gap:12px;margin-bottom:12px;">
                    <button class="research-btn" onclick="loadDominationData()" id="load-domination-btn">
                        <span id="domination-btn-text">üìä Load Ranking Data</span>
                        <div class="spinner" id="domination-spinner" style="display:none;"></div>
                    </button>
                    <button class="research-btn" onclick="refreshDominationScore()" id="refresh-domination-btn" style="background:linear-gradient(135deg, #10b981, #059669);">
                        <span id="refresh-domination-text">üîÑ Refresh Domination Score</span>
                        <div class="spinner" id="refresh-domination-spinner" style="display:none;"></div>
                    </button>
                    <button class="research-btn" onclick="showImportModal()" style="background:linear-gradient(135deg, #f59e0b, #ef4444);">
                        üì• Import Results JSON
                    </button>
                    <button class="research-btn" onclick="openKeywordManager()" style="background:linear-gradient(135deg, #8b5cf6, #6d28d9);">
                        <span id="manage-kw-btn-text">Manage Keywords</span>
                        <div class="spinner" id="manage-kw-spinner" style="display:none;"></div>
                    </button>
                </div>
                <div id="keyword-source-banner" style="display:none;padding:8px 16px;border-radius:8px;margin-bottom:8px;font-size:0.8rem;background:#1e293b;border:1px solid #334155;color:#94a3b8;"></div>
                <div id="data-freshness-banner" style="display:none;padding:10px 16px;border-radius:8px;margin-bottom:20px;font-size:0.8rem;display:flex;align-items:center;gap:8px;"></div>
            </div>

            <!-- Silo Filter Tabs -->
            <div id="dom-silo-filters" style="display:none;margin-bottom:16px;">
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <button class="tab active" data-silo="all" onclick="filterDomBySilo('all',this)">All</button>
                    <button class="tab" data-silo="id_theft" onclick="filterDomBySilo('id_theft',this)">ID Theft</button>
                    <button class="tab" data-silo="dog" onclick="filterDomBySilo('dog',this)">Dog</button>
                    <button class="tab" data-silo="data_broker" onclick="filterDomBySilo('data_broker',this)">Data Broker</button>
                    <button class="tab" data-silo="parental_control" onclick="filterDomBySilo('parental_control',this)">Parental Control</button>
                </div>
            </div>

            <!-- Domination Summary Stats -->
            <div class="stats-grid" id="domination-stats" style="display:none;">
                <div class="stat-card">
                    <h3>Keywords Tracked</h3>
                    <div class="value blue" id="dom-total-keywords">0</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Domination</h3>
                    <div class="value green" id="dom-avg-score">0%</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Target</h3>
                    <div class="value purple" id="dom-avg-target">100%</div>
                </div>
                <div class="stat-card">
                    <h3>Avg Gap</h3>
                    <div class="value orange" id="dom-avg-gap">0%</div>
                </div>
                <div class="stat-card">
                    <h3>At Target</h3>
                    <div class="value green" id="dom-at-target">0</div>
                </div>
                <div class="stat-card">
                    <h3>CM Rev</h3>
                    <div class="value yellow" id="dom-total-revenue">$0</div>
                </div>
                <div class="stat-card">
                    <h3>Left on Table</h3>
                    <div class="value red" id="dom-left-on-table">$0</div>
                </div>
                <div class="stat-card">
                    <h3>No Presence (0%)</h3>
                    <div class="value red" id="dom-no-presence">0</div>
                </div>
            </div>

            <!-- Summary Table (Primary Keywords Only ‚Äî with positions) -->
            <div class="table-container" id="dom-summary-container" style="display:none;">
                <div class="table-header">
                    <h2>Priority Keywords Overview</h2>
                    <span class="results-count" id="dom-summary-count">0 keywords</span>
                </div>
                <div class="table-scroll" style="max-height:600px;">
                    <table id="dom-summary-table">
                        <thead>
                            <tr>
                                <th data-sort="keyword">Keyword</th>
                                <th data-sort="silo">Silo</th>
                                <th data-sort="revenue">CM_Rev</th>
                                <th data-sort="domination" class="sorted">Dom Score</th>
                                <th data-sort="target">Target</th>
                                <th data-sort="gap">Gap</th>
                                <th>Pos 1 (50%)</th>
                                <th>Pos 2 (25%)</th>
                                <th>Pos 3 (15%)</th>
                                <th>Pos 4 (5%)</th>
                                <th>Pos 5 (5%)</th>
                                <th>Your Channels</th>
                            </tr>
                        </thead>
                        <tbody id="dom-summary-body">
                            <tr><td colspan="12" style="text-align:center;padding:40px;color:#94a3b8;">No ranking data loaded. Click "Load Ranking Data" or import results.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Detail Table (Groups + Secondaries + Positions) -->
            <div class="table-container" id="dom-detail-container" style="display:none;margin-top:20px;">
                <div class="table-header">
                    <h2>Detailed SERP Positions</h2>
                    <span class="results-count" id="dom-detail-count">0 keywords</span>
                </div>
                <div class="table-scroll" style="max-height:700px;">
                    <table id="dom-detail-table">
                        <thead>
                            <tr>
                                <th data-sort="keyword">Keyword</th>
                                <th data-sort="silo">Silo</th>
                                <th data-sort="domination" class="sorted">Dom Score</th>
                                <th>Pos 1 (50%)</th>
                                <th>Pos 2 (25%)</th>
                                <th>Pos 3 (15%)</th>
                                <th>Pos 4 (5%)</th>
                                <th>Pos 5 (5%)</th>
                                <th>Your Channels</th>
                            </tr>
                        </thead>
                        <tbody id="dom-detail-body">
                            <tr><td colspan="9" style="text-align:center;padding:40px;color:#94a3b8;">No ranking data loaded.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Empty State -->
            <div id="domination-empty-state" class="research-box" style="text-align:center;padding:40px;">
                <h3 style="color:#94a3b8;margin-bottom:16px;">No Ranking Data Available</h3>
                <p style="color:#64748b;margin-bottom:24px;">
                    Run the <code>check_rankings.py</code> script locally to check your channel rankings,
                    then import the results JSON here.
                </p>
                <div style="background:rgba(15,23,42,0.6);padding:20px;border-radius:12px;text-align:left;max-width:600px;margin:0 auto;">
                    <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:12px;"><strong>Quick Start:</strong></p>
                    <code style="display:block;background:#0f172a;padding:12px;border-radius:8px;color:#4ade80;font-size:0.8rem;">
                        cd keyword-dashboard<br>
                        python check_rankings.py
                    </code>
                    <p style="color:#64748b;font-size:0.8rem;margin-top:12px;">
                        This will generate <code>ranking_results.json</code> which you can import above.
                    </p>
                </div>
            </div>
        </div>

        <!-- Import Modal -->
        <div class="modal-overlay" id="import-modal">
            <div class="modal" style="max-width:600px;">
                <h3>üì• Import Ranking Results</h3>
                <p style="color:#94a3b8;margin-bottom:16px;font-size:0.9rem;">
                    Paste the contents of your <code>ranking_results.json</code> file below:
                </p>
                <textarea id="import-json" style="width:100%;height:300px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;padding:12px;border-radius:8px;resize:vertical;font-family:monospace;font-size:0.8rem;" placeholder='{"timestamp": "...", "ranking": [...], "not_ranking": [...], "all_results": [...]}'></textarea>
                <div class="modal-buttons">
                    <button class="modal-btn secondary" onclick="closeImportModal()">Cancel</button>
                    <button class="modal-btn primary" onclick="importRankingData()">Import Data</button>
                </div>
            </div>
        </div>

        <!-- History Modal -->
        <div class="modal-overlay" id="history-modal">
            <div class="modal" style="max-width:800px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h3 id="history-modal-title">üìà Domination History</h3>
                    <button onclick="closeHistoryModal()" style="background:none;border:none;color:#94a3b8;font-size:1.5rem;cursor:pointer;">&times;</button>
                </div>
                <div id="history-chart-container" style="height:300px;margin-bottom:20px;">
                    <canvas id="history-chart"></canvas>
                </div>
                <div id="history-table-container" style="max-height:200px;overflow-y:auto;">
                    <table style="width:100%;border-collapse:collapse;font-size:0.85rem;">
                        <thead>
                            <tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                                <th style="text-align:left;padding:8px;color:#94a3b8;">Date</th>
                                <th style="text-align:right;padding:8px;color:#94a3b8;">Dom Score</th>
                                <th style="text-align:right;padding:8px;color:#94a3b8;">Daily Rev</th>
                                <th style="text-align:left;padding:8px;color:#94a3b8;">Positions Owned</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Keyword Manager Modal -->
        <div class="modal-overlay" id="keyword-manager-modal">
            <div class="modal" style="max-width:1000px;width:95%;max-height:90vh;display:flex;flex-direction:column;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                    <h3>Keyword Manager</h3>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span id="km-active-count" style="color:#10b981;font-size:0.85rem;font-weight:600;"></span>
                        <button onclick="closeKeywordManager()" style="background:none;border:none;color:#94a3b8;font-size:1.5rem;cursor:pointer;">&times;</button>
                    </div>
                </div>

                <!-- Search / Add + Filters -->
                <div style="display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;align-items:center;">
                    <div style="flex:1;min-width:200px;position:relative;">
                        <input type="text" id="km-search" placeholder="Search or add custom keyword..." oninput="kmSearchInput()" onkeydown="if(event.key==='Enter')kmSearchEnter()" style="width:100%;padding:8px 12px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:6px;font-size:0.85rem;box-sizing:border-box;">
                        <button id="km-add-btn" onclick="showAddKeywordForm()" style="display:none;position:absolute;right:4px;top:50%;transform:translateY(-50%);padding:4px 10px;background:#8b5cf6;color:white;border:none;border-radius:4px;font-size:0.75rem;cursor:pointer;">+ Add</button>
                    </div>
                    <select id="km-status-filter" onchange="filterKmKeywords()" style="padding:8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:6px;font-size:0.85rem;">
                        <option value="all">All Keywords</option>
                        <option value="active">Active Only</option>
                        <option value="inactive">Inactive Only</option>
                        <option value="bq">In BigQuery</option>
                    </select>
                    <select id="km-tier-filter" onchange="filterKmKeywords()" style="padding:8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:6px;font-size:0.85rem;">
                        <option value="">All Tiers</option>
                        <option value="A">A - Top Priority</option>
                        <option value="B">B - High Value</option>
                        <option value="C">C - Medium</option>
                        <option value="D">D - Lower</option>
                        <option value="custom">Custom</option>
                    </select>
                    <select id="km-niche-filter" onchange="filterKmKeywords()" style="padding:8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:6px;font-size:0.85rem;">
                        <option value="">All Niches</option>
                    </select>
                    <button id="km-save-btn" onclick="saveKmChanges()" style="padding:6px 16px;background:#6b7280;color:white;border:none;border-radius:6px;font-size:0.8rem;cursor:pointer;opacity:0.5;pointer-events:none;" disabled>Save Changes</button>
                    <span id="km-pending-count" style="color:#94a3b8;font-size:0.75rem;"></span>
                </div>
                <!-- Add Keyword Form (shown when adding new keyword) -->
                <div id="km-add-form" style="display:none;margin-bottom:8px;padding:10px 12px;background:rgba(139,92,246,0.08);border:1px solid rgba(139,92,246,0.3);border-radius:8px;">
                    <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px;">
                        <span style="color:#c4b5fd;font-size:0.8rem;font-weight:600;">Add keyword:</span>
                        <span id="km-add-kw-label" style="color:#e2e8f0;font-size:0.85rem;"></span>
                    </div>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                        <select id="km-add-role" onchange="kmAddRoleChanged()" style="padding:6px 8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.8rem;">
                            <option value="none">No role</option>
                            <option value="primary">Primary keyword</option>
                            <option value="secondary">Secondary keyword</option>
                        </select>
                        <select id="km-add-silo" style="padding:6px 8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.8rem;">
                            <option value="">Select silo...</option>
                            <option value="id_theft">ID Theft</option>
                            <option value="dog">Dog</option>
                            <option value="data_broker">Data Broker</option>
                            <option value="parental_control">Parental Control</option>
                            <option value="new">New / Other</option>
                        </select>
                        <select id="km-add-parent" style="display:none;padding:6px 8px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.8rem;max-width:250px;">
                            <option value="">Select primary keyword...</option>
                        </select>
                        <span id="km-add-auto-info" style="color:#94a3b8;font-size:0.75rem;"></span>
                        <div style="margin-left:auto;display:flex;gap:6px;">
                            <button onclick="addCustomKeyword()" style="padding:5px 14px;background:#8b5cf6;color:white;border:none;border-radius:4px;font-size:0.8rem;cursor:pointer;">Add Keyword</button>
                            <button onclick="hideAddKeywordForm()" style="padding:5px 10px;background:transparent;color:#94a3b8;border:1px solid rgba(71,85,105,0.5);border-radius:4px;font-size:0.8rem;cursor:pointer;">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Keyword Table -->
                <div style="flex:1;overflow-y:auto;border:1px solid rgba(71,85,105,0.3);border-radius:8px;">
                    <table style="width:100%;border-collapse:collapse;font-size:0.82rem;" id="km-table">
                        <thead style="position:sticky;top:0;background:#1e293b;z-index:1;">
                            <tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                                <th style="text-align:center;padding:8px;color:#94a3b8;width:35px;">#</th>
                                <th id="km-th-is_active" style="text-align:center;padding:8px;color:#94a3b8;width:50px;cursor:pointer;user-select:none;" onclick="sortKmTable('is_active')">Active <span style="font-size:0.7rem;">&#9660;</span></th>
                                <th id="km-th-keyword" style="text-align:left;padding:8px;color:#94a3b8;cursor:pointer;user-select:none;" onclick="sortKmTable('keyword')">Keyword</th>
                                <th id="km-th-tier" style="text-align:center;padding:8px;color:#94a3b8;width:60px;cursor:pointer;user-select:none;" onclick="sortKmTable('tier')" title="Opportunity Tier: A = Top Priority, B = High Potential, C = Medium, D = Low Priority, Custom = User-added">Tier</th>
                                <th id="km-th-niche" style="text-align:left;padding:8px;color:#94a3b8;width:120px;cursor:pointer;user-select:none;" onclick="sortKmTable('niche')">Niche</th>
                                <th id="km-th-priority_score" style="text-align:right;padding:8px;color:#94a3b8;width:70px;cursor:pointer;user-select:none;" onclick="sortKmTable('priority_score')" title="Priority Score: Higher = better opportunity based on volume, competition, and revenue potential">Score</th>
                                <th id="km-th-search_volume" style="text-align:right;padding:8px;color:#94a3b8;width:80px;cursor:pointer;user-select:none;" onclick="sortKmTable('search_volume')">Volume</th>
                                <th id="km-th-source" style="text-align:center;padding:8px;color:#94a3b8;width:60px;cursor:pointer;user-select:none;" onclick="sortKmTable('source')" title="Source: TRK = Tracking list, CSV = Imported from CSV, BQ = Added from BigQuery, USR = Custom user-added">Source</th>
                                <th id="km-th-in_bigquery" style="text-align:center;padding:8px;color:#94a3b8;width:50px;cursor:pointer;user-select:none;" onclick="sortKmTable('in_bigquery')" title="Has historical SERP data in BigQuery ‚Äî keywords with data will show results immediately in audits">Data</th>
                            </tr>
                        </thead>
                        <tbody id="km-table-body"></tbody>
                    </table>
                </div>

                <!-- Footer -->
                <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid #334155;">
                    <span id="km-showing-count" style="color:#94a3b8;font-size:0.8rem;"></span>
                    <span id="km-status" style="color:#94a3b8;font-size:0.8rem;"></span>
                </div>
            </div>
        </div>

        <!-- Content Planner Tab -->
        <div class="tab-content" id="planner-tab">
            <div class="research-box">
                <h2>üìù Content Planner</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Strategic video planning based on domination scores. Focus on keywords where you can capture more revenue.
                </p>

                <!-- Videos Calculation Rationale (always visible at top) -->
                <div style="background:rgba(30,41,59,0.5);padding:16px;border-radius:12px;border:1px solid rgba(71,85,105,0.5);margin-bottom:20px;">
                    <h4 style="color:#a78bfa;margin-bottom:12px;">üìê How Videos Needed is Calculated</h4>
                    <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                            <th style="padding:6px 8px;text-align:left;color:#94a3b8;">Dom Score</th>
                            <th style="padding:6px 8px;text-align:center;color:#94a3b8;">Videos</th>
                            <th style="padding:6px 8px;text-align:left;color:#94a3b8;">Rationale</th>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                            <td style="padding:6px 8px;color:#4ade80;font-weight:600;">100%</td>
                            <td style="padding:6px 8px;text-align:center;color:#e2e8f0;">1-2</td>
                            <td style="padding:6px 8px;color:#94a3b8;">Reserve videos to maintain dominance</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                            <td style="padding:6px 8px;color:#60a5fa;font-weight:600;">95-99%</td>
                            <td style="padding:6px 8px;text-align:center;color:#e2e8f0;">2</td>
                            <td style="padding:6px 8px;color:#94a3b8;">1 to reach 100% + 1 reserve</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                            <td style="padding:6px 8px;color:#60a5fa;font-weight:600;">90-94%</td>
                            <td style="padding:6px 8px;text-align:center;color:#e2e8f0;">3</td>
                            <td style="padding:6px 8px;color:#94a3b8;">2 to reach 100% + 1 reserve</td>
                        </tr>
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                            <td style="padding:6px 8px;color:#fbbf24;font-weight:600;">75-89%</td>
                            <td style="padding:6px 8px;text-align:center;color:#e2e8f0;">3</td>
                            <td style="padding:6px 8px;color:#94a3b8;">3 videos to dominate</td>
                        </tr>
                        <tr>
                            <td style="padding:6px 8px;color:#f87171;font-weight:600;">Below 75%</td>
                            <td style="padding:6px 8px;text-align:center;color:#e2e8f0;">3</td>
                            <td style="padding:6px 8px;color:#94a3b8;">3 videos to dominate</td>
                        </tr>
                    </table>
                    <p style="color:#64748b;font-size:0.75rem;margin-top:10px;">
                        <strong>Channel Niches:</strong> Security (SH, TR, TOOP, CS) for identity/privacy keywords ‚Ä¢ Pets (TPP, CC, TST) for pet-related keywords
                    </p>
                </div>

                <div style="display:flex;gap:12px;margin-bottom:20px;">
                    <button class="research-btn" onclick="loadContentPlannerData()" id="load-planner-btn">
                        <span id="planner-btn-text">üìä Load Content Plan</span>
                        <div class="spinner" id="planner-spinner" style="display:none;"></div>
                    </button>
                </div>
            </div>

            <!-- Planner Summary Stats (Scorecard) -->
            <div class="stats-grid" id="planner-stats" style="display:none;">
                <div class="stat-card">
                    <h3>üéØ Total Videos Needed</h3>
                    <span id="total-videos-needed" style="color:#f472b6;">0</span>
                </div>
                <div class="stat-card">
                    <h3>üí∞ Revenue at Risk</h3>
                    <span id="total-revenue-at-risk" style="color:#fbbf24;">$0</span>
                </div>
                <div class="stat-card">
                    <h3>üèÜ Keywords at 100%</h3>
                    <span id="keywords-at-100" style="color:#4ade80;">0</span>
                </div>
                <div class="stat-card">
                    <h3>‚ö†Ô∏è Keywords Below 75%</h3>
                    <span id="keywords-below-75" style="color:#f87171;">0</span>
                </div>
            </div>

            <!-- Content Planner Table -->
            <div class="table-container" id="planner-table-container" style="display:none;">
                <div class="table-header">
                    <h2>üìã Video Production Priority List</h2>
                    <span class="results-count" id="planner-results-count">0 keywords</span>
                </div>
                <div class="table-scroll" style="max-height:700px;">
                    <table id="planner-table">
                        <thead>
                            <tr>
                                <th data-sort="keyword">Keyword</th>
                                <th data-sort="domination" class="sorted">Domination</th>
                                <th data-sort="revenue">Dec 2025 Rev</th>
                                <th data-sort="leftOnTable">üí∞ Left on Table</th>
                                <th data-sort="videosNeeded">üé¨ Videos Needed</th>
                                <th>Channel Recommendations</th>
                            </tr>
                        </thead>
                        <tbody id="planner-table-body">
                            <tr><td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;">No data loaded. Click "Load Content Plan" to generate recommendations.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Priority Breakdown -->
            <div class="research-box" id="priority-breakdown" style="display:none;margin-top:20px;">
                <h3 style="color:#a78bfa;margin-bottom:16px;">üéØ Priority Breakdown by Urgency</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
                    <div style="background:rgba(248,113,113,0.1);padding:16px;border-radius:12px;border:1px solid rgba(248,113,113,0.3);">
                        <h4 style="color:#f87171;margin-bottom:8px;">üö® Critical (Below 75%)</h4>
                        <p style="color:#94a3b8;font-size:0.85rem;">Need 3 videos each</p>
                        <span id="critical-count" style="font-size:1.5rem;font-weight:700;color:#f87171;">0</span>
                        <span style="color:#64748b;"> keywords</span>
                    </div>
                    <div style="background:rgba(251,191,36,0.1);padding:16px;border-radius:12px;border:1px solid rgba(251,191,36,0.3);">
                        <h4 style="color:#fbbf24;margin-bottom:8px;">‚ö†Ô∏è High (75-89%)</h4>
                        <p style="color:#94a3b8;font-size:0.85rem;">Need 3 videos each</p>
                        <span id="high-count" style="font-size:1.5rem;font-weight:700;color:#fbbf24;">0</span>
                        <span style="color:#64748b;"> keywords</span>
                    </div>
                    <div style="background:rgba(96,165,250,0.1);padding:16px;border-radius:12px;border:1px solid rgba(96,165,250,0.3);">
                        <h4 style="color:#60a5fa;margin-bottom:8px;">üìà Medium (90-99%)</h4>
                        <p style="color:#94a3b8;font-size:0.85rem;">Need 2-3 videos each</p>
                        <span id="medium-count" style="font-size:1.5rem;font-weight:700;color:#60a5fa;">0</span>
                        <span style="color:#64748b;"> keywords</span>
                    </div>
                    <div style="background:rgba(74,222,128,0.1);padding:16px;border-radius:12px;border:1px solid rgba(74,222,128,0.3);">
                        <h4 style="color:#4ade80;margin-bottom:8px;">‚úÖ Maintain (100%)</h4>
                        <p style="color:#94a3b8;font-size:0.85rem;">1-2 reserve videos</p>
                        <span id="maintain-count" style="font-size:1.5rem;font-weight:700;color:#4ade80;">0</span>
                        <span style="color:#64748b;"> keywords</span>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="planner-empty-state" class="research-box" style="text-align:center;padding:40px;">
                <h3 style="color:#94a3b8;margin-bottom:16px;">No Content Plan Available</h3>
                <p style="color:#64748b;margin-bottom:24px;">
                    Load your domination score data first, then generate a content plan.
                </p>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics-tab">
            <div class="research-box">
                <h2>üìä Calibrated Revenue Model</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Revenue predictions are calibrated from actual performance data (Jan 2026 analysis).
                </p>

                <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:20px;margin-bottom:24px;">
                    <div style="background:rgba(15,23,42,0.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.1);">
                        <h4 style="color:#a78bfa;margin-bottom:12px;">üìà EPV by Keyword Type (All-Time Data)</h4>
                        <div style="font-size:0.85rem;line-height:1.8;">
                            <div style="display:flex;justify-content:space-between;"><span style="color:#4ade80;">Deal/Coupon keywords</span><span>$1.18 <span style="color:#64748b;">(75th: $4.69)</span></span></div>
                            <div style="display:flex;justify-content:space-between;"><span style="color:#a78bfa;">Comparison (X vs Y)</span><span>$0.53 <span style="color:#64748b;">(75th: $1.27)</span></span></div>
                            <div style="display:flex;justify-content:space-between;"><span style="color:#60a5fa;">Review keywords</span><span>$0.31 <span style="color:#64748b;">(75th: $0.72)</span></span></div>
                            <div style="display:flex;justify-content:space-between;"><span style="color:#fbbf24;">Best-of lists</span><span>$0.16 <span style="color:#64748b;">(75th: $0.42)</span></span></div>
                            <div style="display:flex;justify-content:space-between;"><span style="color:#94a3b8;">Informational</span><span>$0.31</span></div>
                        </div>
                        <p style="color:#64748b;font-size:0.7rem;margin-top:8px;">Based on 356 keywords with all-time revenue data</p>
                    </div>

                    <div style="background:rgba(15,23,42,0.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.1);">
                        <h4 style="color:#60a5fa;margin-bottom:12px;">üîÑ Funnel Conversion Rates</h4>
                        <div style="font-size:0.85rem;line-height:1.8;">
                            <div style="display:flex;justify-content:space-between;"><span>Traffic ‚Üí Affiliate Click</span><span>~9.5% CTR</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>Earnings Per Click</span><span>$3.29 median</span></div>
                            <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px solid rgba(148,163,184,0.1);margin-top:8px;">
                                <span class="pattern-badge pattern-distributed">Distributed</span><span>15% capture</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;"><span class="pattern-badge pattern-top_heavy">Top Heavy</span><span>8% capture</span></div>
                            <div style="display:flex;justify-content:space-between;"><span class="pattern-badge pattern-winner_take_all">Winner Take All</span><span>3% capture</span></div>
                        </div>
                    </div>

                    <div style="background:rgba(15,23,42,0.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.1);">
                        <h4 style="color:#4ade80;margin-bottom:12px;">üí∞ Revenue Benchmarks (Monthly)</h4>
                        <div style="font-size:0.85rem;line-height:1.8;">
                            <div style="display:flex;justify-content:space-between;"><span>Median keyword</span><span style="color:#94a3b8;">~$36/mo</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>75th percentile</span><span style="color:#60a5fa;">~$156/mo</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>90th percentile</span><span style="color:#a78bfa;">~$659/mo</span></div>
                            <div style="display:flex;justify-content:space-between;"><span>95th percentile</span><span style="color:#4ade80;">~$1,600/mo</span></div>
                            <div style="display:flex;justify-content:space-between;padding-top:8px;border-top:1px solid rgba(148,163,184,0.1);margin-top:8px;">
                                <span style="color:#94a3b8;">Your top performer</span><span style="color:#fbbf24;">~$20K/mo</span>
                            </div>
                        </div>
                        <p style="color:#64748b;font-size:0.7rem;margin-top:8px;">Most keywords earn modest amounts - focus on volume!</p>
                    </div>
                </div>

                <div style="background:rgba(59,130,246,0.1);padding:16px;border-radius:12px;border:1px solid rgba(59,130,246,0.2);">
                    <h4 style="color:#60a5fa;margin-bottom:8px;">üìê Revenue Formula</h4>
                    <code style="font-size:0.9rem;color:#cbd5e1;">Monthly Revenue = Search Volume √ó Capture Rate √ó EPV</code>
                    <p style="color:#94a3b8;font-size:0.8rem;margin-top:8px;">
                        Example: 10,000 searches √ó 10% capture √ó $0.53 EPV = <strong style="color:#4ade80;">$530/month</strong> (comparison keyword)
                    </p>
                </div>
            </div>

            <div class="research-box" style="margin-top:20px;">
                <h2>üìä Your Revenue Data</h2>
                <div id="revenue-analysis">
                    <p style="color:#64748b;">Loading analysis...</p>
                </div>
            </div>
        </div>

        <!-- $3K Opportunity Finder Tab -->
        <div class="tab-content" id="opportunity-tab">
            <div class="research-box">
                <h2>üí∞ $3K/mo Opportunity Finder</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Find the 10 keywords most likely to earn $3,000/month each. Ranked by feasibility score combining revenue potential, search volume, competition, trends, and buyer intent.
                </p>
                <button class="research-btn" id="opp-load-btn" onclick="loadOpportunities()" style="background:linear-gradient(135deg, #f59e0b, #f97316);">
                    <span id="opp-btn-text">üîç Analyze All Keywords</span>
                    <div class="spinner" id="opp-spinner" style="display:none;"></div>
                </button>
            </div>

            <!-- Summary Stats -->
            <div id="opp-summary" style="display:none;">
                <div class="opp-summary-grid">
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#4ade80;" id="opp-above-target">-</div>
                        <div class="opp-label">Already at $3K+</div>
                    </div>
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#60a5fa;" id="opp-above-1k">-</div>
                        <div class="opp-label">Above $1K/mo</div>
                    </div>
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#fbbf24;" id="opp-above-500">-</div>
                        <div class="opp-label">Above $500/mo</div>
                    </div>
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#a78bfa;" id="opp-top10-revenue">-</div>
                        <div class="opp-label">Top 10 Combined Revenue</div>
                    </div>
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#f97316;" id="opp-top10-feasibility">-</div>
                        <div class="opp-label">Top 10 Avg Feasibility</div>
                    </div>
                    <div class="opp-stat">
                        <div class="opp-value" style="color:#e2e8f0;" id="opp-total">-</div>
                        <div class="opp-label">Total Analyzed</div>
                    </div>
                </div>

                <!-- Target indicator -->
                <div class="research-box" style="background:rgba(245,158,11,0.1);border-color:rgba(245,158,11,0.3);padding:16px;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:1.5rem;">üéØ</span>
                        <div>
                            <strong style="color:#fbbf24;">Goal: 10 keywords x $3,000/mo = $30,000/mo</strong>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-top:4px;" id="opp-goal-status">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Niche Clusters -->
                <div class="research-box" style="margin-bottom:20px;" id="opp-clusters-box">
                    <h3 style="margin-bottom:12px;">üèóÔ∏è Niche Cluster Strategy</h3>
                    <p style="color:#64748b;font-size:0.8rem;margin-bottom:16px;">
                        Since individual keywords rarely hit $3K alone, dominate entire niches. Here's each niche's combined potential.
                    </p>
                    <div id="opp-clusters-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:12px;"></div>
                </div>

                <!-- Filters -->
                <div class="opp-filters">
                    <span style="color:#94a3b8;font-size:0.8rem;margin-right:4px;">Show:</span>
                    <button class="opp-filter-btn active" data-opp-filter="all" onclick="filterOpportunities('all', this)">All</button>
                    <button class="opp-filter-btn" data-opp-filter="top10" onclick="filterOpportunities('top10', this)">Top 10</button>
                    <button class="opp-filter-btn" data-opp-filter="top25" onclick="filterOpportunities('top25', this)">Top 25</button>
                    <button class="opp-filter-btn" data-opp-filter="realistic" onclick="filterOpportunities('realistic', this)">Realistic ($1K+)</button>
                    <button class="opp-filter-btn" data-opp-filter="rising" onclick="filterOpportunities('rising', this)">Rising Trends</button>
                    <button class="opp-filter-btn" data-opp-filter="deal" onclick="filterOpportunities('deal', this)">Deals</button>
                    <button class="opp-filter-btn" data-opp-filter="comparison" onclick="filterOpportunities('comparison', this)">Comparisons</button>
                    <button class="opp-filter-btn" data-opp-filter="lowcomp" onclick="filterOpportunities('lowcomp', this)" style="background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.3);">Low Comp + High Rev</button>
                    <span style="color:#64748b;margin-left:auto;font-size:0.8rem;" id="opp-showing-count"></span>
                </div>

                <!-- Opportunity Cards -->
                <div id="opp-cards-container"></div>

                <!-- Show More Button -->
                <div id="opp-show-more" style="text-align:center;padding:20px;display:none;">
                    <button class="research-btn" onclick="showMoreOpportunities()" style="background:rgba(71,85,105,0.5);padding:10px 30px;">
                        Show More
                    </button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="opp-empty-state" class="research-box" style="text-align:center;padding:60px;">
                <p style="font-size:3rem;margin-bottom:16px;">üí∞</p>
                <h3 style="color:#94a3b8;margin-bottom:12px;">Click "Analyze All Keywords" to find your top revenue opportunities</h3>
                <p style="color:#64748b;font-size:0.85rem;">
                    This analyzes all 2,600+ keywords and ranks them by feasibility of reaching $3,000/month.
                </p>
            </div>
        </div>

        <!-- Keyword Universe Map Tab -->
        <div class="tab-content" id="universe-tab">
            <div class="research-box">
                <h2>üåê Keyword Universe Map</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    See every possible keyword in your niches ‚Äî brand comparisons, reviews, pricing, deals, best-of lists, and more.
                    Find the gaps where you have zero coverage and prioritize expansion.
                </p>
                <button class="research-btn" id="universe-load-btn" onclick="loadUniverse()" style="background:linear-gradient(135deg, #8b5cf6, #6366f1);">
                    <span id="universe-btn-text">üåê Map the Universe</span>
                    <div class="spinner" id="universe-spinner" style="display:none;"></div>
                </button>
            </div>

            <!-- Grand Totals -->
            <div id="universe-results" style="display:none;">
                <div class="universe-grand">
                    <div class="universe-grand-stat">
                        <div class="ug-value" style="color:#a78bfa;" id="ug-universe">-</div>
                        <div class="ug-label">Total Universe</div>
                    </div>
                    <div class="universe-grand-stat">
                        <div class="ug-value" style="color:#4ade80;" id="ug-existing">-</div>
                        <div class="ug-label">You Have</div>
                    </div>
                    <div class="universe-grand-stat">
                        <div class="ug-value" style="color:#f97316;" id="ug-gap">-</div>
                        <div class="ug-label">Missing Keywords</div>
                    </div>
                    <div class="universe-grand-stat">
                        <div class="ug-value" style="color:#60a5fa;" id="ug-coverage">-</div>
                        <div class="ug-label">Coverage</div>
                    </div>
                    <div class="universe-grand-stat">
                        <div class="ug-value" style="color:#fbbf24;" id="ug-gap-revenue">-</div>
                        <div class="ug-label">Est. Gap Revenue</div>
                    </div>
                </div>

                <!-- Overall coverage bar -->
                <div class="research-box" style="padding:16px;margin-bottom:20px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                        <span style="color:#94a3b8;font-size:0.85rem;">Overall Keyword Coverage</span>
                        <span style="font-weight:600;" id="ug-coverage-label">-</span>
                    </div>
                    <div class="coverage-bar">
                        <div class="coverage-fill" id="ug-coverage-bar" style="width:0%;background:#3b82f6;">0%</div>
                    </div>
                    <p style="color:#64748b;font-size:0.75rem;margin-top:8px;" id="ug-coverage-detail"></p>
                </div>

                <!-- Per-Niche Cards -->
                <div id="universe-niches-container"></div>
            </div>

            <!-- Empty State -->
            <div id="universe-empty-state" class="research-box" style="text-align:center;padding:60px;">
                <p style="font-size:3rem;margin-bottom:16px;">üåê</p>
                <h3 style="color:#94a3b8;margin-bottom:12px;">Click "Map the Universe" to discover your keyword gaps</h3>
                <p style="color:#64748b;font-size:0.85rem;">
                    Generates all possible keyword combinations for each niche and shows where you have zero coverage.
                </p>
            </div>
        </div>
    </div>

        <!-- Content Gap Analysis Tab -->
        <div class="tab-content" id="contentgap-tab">
            <div class="research-box">
                <h2 style="margin-bottom:8px;">Content Gap Analysis</h2>
                <p style="color:#94a3b8;margin-bottom:16px;">
                    Compare Digidom's YouTube keyword coverage against competitors.
                    Find keywords they rank for that you're missing.
                </p>
                <button class="research-btn" id="cg-load-competitors-btn" onclick="loadGapCompetitors()"
                        style="background:linear-gradient(135deg, #ec4899, #8b5cf6);">
                    <span id="cg-comp-btn-text">Discover Top Competitors</span>
                    <div class="spinner" id="cg-comp-spinner" style="display:none;"></div>
                </button>
            </div>

            <!-- Competitor Selection -->
            <div id="cg-competitor-selection" style="display:none;">
                <div class="research-box">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;flex-wrap:wrap;gap:12px;">
                        <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
                            <div>
                                <label style="font-size:0.7rem;color:#94a3b8;display:block;margin-bottom:2px;">Filter by Silo</label>
                                <select id="cg-silo-filter" onchange="onCgSiloChange()" style="background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;padding:6px 12px;border-radius:8px;font-size:0.85rem;">
                                    <option value="">All Silos</option>
                                </select>
                            </div>
                            <h3 style="margin:0;">Select Competitors to Compare</h3>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                            <button onclick="selectAllCompetitors()" style="background:rgba(74,222,128,0.15);color:#4ade80;border:1px solid rgba(74,222,128,0.3);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;">Select All</button>
                            <button onclick="deselectAllCompetitors()" style="background:rgba(248,113,113,0.1);color:#f87171;border:1px solid rgba(248,113,113,0.3);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:0.8rem;">Deselect All</button>
                        </div>
                    </div>
                    <div id="cg-competitor-list" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px;margin-bottom:16px;max-height:400px;overflow-y:auto;"></div>
                    <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;">
                        <button class="research-btn" id="cg-analyze-btn" onclick="runGapAnalysis()" disabled
                                style="background:linear-gradient(135deg, #ec4899, #8b5cf6);">
                            <span id="cg-analyze-btn-text">Analyze Content Gaps</span>
                            <div class="spinner" id="cg-analyze-spinner" style="display:none;"></div>
                        </button>
                        <span id="cg-selected-count" style="color:#94a3b8;font-size:0.8rem;">0 selected</span>
                        <span style="color:#64748b;font-size:0.75rem;font-style:italic;">Finds keywords competitors rank for that you don't cover yet</span>
                    </div>
                </div>
            </div>

            <!-- Results -->
            <div id="cg-results" style="display:none;">
                <!-- Summary Stats -->
                <div class="cg-summary-grid">
                    <div class="cg-stat"><div class="cg-value" style="color:#f87171;" id="cg-gap-count">-</div><div class="cg-label">Gap Keywords</div></div>
                    <div class="cg-stat"><div class="cg-value" style="color:#4ade80;" id="cg-winning-count">-</div><div class="cg-label">You Win</div></div>
                    <div class="cg-stat"><div class="cg-value" style="color:#60a5fa;" id="cg-overlap-count">-</div><div class="cg-label">Both Rank</div></div>
                    <div class="cg-stat"><div class="cg-value" style="color:#fbbf24;" id="cg-gap-volume">-</div><div class="cg-label">Gap Search Volume</div></div>
                    <div class="cg-stat"><div class="cg-value" style="color:#a78bfa;" id="cg-gap-revenue">-</div><div class="cg-label">Est. Gap Revenue</div></div>
                    <div class="cg-stat"><div class="cg-value" style="color:#e2e8f0;" id="cg-total-compared">-</div><div class="cg-label">Total Compared</div></div>
                </div>

                <!-- Library status callout -->
                <div class="research-box" style="background:rgba(236,72,153,0.1);border-color:rgba(236,72,153,0.3);padding:16px;margin-bottom:20px;">
                    <div style="display:flex;align-items:center;gap:12px;">
                        <span style="font-size:1.5rem;">üéØ</span>
                        <div>
                            <strong style="color:#ec4899;" id="cg-library-status">-</strong>
                            <p style="color:#94a3b8;font-size:0.85rem;margin-top:4px;" id="cg-library-detail">-</p>
                        </div>
                    </div>
                </div>

                <!-- Sub-views: Gaps / Overlap / Winning -->
                <div style="display:flex;gap:4px;margin-bottom:16px;">
                    <button class="opp-filter-btn active" data-cg-view="gaps" onclick="switchGapView('gaps', this)">Gaps (<span id="cg-gaps-badge">0</span>)</button>
                    <button class="opp-filter-btn" data-cg-view="overlap" onclick="switchGapView('overlap', this)">Overlap (<span id="cg-overlap-badge">0</span>)</button>
                    <button class="opp-filter-btn" data-cg-view="winning" onclick="switchGapView('winning', this)">Winning (<span id="cg-winning-badge">0</span>)</button>
                </div>

                <!-- Gap Keywords Table -->
                <div id="cg-gaps-view">
                    <div class="research-box" style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;" id="cg-gap-table">
                            <thead id="cg-gap-thead"></thead>
                            <tbody id="cg-gap-tbody"></tbody>
                        </table>
                    </div>
                    <div id="cg-gap-show-more" style="text-align:center;padding:20px;display:none;">
                        <button class="research-btn" onclick="showMoreGapKeywords()" style="background:rgba(71,85,105,0.5);padding:10px 30px;">Show More</button>
                    </div>
                </div>

                <!-- Overlap Table -->
                <div id="cg-overlap-view" style="display:none;">
                    <div class="research-box" style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;" id="cg-overlap-table">
                            <thead id="cg-overlap-thead"></thead>
                            <tbody id="cg-overlap-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Winning Table -->
                <div id="cg-winning-view" style="display:none;">
                    <div class="research-box" style="overflow-x:auto;">
                        <table style="width:100%;border-collapse:collapse;" id="cg-winning-table">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                                    <th style="text-align:left;padding:10px;color:#94a3b8;font-size:0.75rem;">KEYWORD</th>
                                    <th style="text-align:center;padding:10px;color:#94a3b8;font-size:0.75rem;">VOLUME</th>
                                    <th style="text-align:center;padding:10px;color:#4ade80;font-size:0.75rem;">DIGIDOM RANK</th>
                                    <th style="text-align:center;padding:10px;color:#94a3b8;font-size:0.75rem;">SILO</th>
                                </tr>
                            </thead>
                            <tbody id="cg-winning-tbody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Enrich Section -->
                <div class="research-box" style="margin-top:20px;">
                    <h3 style="margin-bottom:12px;">Deep-Dive: Enrich Top Gap Keywords</h3>
                    <p style="color:#94a3b8;font-size:0.85rem;margin-bottom:12px;">
                        Get volume, competition, CPC, trends, and related keywords for the top gap keywords using API data.
                    </p>
                    <button class="research-btn" id="cg-enrich-btn" onclick="enrichGapKeywords()" style="background:linear-gradient(135deg, #f59e0b, #f97316);">
                        <span id="cg-enrich-btn-text">Enrich Top 20 Gap Keywords</span>
                        <div class="spinner" id="cg-enrich-spinner" style="display:none;"></div>
                    </button>
                    <div id="cg-enriched-results" style="margin-top:16px;display:none;"></div>
                </div>
            </div>

            <!-- Empty state -->
            <div id="cg-empty-state" class="research-box" style="text-align:center;padding:60px;">
                <h3 style="color:#94a3b8;margin-bottom:12px;">Click "Discover Top Competitors" to begin</h3>
                <p style="color:#64748b;font-size:0.85rem;">
                    Analyzes BigQuery SERP data to find which competitor channels dominate keywords you're not covering.
                </p>
            </div>
        </div>

    </div>

    <!-- Notes Modal -->
    <div class="modal-overlay" id="notes-modal">
        <div class="modal">
            <h3>üìù Notes for: <span id="notes-keyword"></span></h3>
            <textarea id="notes-text" style="width:100%;height:150px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;padding:12px;border-radius:8px;resize:vertical;" placeholder="Add your notes here..."></textarea>
            <div class="modal-buttons">
                <button class="modal-btn secondary" onclick="closeNotesModal()">Cancel</button>
                <button class="modal-btn primary" onclick="saveNotes()">Save Notes</button>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div class="modal-overlay" id="comments-modal">
        <div class="modal" style="max-width:600px;">
            <h3>üí¨ Comments for: <span id="comments-keyword"></span></h3>
            <div class="comments-list" id="comments-list">
                <p style="color:#64748b;text-align:center;padding:20px;">Loading comments...</p>
            </div>
            <div class="comment-input-area">
                <textarea id="comment-input" placeholder="Add a comment..." rows="2"></textarea>
                <button class="modal-btn primary" onclick="addComment()" style="align-self:flex-end;white-space:nowrap;">Post</button>
            </div>
            <div class="modal-buttons" style="margin-top:12px;">
                <button class="modal-btn secondary" onclick="closeCommentsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // STATE
        // ============================================
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const pageSize = 50;
        let sortColumn = 'priority';
        let sortDirection = 'desc';
        let currentNotesKeyword = '';

        // ============================================
        // TABS
        // ============================================
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab + '-tab').classList.add('active');

                if (this.dataset.tab === 'analytics') {
                    loadRevenueAnalysis();
                }
            });
        });

        // ============================================
        // RESEARCH
        // ============================================
        async function researchKeyword() {
            const keyword = document.getElementById('seed-keyword').value.trim();
            const niche = document.getElementById('research-niche').value;

            if (!keyword) {
                alert('Please enter a seed keyword');
                return;
            }

            const btn = document.getElementById('research-btn');
            const btnText = document.getElementById('research-btn-text');
            const spinner = document.getElementById('research-spinner');

            btn.disabled = true;
            btnText.textContent = 'Researching...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/research', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, niche })
                });

                const data = await response.json();
                researchResultsRaw = data;
                researchSortMode = 'score';
                displayResearchResults(data);
            } catch (error) {
                console.error('Research error:', error);
                document.getElementById('research-results').innerHTML =
                    `<div class="result-card"><p style="color:#f87171;">Error: ${error.message}</p></div>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üöÄ Research Keyword';
                spinner.style.display = 'none';
            }
        }

        // Store research results globally for add-to-library
        let researchResultsData = [];
        let researchResultsRaw = null; // raw API response for re-rendering
        let researchSortMode = 'score'; // default sort

        function displayResearchResults(data) {
            const container = document.getElementById('research-results');

            if (!data.keywords || data.keywords.length === 0) {
                container.innerHTML = '<div class="result-card"><p style="color:#94a3b8;">No results found</p></div>';
                return;
            }

            // Store globally for add-to-library
            researchResultsData = data.keywords.map(kw => ({
                keyword: kw.keyword,
                seed_keyword: data.seed_keyword,
                volume: kw.volume || 0,
                cpc: kw.cpc || 0,
                competition: kw.competition || 0,
                yt_avg_views: kw.yt_avg_views || 0,
                yt_total_views: kw.yt_total_views || 0,
                yt_video_count: kw.yt_video_count || 0,
                yt_view_pattern: kw.yt_view_pattern || 'no_data',
                revenue_potential: kw.revenue_potential || 0,
                priority_score: kw.priority_score || 0,
                opportunity_tier: kw.opportunity_tier || 'B - High Value',
                niche: kw.niche || data.niche || 'general',
                keyword_type: kw.keyword_type || 'other'
            }));

            let html = `<h3 style="margin-bottom:8px;">Found ${data.keywords.length} keywords for "${escapeHtml(data.seed_keyword)}"
                <button class="add-to-library-btn" onclick="addAllResearchToLibrary()" style="margin-left:12px;padding:6px 14px;font-size:0.8rem;">+ Add All to Library</button>
            </h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;">
                <button class="opp-filter-btn research-sort-btn ${researchSortMode === 'score' ? 'active' : ''}" onclick="sortResearchResults('score', this)">Best Score</button>
                <button class="opp-filter-btn research-sort-btn ${researchSortMode === 'lowcomp' ? 'active' : ''}" onclick="sortResearchResults('lowcomp', this)" style="background:rgba(74,222,128,0.15);border-color:rgba(74,222,128,0.3);">High Vol / Low Comp</button>
                <button class="opp-filter-btn research-sort-btn ${researchSortMode === 'volume' ? 'active' : ''}" onclick="sortResearchResults('volume', this)">Highest Volume</button>
                <button class="opp-filter-btn research-sort-btn ${researchSortMode === 'revenue' ? 'active' : ''}" onclick="sortResearchResults('revenue', this)">Highest Revenue</button>
            </div>`;

            if (data.errors && data.errors.length > 0) {
                html += `<div style="background:rgba(239,68,68,0.1);padding:12px;border-radius:8px;margin-bottom:16px;color:#f87171;">
                    <strong>Some data sources had issues:</strong><br>${data.errors.join('<br>')}
                </div>`;
            }

            data.keywords.forEach((kw, kwIdx) => {
                const isSeed = kw.source === 'seed';
                const kwType = kw.keyword_type || 'other';
                const kwTypeColors = {
                    'comparison': '#a78bfa',
                    'review': '#60a5fa',
                    'deal': '#4ade80',
                    'best_of': '#fbbf24',
                    'informational': '#94a3b8',
                    'other': '#cbd5e1'
                };
                html += `
                    <div class="result-card ${isSeed ? 'seed' : 'related'}">
                        <div class="result-header">
                            <div>
                                <span class="result-keyword">${escapeHtml(kw.keyword)}</span>
                                ${isSeed ? '<span style="margin-left:8px;font-size:0.7rem;background:#8b5cf6;padding:2px 8px;border-radius:4px;">SEED</span>' : ''}
                                <span style="margin-left:8px;font-size:0.65rem;background:${kwTypeColors[kwType]}22;color:${kwTypeColors[kwType]};padding:2px 8px;border-radius:4px;border:1px solid ${kwTypeColors[kwType]}44;">${kwType.replace(/_/g, ' ')}</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <button class="add-to-library-btn" id="research-add-btn-${kwIdx}" onclick="addResearchKeywordToLibrary('${escapeHtml(kw.keyword).replace(/'/g, "\\'")}', researchResultsData[${kwIdx}], this)">+ Library</button>
                                <span class="tier-badge tier-${kw.opportunity_tier.charAt(0).toLowerCase()}">${kw.opportunity_tier}</span>
                            </div>
                        </div>
                        <div class="result-metrics">
                            <div class="metric">
                                <div class="metric-value">${kw.volume ? kw.volume.toLocaleString() : 'N/A'}</div>
                                <div class="metric-label">Search Volume</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${kw.estimated_traffic ? Math.round(kw.estimated_traffic).toLocaleString() : 'N/A'}</div>
                                <div class="metric-label">Est. Traffic (${kw.capture_rate || 10}%)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value"><span class="pattern-badge pattern-${kw.yt_view_pattern || 'no_data'}">${(kw.yt_view_pattern || 'no data').replace(/_/g, ' ')}</span></div>
                                <div class="metric-label">YT Pattern</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="color:#4ade80;">$${kw.epv ? kw.epv.toFixed(2) : '0'}</div>
                                <div class="metric-label">EPV ($/visitor)</div>
                            </div>
                            <div class="metric" style="min-width:180px;">
                                <div class="metric-value" style="font-size:1rem;">
                                    <span style="color:#94a3b8;">$${kw.revenue_conservative ? kw.revenue_conservative.toFixed(0) : '0'}</span>
                                    <span style="color:#4ade80;margin:0 4px;">$${kw.revenue_potential ? kw.revenue_potential.toFixed(0) : '0'}</span>
                                    <span style="color:#60a5fa;">$${kw.revenue_optimistic ? kw.revenue_optimistic.toFixed(0) : '0'}</span>
                                </div>
                                <div class="metric-label">Revenue (Low / Med / High)</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value">${kw.priority_score ? kw.priority_score.toFixed(0) : '0'}</div>
                                <div class="metric-label">Priority Score</div>
                            </div>
                            <div class="metric">
                                <div class="metric-value" style="color:${(kw.competition || 0) < 0.3 ? '#4ade80' : (kw.competition || 0) < 0.6 ? '#fbbf24' : '#f87171'};">${kw.competition ? (kw.competition <= 1 ? (kw.competition * 100).toFixed(0) + '%' : kw.competition) : 'N/A'}</div>
                                <div class="metric-label">Competition</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function sortResearchResults(mode, btnEl) {
            if (!researchResultsRaw) return;
            researchSortMode = mode;
            document.querySelectorAll('.research-sort-btn').forEach(b => b.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            const sorted = {...researchResultsRaw};
            sorted.keywords = [...researchResultsRaw.keywords];

            switch (mode) {
                case 'lowcomp':
                    // High volume + low competition combo score
                    sorted.keywords.sort((a, b) => {
                        const aComp = parseFloat(a.competition) || 0;
                        const bComp = parseFloat(b.competition) || 0;
                        const aVol = parseInt(a.volume) || 0;
                        const bVol = parseInt(b.volume) || 0;
                        // Score: volume * (1 - competition). Higher = better
                        const aScore = aVol * (1 - aComp);
                        const bScore = bVol * (1 - bComp);
                        return bScore - aScore;
                    });
                    break;
                case 'volume':
                    sorted.keywords.sort((a, b) => (parseInt(b.volume) || 0) - (parseInt(a.volume) || 0));
                    break;
                case 'revenue':
                    sorted.keywords.sort((a, b) => (parseFloat(b.revenue_potential) || 0) - (parseFloat(a.revenue_potential) || 0));
                    break;
                case 'score':
                default:
                    sorted.keywords.sort((a, b) => (parseFloat(b.priority_score) || 0) - (parseFloat(a.priority_score) || 0));
                    break;
            }
            displayResearchResults(sorted);
        }

        // ============================================
        // TRENDING GAPS DISCOVERY
        // ============================================
        async function discoverTrendingGaps() {
            const silo = document.getElementById('trending-silo-filter').value;
            const btn = document.getElementById('trending-btn');
            const btnText = document.getElementById('trending-btn-text');
            const spinner = document.getElementById('trending-spinner');
            const container = document.getElementById('trending-results');

            btn.disabled = true;
            btnText.textContent = 'Scanning Google Trends...';
            spinner.style.display = 'inline-block';
            container.innerHTML = '<div style="text-align:center;padding:30px;color:#94a3b8;">Querying Google Trends for rising topics across your silos... This takes 15-30 seconds.</div>';

            try {
                const response = await fetch(`/api/trending-gaps?silo=${silo}`);
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = `<div style="color:#f87171;padding:20px;">Error: ${data.error}</div>`;
                    return;
                }

                renderTrendingGaps(data);
            } catch (error) {
                container.innerHTML = `<div style="color:#f87171;padding:20px;">Error: ${error.message}</div>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üî• Discover Trending Gaps';
                spinner.style.display = 'none';
            }
        }

        function renderTrendingGaps(data) {
            const container = document.getElementById('trending-results');

            let html = `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;margin-bottom:20px;">
                <div style="background:rgba(74,222,128,0.1);padding:12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:bold;color:#4ade80;">${data.gap_count}</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">Not Covered</div>
                </div>
                <div style="background:rgba(96,165,250,0.1);padding:12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:bold;color:#60a5fa;">${data.covered_count}</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">Already Covered</div>
                </div>
                <div style="background:rgba(251,191,36,0.1);padding:12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:bold;color:#fbbf24;">${data.total_trending}</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">Total Trending</div>
                </div>
                <div style="background:rgba(168,85,247,0.1);padding:12px;border-radius:8px;text-align:center;">
                    <div style="font-size:1.5rem;font-weight:bold;color:#a855f7;">${data.seeds_queried}</div>
                    <div style="font-size:0.8rem;color:#94a3b8;">Seeds Queried</div>
                </div>
            </div>`;

            if (data.errors && data.errors.length > 0) {
                html += `<div style="background:rgba(239,68,68,0.1);padding:10px;border-radius:8px;margin-bottom:16px;color:#f87171;font-size:0.85rem;">
                    <strong>Some seeds had issues:</strong> ${data.errors.slice(0, 3).join('; ')}${data.errors.length > 3 ? ` (+${data.errors.length - 3} more)` : ''}
                </div>`;
            }

            if (data.gaps.length === 0) {
                html += '<div style="text-align:center;padding:30px;color:#94a3b8;">No trending gaps found ‚Äî you\'re covering all the trending topics!</div>';
                container.innerHTML = html;
                return;
            }

            html += `<h3 style="margin-bottom:12px;color:#4ade80;">Trending Topics You're Not Covering</h3>`;
            html += `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(320px, 1fr));gap:12px;">`;

            data.gaps.forEach(gap => {
                const isBreakout = String(gap.trend_value).toLowerCase() === 'breakout';
                const isRising = gap.trend_type === 'rising';
                const trendBadge = isBreakout
                    ? '<span style="background:#ef4444;color:white;padding:2px 8px;border-radius:4px;font-size:0.7rem;font-weight:bold;">BREAKOUT</span>'
                    : isRising
                        ? `<span style="background:rgba(74,222,128,0.2);color:#4ade80;padding:2px 8px;border-radius:4px;font-size:0.7rem;">Rising +${gap.trend_value}%</span>`
                        : `<span style="background:rgba(96,165,250,0.2);color:#60a5fa;padding:2px 8px;border-radius:4px;font-size:0.7rem;">Top</span>`;

                const siloLabel = gap.silo.replace(/_/g, ' ');
                html += `
                    <div style="background:#1e293b;border:1px solid #334155;border-radius:10px;padding:14px;display:flex;flex-direction:column;gap:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <span style="font-weight:600;color:#e2e8f0;font-size:0.95rem;">${escapeHtml(gap.keyword)}</span>
                            ${trendBadge}
                        </div>
                        <div style="display:flex;gap:8px;align-items:center;font-size:0.8rem;color:#94a3b8;">
                            <span style="background:rgba(168,85,247,0.15);color:#a855f7;padding:2px 8px;border-radius:4px;">${siloLabel}</span>
                            <span>from: ${escapeHtml(gap.seed_keyword)}</span>
                        </div>
                    </div>`;
            });

            html += '</div>';

            // Show covered keywords (collapsed)
            if (data.covered.length > 0) {
                html += `<details style="margin-top:20px;"><summary style="cursor:pointer;color:#60a5fa;font-size:0.9rem;">Already covered (${data.covered.length} keywords)</summary>
                    <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:12px;">`;
                data.covered.forEach(c => {
                    html += `<span style="background:rgba(96,165,250,0.1);color:#60a5fa;padding:4px 10px;border-radius:6px;font-size:0.8rem;">${escapeHtml(c.keyword)}</span>`;
                });
                html += '</div></details>';
            }

            container.innerHTML = html;
        }

        // ============================================
        // COMPETITOR ANALYSIS
        // ============================================
        let pendingKeywords = [];
        let approvedKeywords = [];

        async function analyzeCompetitor() {
            const competitor = document.getElementById('competitor-input').value.trim();
            const type = document.getElementById('competitor-type').value;
            const niche = document.getElementById('competitor-niche').value;

            if (!competitor) {
                alert('Please enter a competitor name or URL');
                return;
            }

            const btn = document.getElementById('competitor-btn');
            const btnText = document.getElementById('competitor-btn-text');
            const spinner = document.getElementById('competitor-spinner');

            btn.disabled = true;
            btnText.textContent = 'Analyzing...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/competitor/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ competitor, type, niche })
                });

                const data = await response.json();
                displayCompetitorResults(data);
            } catch (error) {
                console.error('Competitor analysis error:', error);
                document.getElementById('competitor-results').innerHTML =
                    `<div class="result-card"><p style="color:#f87171;">Error: ${error.message}</p></div>`;
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üïµÔ∏è Analyze Competitor';
                spinner.style.display = 'none';
            }
        }

        function displayCompetitorResults(data) {
            const container = document.getElementById('competitor-results');

            if (!data.success) {
                container.innerHTML = `<div class="result-card"><p style="color:#f87171;">Error: ${data.error || 'Analysis failed'}</p></div>`;
                return;
            }

            const hasVideos = data.all_videos && data.all_videos.length > 0;
            const hasKeywords = data.keywords && data.keywords.length > 0;

            if (!hasVideos && !hasKeywords) {
                container.innerHTML = '<div class="result-card"><p style="color:#94a3b8;">No content found for this competitor.</p></div>';
                return;
            }

            pendingKeywords = data.keywords || [];
            approvedKeywords = [];

            let html = `
                <!-- Summary Stats -->
                <div class="stats-grid" style="margin-bottom:20px;">
                    <div class="stat-card">
                        <h3>Videos Found</h3>
                        <div class="value blue">${data.video_count || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Unique Keywords</h3>
                        <div class="value green">${data.keywords?.length || 0}</div>
                    </div>
                    <div class="stat-card">
                        <h3>Competitor</h3>
                        <div class="value purple" style="font-size:1rem;">${escapeHtml(data.competitor)}</div>
                    </div>
                </div>

                <!-- Tab Toggle -->
                <div style="display:flex;gap:8px;margin-bottom:16px;">
                    <button class="research-btn competitor-view-btn active" onclick="showCompetitorView('videos')" id="comp-videos-btn" style="padding:8px 16px;font-size:0.85rem;">
                        üìπ All Videos (${data.all_videos?.length || 0})
                    </button>
                    <button class="research-btn competitor-view-btn" onclick="showCompetitorView('keywords')" id="comp-keywords-btn" style="padding:8px 16px;font-size:0.85rem;background:rgba(107,114,128,0.3);">
                        üéØ Keywords (${data.keywords?.length || 0})
                    </button>
                    <div style="flex:1;"></div>
                    <button class="research-btn" onclick="clearCompetitorResults()" style="background:rgba(107,114,128,0.5);padding:8px 16px;font-size:0.85rem;">
                        ‚úï Clear
                    </button>
                </div>

                <!-- ALL VIDEOS VIEW -->
                <div id="competitor-videos-view" class="research-box" style="border-left: 4px solid #60a5fa;">
                    <h3 style="margin-bottom:16px;">üìπ Complete Video List with Target Keywords</h3>
                    <div style="max-height:600px;overflow-y:auto;">
                        <table style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                                    <th style="text-align:left;padding:8px;color:#94a3b8;font-size:0.75rem;">VIDEO TITLE</th>
                                    <th style="text-align:left;padding:8px;color:#94a3b8;font-size:0.75rem;">TARGET KEYWORD</th>
                                    <th style="text-align:right;padding:8px;color:#94a3b8;font-size:0.75rem;">VOLUME</th>
                                    <th style="text-align:right;padding:8px;color:#94a3b8;font-size:0.75rem;">VIEWS</th>
                                    <th style="text-align:center;padding:8px;color:#94a3b8;font-size:0.75rem;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody>
            `;

            // Add all videos
            if (hasVideos) {
                data.all_videos.forEach((video, index) => {
                    const volume = video.keyword_volume || 0;
                    const volumeColor = volume > 1000 ? '#4ade80' : volume > 100 ? '#fbbf24' : '#94a3b8';

                    html += `
                        <tr style="border-bottom:1px solid rgba(71,85,105,0.3);" id="video-row-${index}">
                            <td style="padding:10px;max-width:350px;">
                                <a href="${escapeHtml(video.link || '#')}" target="_blank" style="color:#e2e8f0;text-decoration:none;font-size:0.85rem;display:block;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                                    ${escapeHtml(video.title || 'Untitled')}
                                </a>
                                <span style="font-size:0.7rem;color:#64748b;">${escapeHtml(video.published || '')}</span>
                            </td>
                            <td style="padding:10px;">
                                <span style="background:rgba(96,165,250,0.15);color:#60a5fa;padding:4px 8px;border-radius:4px;font-size:0.8rem;font-weight:500;">
                                    ${escapeHtml(video.target_keyword || 'N/A')}
                                </span>
                            </td>
                            <td style="padding:10px;text-align:right;">
                                <span style="color:${volumeColor};font-weight:600;">${volume > 0 ? volume.toLocaleString() : '-'}</span>
                            </td>
                            <td style="padding:10px;text-align:right;color:#94a3b8;font-size:0.85rem;">
                                ${escapeHtml(video.views || '-')}
                            </td>
                            <td style="padding:10px;text-align:center;">
                                <button onclick="addVideoKeyword('${escapeHtml(video.target_keyword)}', ${index})" style="background:#22c55e;color:white;border:none;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:0.75rem;">+ Add</button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                html += `<tr><td colspan="5" style="padding:20px;text-align:center;color:#64748b;">No videos found</td></tr>`;
            }

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- KEYWORDS VIEW (hidden by default) -->
                <div id="competitor-keywords-view" class="research-box" style="border-left: 4px solid #f59e0b;display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <h3 style="margin:0;">üéØ Aggregated Keyword Opportunities</h3>
                        <button class="research-btn" onclick="approveAllKeywords()" style="background:linear-gradient(135deg, #22c55e, #16a34a);padding:8px 16px;font-size:0.85rem;">
                            ‚úì Add All (${data.keywords?.length || 0})
                        </button>
                    </div>
                    <div style="max-height:500px;overflow-y:auto;">
            `;

            // Add aggregated keywords
            if (hasKeywords) {
                data.keywords.forEach((kw, index) => {
                    const kwType = kw.keyword_type || 'other';
                    const kwTypeColors = {
                        'comparison': '#a78bfa',
                        'review': '#60a5fa',
                        'deal': '#4ade80',
                        'best_of': '#fbbf24',
                        'informational': '#94a3b8',
                        'other': '#cbd5e1'
                    };

                    html += `
                        <div class="result-card" id="competitor-kw-${index}" style="margin-bottom:12px;border-left:3px solid ${kwTypeColors[kwType]};">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                                        <span style="font-weight:600;color:#f8fafc;">${escapeHtml(kw.keyword)}</span>
                                        <span style="font-size:0.65rem;background:${kwTypeColors[kwType]}22;color:${kwTypeColors[kwType]};padding:2px 8px;border-radius:4px;border:1px solid ${kwTypeColors[kwType]}44;">${kwType.replace(/_/g, ' ')}</span>
                                    </div>
                                    <div style="display:flex;gap:24px;font-size:0.85rem;color:#94a3b8;">
                                        <span>Volume: <strong style="color:#60a5fa;">${kw.volume ? kw.volume.toLocaleString() : 'N/A'}</strong></span>
                                        <span>Est. Rev: <strong style="color:#4ade80;">$${kw.revenue_potential ? kw.revenue_potential.toFixed(0) : '0'}</strong>/mo</span>
                                        <span>Priority: <strong style="color:#fbbf24;">${kw.priority_score ? kw.priority_score.toFixed(0) : '-'}</strong></span>
                                        ${kw.recommendation ? `<span style="color:#a78bfa;">üí° ${escapeHtml(kw.recommendation)}</span>` : ''}
                                    </div>
                                </div>
                                <div style="display:flex;gap:6px;margin-left:16px;">
                                    <button onclick="approveKeyword(${index})" style="background:#22c55e;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">‚úì Add</button>
                                    <button onclick="skipKeyword(${index})" style="background:rgba(107,114,128,0.3);color:#94a3b8;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;font-size:0.8rem;">Skip</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += `<p style="color:#94a3b8;text-align:center;padding:20px;">No keyword patterns extracted</p>`;
            }

            html += `
                    </div>
                </div>
            `;

            container.innerHTML = html;
        }

        function showCompetitorView(view) {
            const videosView = document.getElementById('competitor-videos-view');
            const keywordsView = document.getElementById('competitor-keywords-view');
            const videosBtn = document.getElementById('comp-videos-btn');
            const keywordsBtn = document.getElementById('comp-keywords-btn');

            if (view === 'videos') {
                videosView.style.display = 'block';
                keywordsView.style.display = 'none';
                videosBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                keywordsBtn.style.background = 'rgba(107,114,128,0.3)';
            } else {
                videosView.style.display = 'none';
                keywordsView.style.display = 'block';
                videosBtn.style.background = 'rgba(107,114,128,0.3)';
                keywordsBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            }
        }

        async function addVideoKeyword(keyword, rowIndex) {
            if (!keyword || keyword === 'N/A') return;

            try {
                // Use the new library/add endpoint with user tracking
                await fetch('/api/library/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: keyword,
                        source: 'competitor_analysis',
                        source_detail: document.getElementById('competitor-input')?.value || 'competitor',
                        keyword_data: {}
                    })
                });

                const row = document.getElementById(`video-row-${rowIndex}`);
                if (row) {
                    row.style.background = 'rgba(34,197,94,0.1)';
                    row.querySelector('button').outerHTML = '<span style="color:#4ade80;font-size:0.75rem;">‚úì Added</span>';
                }
            } catch (error) {
                console.error('Error adding keyword:', error);
            }
        }

        async function approveKeyword(index) {
            const kw = pendingKeywords[index];
            if (!kw) return;

            try {
                // Add to library with user tracking
                await fetch('/api/library/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: kw.keyword,
                        source: 'competitor_analysis',
                        source_detail: document.getElementById('competitor-input')?.value || 'competitor',
                        keyword_data: {
                            volume: kw.volume || 0,
                            revenue_potential: kw.revenue_potential || 0,
                            priority_score: kw.priority_score || 0,
                            niche: kw.niche || 'general'
                        }
                    })
                });

                approvedKeywords.push(kw);
                document.getElementById(`competitor-kw-${index}`).style.opacity = '0.4';
                document.getElementById(`competitor-kw-${index}`).innerHTML = `
                    <div style="display:flex;align-items:center;gap:8px;color:#4ade80;">
                        <span>‚úì</span>
                        <span>${escapeHtml(kw.keyword)}</span>
                        <span style="color:#64748b;">Added to interested list</span>
                    </div>
                `;
            } catch (error) {
                console.error('Error approving keyword:', error);
            }
        }

        function skipKeyword(index) {
            document.getElementById(`competitor-kw-${index}`).style.display = 'none';
        }

        async function approveAllKeywords() {
            for (let i = 0; i < pendingKeywords.length; i++) {
                await approveKeyword(i);
            }
            setTimeout(() => {
                document.getElementById('competitor-results').innerHTML = `
                    <div class="result-card" style="border-left:4px solid #22c55e;">
                        <p style="color:#4ade80;font-size:1.1rem;">‚úì Added ${pendingKeywords.length} keywords to your interested list!</p>
                        <p style="color:#94a3b8;margin-top:8px;">View them in the Library tab filtered by "Interested".</p>
                    </div>
                `;
            }, 500);
        }

        function clearCompetitorResults() {
            document.getElementById('competitor-results').innerHTML = '';
            pendingKeywords = [];
        }

        // ============================================
        // CHANNEL KEYWORD ANALYSIS
        // ============================================
        let channelAnalysisData = null;

        async function analyzeChannel() {
            const channel = document.getElementById('channel-input').value.trim();

            if (!channel) {
                alert('Please enter a channel name or handle');
                return;
            }

            const btn = document.getElementById('channel-btn');
            const btnText = document.getElementById('channel-btn-text');
            const spinner = document.getElementById('channel-spinner');

            btn.disabled = true;
            btnText.textContent = 'Analyzing... (this may take a minute)';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/channel/analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ channel })
                });

                const data = await response.json();

                if (!data.success) {
                    throw new Error(data.error || 'Analysis failed');
                }

                channelAnalysisData = data;
                displayChannelResults(data);
            } catch (error) {
                console.error('Channel analysis error:', error);
                alert('Error: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üì∫ Analyze Channel';
                spinner.style.display = 'none';
            }
        }

        function displayChannelResults(data) {
            // Show results
            document.getElementById('channel-results').style.display = 'block';
            const emptyState = document.getElementById('channel-empty-state');
            if (emptyState) emptyState.style.display = 'none';

            // Display stats
            const hotCount = data.publishing_stats?.hot_keywords_count || (data.hot_keywords?.length || 0);
            const statsHtml = `
                <div class="stat-card">
                    <h3>Channel</h3>
                    <div class="value purple" style="font-size:0.9rem;word-break:break-word;">${escapeHtml(data.channel || 'Unknown')}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Videos</h3>
                    <div class="value blue">${data.total_videos || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>Unique Keywords</h3>
                    <div class="value green">${data.publishing_stats?.unique_keywords_found || 0}</div>
                </div>
                <div class="stat-card">
                    <h3>üî• Hot Keywords</h3>
                    <div class="value" style="color:#f97316;">${hotCount}</div>
                    <p style="font-size:0.65rem;color:#64748b;">2+ videos in 12mo</p>
                </div>
                <div class="stat-card">
                    <h3>Top Keyword</h3>
                    <div class="value yellow" style="font-size:0.85rem;word-break:break-word;">${escapeHtml(data.publishing_stats?.most_used_keyword || 'N/A')}</div>
                    <p style="font-size:0.7rem;color:#64748b;">${data.publishing_stats?.most_used_keyword_count || 0} videos</p>
                </div>
                <div class="stat-card">
                    <h3>Videos/Month</h3>
                    <div class="value">${data.publishing_stats?.avg_videos_per_month || 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <h3>Date Range</h3>
                    <div class="value" style="font-size:0.8rem;">${data.publishing_stats?.first_video_date || 'N/A'}<br>to<br>${data.publishing_stats?.last_video_date || 'N/A'}</div>
                </div>
            `;
            document.getElementById('channel-stats').innerHTML = statsHtml;

            // Display keyword patterns table
            const patterns = data.keyword_patterns || [];
            // Store patterns globally for sorting and add-to-library functionality
            window.channelKeywordPatterns = patterns;
            window.currentChannelName = data.channel || 'Unknown';
            // Reset sort to default (by count descending)
            channelSortColumn = 'count';
            channelSortDirection = 'desc';
            // Render the table using the shared function
            renderChannelKeywordsTable();

            // Display hot keywords (republished 2+ times in last 12 months)
            const hotKeywords = data.hot_keywords || [];
            let hotKeywordsHtml = '';
            if (hotKeywords.length > 0) {
                hotKeywords.slice(0, 20).forEach(kw => {
                    const nicheDisplay = (kw.niche || 'general').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    hotKeywordsHtml += `
                        <div style="background:rgba(249,115,22,0.1);padding:16px;border-radius:12px;border:1px solid rgba(249,115,22,0.3);">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                                <strong style="color:#fb923c;">üî• ${escapeHtml(kw.keyword)}</strong>
                                <span style="background:rgba(139,92,246,0.2);color:#a78bfa;padding:2px 8px;border-radius:4px;font-size:0.7rem;">${nicheDisplay}</span>
                            </div>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:0.8rem;color:#94a3b8;">
                                <span>üìπ ${kw.recent_count} videos in 12mo</span>
                                <span>üìä ${kw.count} total videos</span>
                                <span>üëÄ ${kw.avg_views?.toLocaleString() || 0} avg views</span>
                                <span style="color:#4ade80;font-weight:600;">üíµ $${Math.round(kw.revenue_potential || 0).toLocaleString()}/mo est.</span>
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px;">
                                <span style="background:rgba(96,165,250,0.2);color:#60a5fa;padding:2px 6px;border-radius:4px;font-size:0.65rem;">${(kw.keyword_type || 'other').replace(/_/g, ' ')}</span>
                                <span style="background:rgba(74,222,128,0.2);color:#4ade80;padding:2px 6px;border-radius:4px;font-size:0.65rem;">${kw.conversion_immediacy || 'medium'} conv.</span>
                            </div>
                        </div>
                    `;
                });
                document.getElementById('hot-keywords-box').style.display = 'block';
            } else {
                hotKeywordsHtml = '<p style="color:#64748b;text-align:center;">No keywords republished 2+ times in the last 12 months.</p>';
            }
            document.getElementById('hot-keywords-grid').innerHTML = hotKeywordsHtml;

            // Display republish analysis
            const republish = data.republish_analysis || [];
            let republishHtml = '';
            republish.slice(0, 12).forEach(kw => {
                const intervalDays = kw.republish_interval_days || 0;
                let frequencyClass = 'pattern-no_data';
                let frequencyLabel = 'Occasional';
                if (intervalDays < 30) {
                    frequencyClass = 'pattern-distributed';
                    frequencyLabel = 'Very Frequent';
                } else if (intervalDays < 90) {
                    frequencyClass = 'pattern-top_heavy';
                    frequencyLabel = 'Frequent';
                } else if (intervalDays < 180) {
                    frequencyClass = 'pattern-winner_take_all';
                    frequencyLabel = 'Moderate';
                }

                republishHtml += `
                    <div style="background:rgba(15,23,42,0.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.1);">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                            <strong style="color:#e2e8f0;">${escapeHtml(kw.keyword)}</strong>
                            <span class="pattern-badge ${frequencyClass}">${frequencyLabel}</span>
                        </div>
                        <div style="display:flex;gap:16px;font-size:0.85rem;color:#94a3b8;">
                            <span>üìä ${kw.count} videos</span>
                            <span>‚è±Ô∏è Every ${kw.republish_interval_days} days</span>
                            <span>üëÄ ${kw.avg_views?.toLocaleString() || 0} avg views</span>
                        </div>
                    </div>
                `;
            });
            document.getElementById('republish-analysis').innerHTML = republishHtml || '<p style="color:#64748b;">No republish data available</p>';

            // Display videos table
            const videos = data.videos || [];
            let videosHtml = '';
            videos.forEach(video => {
                const views = video.views || 0;
                let viewsStr = views;
                if (typeof views === 'number') {
                    viewsStr = views.toLocaleString();
                }
                videosHtml += `
                    <tr>
                        <td>
                            <a href="${escapeHtml(video.link || '#')}" target="_blank" style="color:#60a5fa;text-decoration:none;">
                                ${escapeHtml(video.title || 'Untitled')}
                            </a>
                        </td>
                        <td>${viewsStr}</td>
                        <td style="font-size:0.8rem;">${escapeHtml(video.published_date || video.published_time || '')}</td>
                    </tr>
                `;
            });
            document.getElementById('channel-videos-body').innerHTML = videosHtml || '<tr><td colspan="3" style="text-align:center;color:#64748b;">No videos found</td></tr>';
        }

        function getCountColor(count) {
            if (count >= 10) return 'linear-gradient(135deg, #4ade80, #22c55e)';
            if (count >= 5) return 'linear-gradient(135deg, #60a5fa, #3b82f6)';
            if (count >= 3) return 'linear-gradient(135deg, #a78bfa, #8b5cf6)';
            return 'linear-gradient(135deg, #64748b, #475569)';
        }

        // ============================================
        // CHANNEL TABLE SORTING
        // ============================================
        let channelSortColumn = 'count';
        let channelSortDirection = 'desc';

        function sortChannelTable(column) {
            if (!window.channelKeywordPatterns || window.channelKeywordPatterns.length === 0) return;

            // Toggle direction if same column
            if (channelSortColumn === column) {
                channelSortDirection = channelSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                channelSortColumn = column;
                // Default to desc for numeric columns, asc for text
                channelSortDirection = ['keyword', 'niche', 'keyword_type', 'view_pattern', 'conversion_immediacy'].includes(column) ? 'asc' : 'desc';
            }

            // Sort the patterns
            window.channelKeywordPatterns.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];

                // Handle nulls
                if (valA === null || valA === undefined) valA = column === 'keyword' ? '' : -Infinity;
                if (valB === null || valB === undefined) valB = column === 'keyword' ? '' : -Infinity;

                // String comparison for text columns
                if (typeof valA === 'string' && typeof valB === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                let result = 0;
                if (valA < valB) result = -1;
                else if (valA > valB) result = 1;

                return channelSortDirection === 'asc' ? result : -result;
            });

            // Re-render the table
            renderChannelKeywordsTable();
        }

        function renderChannelKeywordsTable() {
            const patterns = window.channelKeywordPatterns || [];
            let keywordsHtml = '';

            patterns.forEach((kw, idx) => {
                const intervalText = kw.republish_interval_days !== null
                    ? `${Math.round(kw.republish_interval_days)}d`
                    : '-';
                const nicheDisplay = (kw.niche || 'general').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const recentCount = kw.recent_count || 0;
                const isHot = recentCount >= 2;
                const keywordType = kw.keyword_type || 'other';
                const typeDisplay = keywordType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

                // View distribution badge colors
                const viewPatternColors = {
                    'distributed': { bg: 'rgba(74,222,128,0.2)', color: '#4ade80', label: 'Distributed' },
                    'top_heavy': { bg: 'rgba(251,191,36,0.2)', color: '#fbbf24', label: 'Top Heavy' },
                    'winner_take_all': { bg: 'rgba(248,113,113,0.2)', color: '#f87171', label: 'Winner' },
                    'no_data': { bg: 'rgba(148,163,184,0.2)', color: '#94a3b8', label: 'N/A' }
                };
                const viewPattern = viewPatternColors[kw.view_pattern] || viewPatternColors.no_data;

                // Conversion immediacy badge colors
                const convColors = {
                    'high': { bg: 'rgba(74,222,128,0.2)', color: '#4ade80', label: 'High' },
                    'medium': { bg: 'rgba(251,191,36,0.2)', color: '#fbbf24', label: 'Med' },
                    'low': { bg: 'rgba(148,163,184,0.2)', color: '#94a3b8', label: 'Low' }
                };
                const conv = convColors[kw.conversion_immediacy] || convColors.medium;

                // Willingness to spend formatting
                const willingness = kw.willingness_to_spend || 0;
                const willPct = Math.round(willingness * 100);
                let willColor = '#94a3b8';
                let willBg = 'rgba(148,163,184,0.2)';
                if (willPct >= 70) { willColor = '#4ade80'; willBg = 'rgba(74,222,128,0.2)'; }
                else if (willPct >= 40) { willColor = '#fbbf24'; willBg = 'rgba(251,191,36,0.2)'; }
                else { willColor = '#f87171'; willBg = 'rgba(248,113,113,0.2)'; }

                // Revenue potential formatting
                const revPotential = kw.revenue_potential || 0;
                let revDisplay = '-';
                let revColor = '#94a3b8';
                if (revPotential >= 500) { revDisplay = `$${Math.round(revPotential).toLocaleString()}`; revColor = '#4ade80'; }
                else if (revPotential >= 100) { revDisplay = `$${Math.round(revPotential).toLocaleString()}`; revColor = '#fbbf24'; }
                else if (revPotential > 0) { revDisplay = `$${Math.round(revPotential).toLocaleString()}`; revColor = '#94a3b8'; }

                keywordsHtml += `
                    <tr${isHot ? ' style="background:rgba(249,115,22,0.1);"' : ''} data-keyword-idx="${idx}">
                        <td><input type="checkbox" class="keyword-checkbox" data-idx="${idx}"></td>
                        <td><strong>${escapeHtml(kw.keyword)}</strong>${isHot ? ' <span style="color:#f97316;">üî•</span>' : ''}</td>
                        <td><span style="background:rgba(139,92,246,0.2);color:#a78bfa;padding:2px 6px;border-radius:4px;font-size:0.7rem;">${nicheDisplay}</span></td>
                        <td><span style="background:rgba(96,165,250,0.2);color:#60a5fa;padding:2px 6px;border-radius:4px;font-size:0.7rem;">${typeDisplay}</span></td>
                        <td><span class="tier-badge" style="background:${getCountColor(kw.count)}">${kw.count}</span></td>
                        <td>${recentCount > 0 ? `<span style="color:${isHot ? '#f97316' : '#94a3b8'};">${recentCount}</span>` : '-'}</td>
                        <td><span style="background:${viewPattern.bg};color:${viewPattern.color};padding:2px 6px;border-radius:4px;font-size:0.7rem;">${viewPattern.label}</span></td>
                        <td><span style="background:${conv.bg};color:${conv.color};padding:2px 6px;border-radius:4px;font-size:0.7rem;">${conv.label}</span></td>
                        <td><span style="background:${willBg};color:${willColor};padding:2px 6px;border-radius:4px;font-size:0.7rem;">${willPct}%</span></td>
                        <td style="color:${revColor};font-weight:600;">${revDisplay}</td>
                        <td>${kw.avg_views?.toLocaleString() || 0}</td>
                        <td>${intervalText}</td>
                    </tr>
                `;
            });
            document.getElementById('channel-keywords-body').innerHTML = keywordsHtml || '<tr><td colspan="12" style="text-align:center;color:#64748b;">No repeated keywords found</td></tr>';
        }

        // ============================================
        // ADD TO LIBRARY FUNCTIONS
        // ============================================
        function toggleAllKeywords(checkbox) {
            const checkboxes = document.querySelectorAll('.keyword-checkbox');
            checkboxes.forEach(cb => cb.checked = checkbox.checked);
        }

        function getSelectedKeywords() {
            const checkboxes = document.querySelectorAll('.keyword-checkbox:checked');
            const selected = [];
            checkboxes.forEach(cb => {
                const idx = parseInt(cb.dataset.idx);
                if (window.channelKeywordPatterns && window.channelKeywordPatterns[idx]) {
                    selected.push(window.channelKeywordPatterns[idx]);
                }
            });
            return selected;
        }

        async function addSelectedToLibrary() {
            const selected = getSelectedKeywords();
            if (selected.length === 0) {
                alert('Please select at least one keyword to add');
                return;
            }
            await addKeywordsToLibrary(selected);
        }

        async function addAllToLibrary() {
            if (!window.channelKeywordPatterns || window.channelKeywordPatterns.length === 0) {
                alert('No keywords to add');
                return;
            }
            if (!confirm(`Add all ${window.channelKeywordPatterns.length} keywords to library?`)) {
                return;
            }
            await addKeywordsToLibrary(window.channelKeywordPatterns);
        }

        async function addKeywordsToLibrary(keywords) {
            const statusEl = document.getElementById('add-to-library-status');
            statusEl.textContent = 'Adding keywords...';
            statusEl.style.color = '#fbbf24';

            try {
                const response = await fetch('/api/channel/add-to-library', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keywords: keywords,
                        channel: window.currentChannelName || 'Unknown'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = `‚úì ${data.added} added, ${data.skipped} already existed`;
                    statusEl.style.color = '#4ade80';
                    // Refresh library data
                    loadData();
                } else {
                    statusEl.textContent = `Error: ${data.error}`;
                    statusEl.style.color = '#f87171';
                }
            } catch (error) {
                statusEl.textContent = `Error: ${error.message}`;
                statusEl.style.color = '#f87171';
            }

            // Clear status after 5 seconds
            setTimeout(() => {
                statusEl.textContent = '';
            }, 5000);
        }

        // ============================================
        // LOAD DATA
        // ============================================
        async function loadData() {
            try {
                console.log('[LOAD] Fetching keywords...');
                const response = await fetch('/api/keywords');
                allData = await response.json();
                console.log('[LOAD] Loaded', allData.length, 'keywords');
                console.log('[LOAD] First keyword:', allData[0]);
                populateFilters();
                applyFilters();
                console.log('[LOAD] Filters applied, filteredData:', filteredData.length);
            } catch (error) {
                console.error('[LOAD] Error loading data:', error);
                document.getElementById('table-body').innerHTML =
                    '<tr><td colspan="18" style="text-align:center;padding:40px;color:#f87171;">Error loading data</td></tr>';
            }
        }

        function populateFilters() {
            const niches = [...new Set(allData.map(d => d.niche))].filter(n => n).sort();
            const nicheSelect = document.getElementById('niche-filter');
            niches.forEach(niche => {
                const option = document.createElement('option');
                option.value = niche;
                option.textContent = niche.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                nicheSelect.appendChild(option);
            });

            const sources = [...new Set(allData.map(d => d.source || 'csv'))].sort();
            const sourceSelect = document.getElementById('source-filter');
            sources.forEach(src => {
                const option = document.createElement('option');
                option.value = src;
                option.textContent = src.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                sourceSelect.appendChild(option);
            });
        }

        function applyFilters() {
            const search = document.getElementById('search').value.toLowerCase();
            const niche = document.getElementById('niche-filter').value;
            const tier = document.querySelector('.tier-btn.active').dataset.tier;
            const label = document.querySelector('.label-btn.active').dataset.label;
            const source = document.getElementById('source-filter').value;

            filteredData = allData.filter(d => {
                if (search && !d.keyword.toLowerCase().includes(search)) return false;
                if (niche && d.niche !== niche) return false;
                if (tier && d.tier !== tier) return false;
                if (label === 'favorite' && !d.favorite) return false;
                if (label && label !== 'favorite' && d.label !== label) return false;
                if (source && (d.source || 'csv') !== source) return false;
                return true;
            });

            sortData();
            currentPage = 1;
            renderTable();
            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-total').textContent = filteredData.length.toLocaleString();
            document.getElementById('stat-revenue').textContent = '$' + Math.round(filteredData.reduce((sum, d) => sum + d.revenue, 0)).toLocaleString() + '/mo';
            document.getElementById('stat-atier').textContent = filteredData.filter(d => d.tier.includes('A -')).length.toLocaleString();
            document.getElementById('stat-favorites').textContent = allData.filter(d => d.favorite).length.toLocaleString();
            document.getElementById('stat-interested').textContent = allData.filter(d => d.label === 'interested').length.toLocaleString();
            document.getElementById('stat-notinterested').textContent = allData.filter(d => d.label === 'not_interested').length.toLocaleString();
        }

        function sortData() {
            filteredData.sort((a, b) => {
                let aVal = a[sortColumn];
                let bVal = b[sortColumn];
                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }
                if (sortDirection === 'asc') return aVal > bVal ? 1 : -1;
                return aVal < bVal ? 1 : -1;
            });
        }

        function renderTable() {
            console.log('[RENDER] renderTable called, filteredData:', filteredData.length);
            const start = (currentPage - 1) * pageSize;
            const end = start + pageSize;
            const pageData = filteredData.slice(start, end);
            console.log('[RENDER] Page data:', pageData.length, 'items (page', currentPage, ')');

            const tbody = document.getElementById('table-body');
            console.log('[RENDER] tbody element:', tbody);
            tbody.innerHTML = pageData.map(d => {
                const escapedKw = escapeHtml(d.keyword).replace(/'/g, "\\'");
                const voteScore = d.voteScore || 0;
                const scoreClass = voteScore > 0 ? 'positive' : voteScore < 0 ? 'negative' : 'neutral';
                const userVote = d.userVote || 0;
                const commentCount = d.commentCount || 0;
                return `
                <tr>
                    <td class="action-cell">
                        <div class="action-buttons">
                            <button class="action-btn favorite ${d.favorite ? 'active' : ''}" onclick="toggleFavorite('${escapedKw}')">‚≠ê</button>
                            <button class="action-btn interested" onclick="setLabel('${escapedKw}', 'interested')" title="Interested">‚úì</button>
                            <button class="action-btn maybe" onclick="setLabel('${escapedKw}', 'maybe')" title="Maybe">?</button>
                            <button class="action-btn not-interested" onclick="setLabel('${escapedKw}', 'not_interested')" title="Not Interested">‚úó</button>
                        </div>
                    </td>
                    <td class="keyword-cell">${escapeHtml(d.keyword)}</td>
                    <td class="vote-cell">
                        <div class="vote-container">
                            <button class="vote-btn upvote ${userVote === 1 ? 'active' : ''}" onclick="voteKeyword('${escapedKw}', ${userVote === 1 ? 0 : 1})" title="Upvote">‚ñ≤</button>
                            <span class="vote-score ${scoreClass}">${voteScore}</span>
                            <button class="vote-btn downvote ${userVote === -1 ? 'active' : ''}" onclick="voteKeyword('${escapedKw}', ${userVote === -1 ? 0 : -1})" title="Downvote">‚ñº</button>
                        </div>
                    </td>
                    <td class="comment-cell">
                        <button class="comment-btn ${commentCount > 0 ? 'has-comments' : ''}" onclick="openCommentsModal('${escapedKw}')">
                            üí¨ ${commentCount > 0 ? commentCount : '+'}
                        </button>
                    </td>
                    <td><span class="label-badge label-${d.label || 'none'}" ${d.labelBy ? `title="Set by ${d.labelBy}"` : ''}>${(d.label || 'none').replace(/_/g, ' ')}</span></td>
                    <td><span class="tier-badge tier-${d.tier.charAt(0).toLowerCase()}">${d.tier.split(' - ')[0]}</span></td>
                    <td class="priority-cell">
                        <div class="priority-bar"><div class="priority-fill" style="width: ${d.priority}%"></div></div>
                        <span>${d.priority.toFixed(0)}</span>
                    </td>
                    <td>${d.niche.replace(/_/g, ' ')}</td>
                    <td class="number-cell">$${d.revenue.toFixed(0)}</td>
                    <td><span class="conversion-badge conversion-${(d.conversionLikelihood || '').toLowerCase().replace(/\s+/g, '-')}">${d.conversionLikelihood || '-'}</span></td>
                    <td>${formatWillingness(d.willingness)}</td>
                    <td>${d.idealBrand || '-'}</td>
                    <td>${d.timeToConvert || '-'}</td>
                    <td class="number-cell">${d.ytViews ? d.ytViews.toLocaleString() : '-'}</td>
                    <td><span class="pattern-badge pattern-${d.ytPattern || 'no_data'}">${(d.ytPattern || 'no data').replace(/_/g, ' ')}</span></td>
                    <td class="number-cell">${d.volume ? d.volume.toLocaleString() : '-'}</td>
                    <td class="trend-cell">${formatTrendBadge(d)}</td>
                    <td style="font-size:0.7rem;color:#94a3b8;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${d.addedByEmail || d.source || 'csv'}">${formatAddedBy(d)}</td>
                </tr>
                `;
            }).join('');

            const totalPages = Math.ceil(filteredData.length / pageSize) || 1;
            document.getElementById('results-count').textContent = `Showing ${filteredData.length > 0 ? start + 1 : 0}-${Math.min(end, filteredData.length)} of ${filteredData.length}`;
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages}`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
        }

        // ============================================
        // LABEL & FAVORITE ACTIONS
        // ============================================
        async function setLabel(keyword, label) {
            try {
                const response = await fetch('/api/label', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, label })
                });
                const data = await response.json();

                // Update local data with attribution
                const item = allData.find(d => d.keyword === keyword);
                if (item) {
                    item.label = label;
                    if (data.updatedBy) item.labelBy = data.updatedBy;
                }
                applyFilters();
            } catch (error) {
                console.error('Error setting label:', error);
            }
        }

        async function toggleFavorite(keyword) {
            try {
                const response = await fetch('/api/favorite', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });
                const data = await response.json();

                // Update local data with attribution
                const item = allData.find(d => d.keyword === keyword);
                if (item) {
                    item.favorite = data.favorite;
                    if (data.updatedBy) item.favoriteBy = data.updatedBy;
                }
                applyFilters();
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        }

        function openNotesModal(keyword) {
            currentNotesKeyword = keyword;
            document.getElementById('notes-keyword').textContent = keyword;
            const item = allData.find(d => d.keyword === keyword);
            document.getElementById('notes-text').value = item?.notes || '';
            document.getElementById('notes-modal').classList.add('active');
        }

        function closeNotesModal() {
            document.getElementById('notes-modal').classList.remove('active');
        }

        async function saveNotes() {
            const notes = document.getElementById('notes-text').value;
            try {
                await fetch('/api/notes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword: currentNotesKeyword, notes })
                });

                const item = allData.find(d => d.keyword === currentNotesKeyword);
                if (item) item.notes = notes;
                closeNotesModal();
            } catch (error) {
                console.error('Error saving notes:', error);
            }
        }

        // ============================================
        // VOTING
        // ============================================
        async function voteKeyword(keyword, vote) {
            try {
                const response = await fetch('/api/vote', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword, vote })
                });
                const data = await response.json();
                if (data.success) {
                    // Update local data
                    const item = allData.find(d => d.keyword === keyword);
                    if (item) {
                        item.upvotes = data.upvotes;
                        item.downvotes = data.downvotes;
                        item.voteScore = data.score;
                        item.userVote = data.user_vote;
                    }
                    renderTable();
                }
            } catch (error) {
                console.error('Error voting:', error);
            }
        }

        // ============================================
        // COMMENTS
        // ============================================
        let currentCommentsKeyword = '';

        function openCommentsModal(keyword) {
            currentCommentsKeyword = keyword;
            document.getElementById('comments-keyword').textContent = keyword;
            document.getElementById('comment-input').value = '';
            document.getElementById('comments-modal').classList.add('active');
            loadComments(keyword);
        }

        function closeCommentsModal() {
            document.getElementById('comments-modal').classList.remove('active');
            currentCommentsKeyword = '';
        }

        async function loadComments(keyword) {
            const container = document.getElementById('comments-list');
            container.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">Loading comments...</p>';

            try {
                const response = await fetch(`/api/comments?keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();

                if (!data.success || !data.comments || data.comments.length === 0) {
                    container.innerHTML = '<p style="color:#64748b;text-align:center;padding:20px;">No comments yet. Be the first to comment!</p>';
                    return;
                }

                container.innerHTML = data.comments.map(c => `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">${escapeHtml(c.user_name || c.user_email)}</span>
                            <div style="display:flex;align-items:center;gap:8px;">
                                <span class="comment-date">${new Date(c.created_at).toLocaleDateString()} ${new Date(c.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                                <button class="comment-delete" onclick="deleteComment(${c.id})" title="Delete">‚úï</button>
                            </div>
                        </div>
                        <div class="comment-text">${escapeHtml(c.comment)}</div>
                    </div>
                `).join('');
            } catch (error) {
                container.innerHTML = '<p style="color:#f87171;text-align:center;padding:20px;">Error loading comments</p>';
                console.error('Error loading comments:', error);
            }
        }

        async function addComment() {
            const comment = document.getElementById('comment-input').value.trim();
            if (!comment) return;

            try {
                const response = await fetch('/api/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword: currentCommentsKeyword, comment })
                });
                const data = await response.json();

                if (data.success) {
                    document.getElementById('comment-input').value = '';
                    loadComments(currentCommentsKeyword);

                    // Update comment count in local data
                    const item = allData.find(d => d.keyword === currentCommentsKeyword);
                    if (item) {
                        item.commentCount = (item.commentCount || 0) + 1;
                    }
                    renderTable();
                }
            } catch (error) {
                console.error('Error adding comment:', error);
            }
        }

        async function deleteComment(commentId) {
            if (!confirm('Delete this comment?')) return;

            try {
                const response = await fetch(`/api/comments/${commentId}`, { method: 'DELETE' });
                const data = await response.json();

                if (data.success) {
                    loadComments(currentCommentsKeyword);
                    // Update comment count in local data
                    const item = allData.find(d => d.keyword === currentCommentsKeyword);
                    if (item && item.commentCount > 0) {
                        item.commentCount--;
                    }
                    renderTable();
                } else {
                    alert(data.error || 'Failed to delete comment');
                }
            } catch (error) {
                console.error('Error deleting comment:', error);
            }
        }

        // ============================================
        // ADD TO LIBRARY FROM RESEARCH
        // ============================================
        async function addResearchKeywordToLibrary(keyword, keywordData, buttonEl) {
            buttonEl.disabled = true;
            buttonEl.textContent = 'Adding...';

            try {
                const response = await fetch('/api/library/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        keyword: keyword,
                        source: 'research',
                        source_detail: keywordData.seed_keyword || keyword,
                        keyword_data: keywordData
                    })
                });
                const data = await response.json();

                if (data.success) {
                    buttonEl.textContent = '‚úì Added';
                    buttonEl.classList.add('added');
                    buttonEl.disabled = true;
                    // Refresh library data in background
                    loadData();
                } else {
                    buttonEl.textContent = 'Error';
                    buttonEl.disabled = false;
                    setTimeout(() => { buttonEl.textContent = '+ Library'; buttonEl.disabled = false; }, 2000);
                }
            } catch (error) {
                console.error('Error adding to library:', error);
                buttonEl.textContent = 'Error';
                setTimeout(() => { buttonEl.textContent = '+ Library'; buttonEl.disabled = false; }, 2000);
            }
        }

        async function addAllResearchToLibrary() {
            if (!researchResultsData || researchResultsData.length === 0) return;
            if (!confirm(`Add all ${researchResultsData.length} keywords to library?`)) return;

            for (let i = 0; i < researchResultsData.length; i++) {
                const btn = document.getElementById(`research-add-btn-${i}`);
                if (btn && !btn.classList.contains('added')) {
                    await addResearchKeywordToLibrary(researchResultsData[i].keyword, researchResultsData[i], btn);
                }
            }
        }

        // ============================================
        // ANALYTICS
        // ============================================
        async function loadRevenueAnalysis() {
            try {
                const response = await fetch('/api/revenue/analysis');
                const data = await response.json();

                const container = document.getElementById('revenue-analysis');

                if (data.message) {
                    container.innerHTML = `<p style="color:#94a3b8;">${data.message}</p>`;
                    return;
                }

                let html = `
                    <div class="stats-grid" style="margin-bottom:20px;">
                        <div class="stat-card">
                            <h3>Total Records</h3>
                            <div class="value blue">${data.analysis.total_records}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Total Revenue</h3>
                            <div class="value green">$${data.analysis.total_revenue.toFixed(2)}</div>
                        </div>
                        <div class="stat-card">
                            <h3>Avg per Keyword</h3>
                            <div class="value purple">$${data.analysis.avg_revenue_per_keyword.toFixed(2)}</div>
                        </div>
                    </div>
                `;

                if (data.analysis.patterns.length > 0) {
                    html += '<h4 style="margin:20px 0 12px;">Revenue by YouTube Pattern:</h4>';
                    data.analysis.patterns.forEach(p => {
                        html += `
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid rgba(148,163,184,0.1);">
                                <span class="pattern-badge pattern-${p.pattern}">${p.pattern.replace(/_/g, ' ')}</span>
                                <span>${p.count} keywords | Avg: $${p.avg_revenue.toFixed(2)} | Max: $${p.max_revenue.toFixed(2)}</span>
                            </div>
                        `;
                    });
                }

                container.innerHTML = html;
            } catch (error) {
                document.getElementById('revenue-analysis').innerHTML = `<p style="color:#f87171;">Error loading analysis</p>`;
            }
        }

        // ============================================
        // UTILITIES
        // ============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatWillingness(willingness) {
            if (willingness === undefined || willingness === null) return '-';
            const pct = Math.round(willingness * 100);
            let color = '#94a3b8';
            let bg = 'rgba(148,163,184,0.2)';
            if (pct >= 70) { color = '#4ade80'; bg = 'rgba(74,222,128,0.2)'; }
            else if (pct >= 40) { color = '#fbbf24'; bg = 'rgba(251,191,36,0.2)'; }
            else { color = '#f87171'; bg = 'rgba(248,113,113,0.2)'; }
            return `<span style="background:${bg};color:${color};padding:2px 6px;border-radius:4px;font-size:0.75rem;">${pct}%</span>`;
        }

        function formatAddedBy(d) {
            const email = d.addedByEmail || '';
            const name = d.addedByName || '';
            const source = d.source || 'csv';
            if (source === 'csv' && (!email || email === 'system')) return 'CSV';
            if (source === 'research') return name || 'Research';
            if (source === 'channel_analysis') return name || 'Channel';
            // Show first part of email or name
            if (name && name !== 'CSV Import') return name.split(' ')[0];
            if (email && email !== 'system') return email.split('@')[0];
            return source;
        }

        // Add Keyword Modal functions
        async function refreshKeywordsFromDB() {
            const btn = document.getElementById('refresh-kw-btn');
            btn.disabled = true;
            btn.textContent = 'Refreshing...';
            try {
                const resp = await fetch('/api/keywords/refresh', {method: 'POST'});
                const data = await resp.json();
                if (data.success) {
                    btn.textContent = `Loaded ${data.count}`;
                    // Reload the page data
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                    btn.textContent = 'Refresh from DB';
                    btn.disabled = false;
                }
            } catch(e) {
                alert('Error refreshing: ' + e.message);
                btn.textContent = 'Refresh from DB';
                btn.disabled = false;
            }
        }

        function showAddKeywordModal() {
            document.getElementById('add-keyword-modal').style.display = 'flex';
            document.getElementById('add-kw-input').value = '';
            document.getElementById('add-kw-result').style.display = 'none';
            document.getElementById('add-kw-input').focus();
        }

        function hideAddKeywordModal() {
            document.getElementById('add-keyword-modal').style.display = 'none';
        }

        async function submitNewKeywords() {
            const input = document.getElementById('add-kw-input').value.trim();
            const niche = document.getElementById('add-kw-niche').value;
            const btn = document.getElementById('add-kw-submit');
            const resultDiv = document.getElementById('add-kw-result');

            if (!input) return;

            btn.disabled = true;
            btn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/keywords/add-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: input, niche })
                });
                const data = await response.json();

                if (data.success) {
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#4ade80';
                    resultDiv.innerHTML = `Added ${data.added} keyword(s)${data.skipped > 0 ? ` (${data.skipped} already existed)` : ''}. Added by: ${data.added_by}`;

                    // Reload keywords to show new additions
                    if (data.added > 0) {
                        setTimeout(() => {
                            hideAddKeywordModal();
                            loadKeywords();
                        }, 1200);
                    }
                } else {
                    resultDiv.style.display = 'block';
                    resultDiv.style.color = '#f87171';
                    resultDiv.textContent = 'Error: ' + (data.error || 'Unknown error');
                }
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.style.color = '#f87171';
                resultDiv.textContent = 'Network error: ' + error.message;
            }

            btn.disabled = false;
            btn.textContent = 'Add Keywords';
        }

        function formatTrendBadge(d) {
            const trend = d.trend || 'unknown';
            const change = d.trendChange || 0;
            const interest = d.trendInterest || 0;
            const escapedKw = escapeHtml(d.keyword).replace(/'/g, "\\'");

            if (trend === 'unknown') {
                return `<button class="fetch-trend-btn" onclick="fetchSingleTrend('${escapedKw}', this)" title="Fetch trend data">üìà Fetch</button>`;
            }

            const arrows = { rising: '‚Üë', stable: '‚Üí', declining: '‚Üì' };
            const arrow = arrows[trend] || '?';
            const changeText = change !== 0 ? ` ${change > 0 ? '+' : ''}${Math.round(change)}%` : '';
            const title = `Interest: ${interest}/100 | Change: ${change > 0 ? '+' : ''}${Math.round(change)}%`;

            return `<span class="trend-badge trend-${trend}" title="${title}">${arrow} ${trend}${changeText}</span>`;
        }

        async function fetchSingleTrend(keyword, btnEl) {
            btnEl.disabled = true;
            btnEl.textContent = '...';

            try {
                const response = await fetch('/api/keyword/trend', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keyword })
                });
                const data = await response.json();

                if (data.success) {
                    const item = allData.find(d => d.keyword === keyword);
                    if (item) {
                        item.trend = data.trend;
                        item.trendChange = data.trend_change_pct;
                        item.trendInterest = data.current_interest;
                    }
                    renderTable();
                } else {
                    btnEl.textContent = 'Error';
                    btnEl.disabled = false;
                    setTimeout(() => { btnEl.textContent = 'üìà Fetch'; btnEl.disabled = false; }, 2000);
                }
            } catch (error) {
                console.error('Error fetching trend:', error);
                btnEl.textContent = 'üìà Fetch';
                btnEl.disabled = false;
            }
        }

        function prevPage() { if (currentPage > 1) { currentPage--; renderTable(); } }
        function nextPage() { const totalPages = Math.ceil(filteredData.length / pageSize); if (currentPage < totalPages) { currentPage++; renderTable(); } }

        function exportFiltered() {
            const params = new URLSearchParams();
            const search = document.getElementById('search').value;
            const niche = document.getElementById('niche-filter').value;
            const tier = document.querySelector('.tier-btn.active').dataset.tier;
            if (search) params.append('search', search);
            if (niche) params.append('niche', niche);
            if (tier) params.append('tier', tier);
            window.location.href = '/api/export?' + params.toString();
        }

        // ============================================
        // TRENDS COLLECTION
        // ============================================
        async function collectTrendsData() {
            const btn = document.getElementById('collect-trends-btn');
            const statusEl = document.getElementById('trends-status');
            btn.disabled = true;
            btn.textContent = 'üìà Collecting...';
            statusEl.style.display = 'block';
            statusEl.textContent = 'Starting trends collection in background...';

            try {
                const response = await fetch('/api/cron/collect-trends?batch=25');
                const data = await response.json();

                if (data.success) {
                    statusEl.textContent = data.message + ' Refreshing data periodically...';
                    statusEl.style.color = '#4ade80';

                    // Poll for status updates
                    const pollInterval = setInterval(async () => {
                        try {
                            const statusResp = await fetch('/api/cron/trends-status');
                            const statusData = await statusResp.json();

                            if (statusData.success) {
                                statusEl.textContent = `Trends: ${statusData.trends_fresh_7d}/${statusData.total_keywords} collected | ${statusData.still_needed} remaining` +
                                    (statusData.job_running ? ' | Running...' : ' | Done');

                                if (!statusData.job_running) {
                                    clearInterval(pollInterval);
                                    btn.disabled = false;
                                    btn.textContent = 'üìà Collect Trends';
                                    // Refresh data to show new trends
                                    await loadData();
                                    setTimeout(() => { statusEl.style.display = 'none'; }, 5000);
                                }
                            }
                        } catch (e) {
                            console.error('Error polling trends status:', e);
                        }
                    }, 5000);
                } else {
                    statusEl.textContent = 'Error: ' + (data.error || 'Failed to start collection');
                    statusEl.style.color = '#f87171';
                    btn.disabled = false;
                    btn.textContent = 'üìà Collect Trends';
                }
            } catch (error) {
                console.error('Error starting trends collection:', error);
                statusEl.textContent = 'Error: ' + error.message;
                statusEl.style.color = '#f87171';
                btn.disabled = false;
                btn.textContent = 'üìà Collect Trends';
            }
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================
        document.getElementById('search').addEventListener('input', debounce(applyFilters, 300));
        document.getElementById('niche-filter').addEventListener('change', applyFilters);

        document.querySelectorAll('.tier-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.tier-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                applyFilters();
            });
        });

        document.querySelectorAll('.label-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.label-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                applyFilters();
            });
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', function() {
                const column = this.dataset.sort;
                document.querySelectorAll('th').forEach(h => h.classList.remove('sorted', 'asc'));
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'desc';
                }
                this.classList.add('sorted');
                if (sortDirection === 'asc') this.classList.add('asc');
                applyFilters();
            });
        });

        document.getElementById('seed-keyword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') researchKeyword();
        });

        function debounce(func, wait) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // ============================================
        // DOMINATION SCORE
        // ============================================
        let dominationData = null;
        let domTrackingConfig = null;
        let domTargets = {};
        let domAuditResults = {};
        let domProcessedKeywords = [];  // Store for sorting
        let domAllProcessed = [];       // Unfiltered store
        let domSortColumn = 'domination';
        let domSortDirection = 'desc';
        let domActiveSilo = 'all';

        // Content Planner sorting state
        let plannerKeywordsData = [];  // Store for sorting
        let plannerSortColumn = 'domination';
        let plannerSortDirection = 'asc';

        // Generic sort function
        function sortTableData(data, column, direction) {
            return [...data].sort((a, b) => {
                let aVal = a[column];
                let bVal = b[column];

                // Handle strings
                if (typeof aVal === 'string') aVal = aVal.toLowerCase();
                if (typeof bVal === 'string') bVal = bVal.toLowerCase();

                // Handle nulls/undefined
                if (aVal == null) aVal = direction === 'asc' ? Infinity : -Infinity;
                if (bVal == null) bVal = direction === 'asc' ? Infinity : -Infinity;

                if (direction === 'asc') {
                    return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                } else {
                    return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                }
            });
        }

        // Domination score weights by position
        const DOMINATION_WEIGHTS = {
            1: 50,  // Position 1 = 50%
            2: 25,  // Position 2 = 25%
            3: 15,  // Position 3 = 15%
            4: 5,   // Position 4 = 5%
            5: 5    // Position 5 = 5%
        };

        // Channel mapping: abbreviated name -> patterns to match in YouTube channel names
        const CHANNEL_MAP = {
            'SH':   ['security hero', 'securityhero', 'home security heroes'],
            'CS':   ['cybersleuth', 'cyber sleuth', 'cyber_sleuth'],
            'TR':   ['the tech roost', 'tech roost'],
            'TOOP': ['opt out project', 'optoutproject', 'the opt out'],
            'TPP':  ['pampered pup', 'pamperedpup', 'the pampered'],
            'CC':   ['cozy crates', 'cozycrates'],
            'TST':  ['sniff test', 'snifftest', 'the sniff'],
            'ATNM': ['all tech no money', 'alltechnomoney'],
            'BB':   ['better bets', 'betterbets'],
            'CH':   ['casino hunt', 'casinohunt'],
            'PF':   ['privacy freak', 'privacyfreak'],
            'RZ':   ['reviewszy'],
            'SBS':  ['small biz smarts', 'smallbizsmarts']
        };

        // Your channel names - abbreviated for display
        const YOUR_CHANNELS = Object.keys(CHANNEL_MAP);

        // All patterns for matching (flattened)
        const CHANNEL_PATTERNS = Object.values(CHANNEL_MAP).flat();

        // Helper: get abbreviated name from a channel name
        function getChannelAbbrev(channelName) {
            const lower = channelName.toLowerCase();
            for (const [abbrev, patterns] of Object.entries(CHANNEL_MAP)) {
                for (const pattern of patterns) {
                    if (lower.includes(pattern)) return abbrev;
                }
            }
            return null;
        }

        function showImportModal() {
            document.getElementById('import-modal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.remove('active');
        }

        function importRankingData() {
            const jsonText = document.getElementById('import-json').value.trim();

            if (!jsonText) {
                alert('Please paste the JSON data');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                dominationData = data;

                // Save to backend (DB only, no localStorage)
                saveDominationData(data);

                closeImportModal();
                // Wrap in API-like response with tracking config
                const wrappedData = {
                    success: true,
                    tracking: domTrackingConfig,
                    targets: domTargets,
                    audit_data: data,
                    audit_results_by_keyword: {},
                    timestamp: data.timestamp
                };
                // Build keyword index
                for (const r of (data.all_results || [])) {
                    if (r.keyword) wrappedData.audit_results_by_keyword[r.keyword] = r;
                }
                displayDominationData(wrappedData);
            } catch (error) {
                alert('Invalid JSON format: ' + error.message);
            }
        }

        async function checkDataFreshness() {
            try {
                const response = await fetch('/api/data/staleness');
                const data = await response.json();
                if (!data.success) return;

                const banner = document.getElementById('data-freshness-banner');
                banner.style.display = 'flex';

                if (data.domination_stale) {
                    const lastDate = data.domination_last
                        ? new Date(data.domination_last).toLocaleDateString()
                        : 'never';
                    banner.style.background = 'rgba(251, 191, 36, 0.15)';
                    banner.style.border = '1px solid rgba(251, 191, 36, 0.3)';
                    banner.style.color = '#fbbf24';
                    let msg = `Domination data is <strong>stale</strong> (last snapshot: ${lastDate}). Click "Refresh Domination Score" to update now.`;
                    if (data.db_last_error) {
                        msg += `<br><small style="color:#94a3b8;">DB connection issue: ${data.db_last_error.substring(0, 120)}</small>`;
                    }
                    banner.innerHTML = `<span style="font-size:1.1rem;">&#9888;&#65039;</span><span>${msg}</span>`;
                } else {
                    const lastDate = data.domination_last
                        ? new Date(data.domination_last).toLocaleDateString() + ' ' + new Date(data.domination_last).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
                        : 'unknown';
                    const snapshotCount = data.domination_last ? '' : '';
                    banner.style.background = 'rgba(74, 222, 128, 0.1)';
                    banner.style.border = '1px solid rgba(74, 222, 128, 0.2)';
                    banner.style.color = '#4ade80';
                    banner.innerHTML = `<span style="font-size:1.1rem;">‚úì</span>
                        <span>Data is <strong>fresh</strong> ‚Äî last snapshot: ${lastDate}.
                        Auto-refreshes daily at 06:00 UTC.</span>`;
                }
            } catch (e) {
                console.error('Error checking freshness:', e);
            }
        }

        async function loadDominationData() {
            const btn = document.getElementById('load-domination-btn');
            const btnText = document.getElementById('domination-btn-text');
            const spinner = document.getElementById('domination-spinner');

            btn.disabled = true;
            btnText.textContent = 'Loading...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/domination/data');
                const data = await response.json();

                if (data.success) {
                    domTrackingConfig = data.tracking;
                    domTargets = data.targets || {};
                    domAuditResults = data.audit_results_by_keyword || {};
                    dominationData = data.audit_data;
                    displayDominationData(data);
                } else {
                    alert('No ranking data found. Run an audit or import results.');
                }
            } catch (error) {
                alert('Error loading domination data: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üìä Load Ranking Data';
                spinner.style.display = 'none';
            }
        }

        async function refreshDominationScore() {
            const btn = document.getElementById('refresh-domination-btn');
            const btnText = document.getElementById('refresh-domination-text');
            const spinner = document.getElementById('refresh-domination-spinner');

            btn.disabled = true;
            btnText.textContent = 'Refreshing...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/domination/audit', { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    btnText.textContent = 'Audit running...';
                    let attempts = 0;
                    const poll = setInterval(async () => {
                        attempts++;
                        try {
                            const checkResp = await fetch('/api/domination/data');
                            const checkData = await checkResp.json();
                            if (checkData.success && checkData.timestamp) {
                                const ts = new Date(checkData.timestamp);
                                if ((new Date() - ts) < 120000) {
                                    clearInterval(poll);
                                    domTrackingConfig = checkData.tracking;
                                    domTargets = checkData.targets || {};
                                    domAuditResults = checkData.audit_results_by_keyword || {};
                                    dominationData = checkData.audit_data;
                                    displayDominationData(checkData);
                                    btnText.textContent = 'üîÑ Refresh Domination Score';
                                    spinner.style.display = 'none';
                                    btn.disabled = false;
                                    return;
                                }
                            }
                        } catch (e) { /* keep polling */ }
                        if (attempts >= 60) {
                            clearInterval(poll);
                            btnText.textContent = 'üîÑ Refresh Domination Score';
                            spinner.style.display = 'none';
                            btn.disabled = false;
                            alert('Audit is still running in the background. Try loading data in a few minutes.');
                        }
                    }, 5000);
                } else {
                    alert('Failed to start audit: ' + (data.error || 'Unknown error'));
                    btnText.textContent = 'üîÑ Refresh Domination Score';
                    spinner.style.display = 'none';
                    btn.disabled = false;
                }
            } catch (error) {
                alert('Error triggering refresh: ' + error.message);
                btnText.textContent = 'üîÑ Refresh Domination Score';
                spinner.style.display = 'none';
                btn.disabled = false;
            }
        }

        async function saveDominationData(data) {
            try {
                await fetch('/api/domination/data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            } catch (error) {
                console.error('Error saving domination data:', error);
            }
        }

        function calculateDominationScore(keywordResult) {
            if (!keywordResult || !keywordResult.top_10) return { score: 0, positions: {}, channels: [] };

            let score = 0;
            const positions = { 1: null, 2: null, 3: null, 4: null, 5: null };
            const yourChannels = [];

            // Check each position in top 5
            for (let i = 0; i < Math.min(5, keywordResult.top_10.length); i++) {
                const video = keywordResult.top_10[i];
                const pos = i + 1;
                const channel = video.channel || '';
                const channelLower = channel.toLowerCase();

                // Check if this is one of your channels (using patterns for matching)
                let isYours = false;
                for (const pattern of CHANNEL_PATTERNS) {
                    if (channelLower.includes(pattern)) {
                        isYours = true;
                        break;
                    }
                }

                positions[pos] = {
                    channel: channel,
                    title: video.title || '',
                    views: video.views || 'N/A',
                    isYours: isYours
                };

                if (isYours) {
                    score += DOMINATION_WEIGHTS[pos];
                    yourChannels.push({ position: pos, channel: channel });
                }
            }

            return { score, positions, channels: yourChannels };
        }

        const SILO_LABELS = {id_theft:'ID Theft',dog:'Dog',data_broker:'Data Broker',parental_control:'Parental Control',new_keywords:'New Keywords'};
        const SILO_COLORS = {id_theft:'#818cf8',dog:'#fb923c',data_broker:'#34d399',parental_control:'#f472b6',new_keywords:'#facc15'};

        function displayDominationData(apiResp) {
            // apiResp has: tracking, targets, audit_data, audit_results_by_keyword
            const tracking = apiResp.tracking || apiResp;
            const targets = apiResp.targets || domTargets;
            const auditByKw = apiResp.audit_results_by_keyword || {};
            const auditData = apiResp.audit_data;

            // Build processed keywords from tracking config (if available)
            const processedKeywords = [];

            if (tracking && tracking.silos) {
                // New structured path: iterate silos ‚Üí groups ‚Üí keywords
                for (const silo of tracking.silos) {
                    for (const group of silo.groups || []) {
                        for (const kwEntry of group.keywords || []) {
                            const keyword = kwEntry.keyword;
                            const result = auditByKw[keyword];
                            const domination = result ? calculateDominationScore(result) : {score:0, positions:{1:null,2:null,3:null,4:null,5:null}, channels:[]};
                            const revenue = kwEntry.revenue || result?._revenue || 0;
                            const targetInfo = targets[keyword];
                            const target = targetInfo ? targetInfo.target : 100;
                            const gap = target - domination.score;

                            let leftOnTable = 0;
                            if (domination.score > 0 && revenue > 0) {
                                leftOnTable = (revenue / (domination.score / 100)) - revenue;
                            } else if (domination.score === 0 && revenue > 0) {
                                leftOnTable = revenue * 5;
                            }

                            const isNew = !result;
                            processedKeywords.push({
                                keyword, revenue, domination: domination.score,
                                target, gap, leftOnTable,
                                silo: silo.id, siloLabel: silo.label,
                                group: group.name, is_secondary: false,
                                positions: domination.positions,
                                yourChannels: domination.channels,
                                top10: result?.top_10 || [],
                                targetUpdatedBy: targetInfo?.updated_by || null,
                                targetUpdatedAt: targetInfo?.updated_at || null,
                                isNew: isNew
                            });

                            // Process secondary keywords
                            for (const sec of kwEntry.secondary || []) {
                                const secResult = auditByKw[sec];
                                const secDom = secResult ? calculateDominationScore(secResult) : {score:0, positions:{1:null,2:null,3:null,4:null,5:null}, channels:[]};
                                const secTarget = (targets[sec] || {}).target ?? 100;
                                processedKeywords.push({
                                    keyword: sec, revenue: 0, domination: secDom.score,
                                    target: secTarget, gap: secTarget - secDom.score, leftOnTable: 0,
                                    silo: silo.id, siloLabel: silo.label,
                                    group: group.name, is_secondary: true,
                                    positions: secDom.positions,
                                    yourChannels: secDom.channels,
                                    top10: secResult?.top_10 || [],
                                    targetUpdatedBy: null, targetUpdatedAt: null,
                                    isNew: !secResult
                                });
                            }
                        }
                    }
                }
            } else if (auditData && auditData.all_results) {
                // Legacy fallback: flat audit data (no tracking config)
                for (const result of auditData.all_results) {
                    if (result.error) continue;
                    const keyword = result.keyword;
                    const domination = calculateDominationScore(result);
                    const kwInfo = auditData.ranking?.find(r => r.keyword === keyword) || auditData.not_ranking?.find(r => r.keyword === keyword);
                    const revenue = kwInfo?.revenue || 0;
                    const target = (targets[keyword] || {}).target ?? 100;
                    let leftOnTable = 0;
                    if (domination.score > 0 && revenue > 0) leftOnTable = (revenue / (domination.score / 100)) - revenue;

                    processedKeywords.push({
                        keyword, revenue, domination: domination.score,
                        target, gap: target - domination.score, leftOnTable,
                        silo: result.silo || '', siloLabel: SILO_LABELS[result.silo] || '',
                        group: result.group || '', is_secondary: result.is_secondary || false,
                        positions: domination.positions,
                        yourChannels: domination.channels,
                        top10: result.top_10 || [],
                        targetUpdatedBy: null, targetUpdatedAt: null
                    });
                }
            }

            // Store all processed keywords and filter primary only by default
            domAllProcessed = processedKeywords;
            const primaryOnly = processedKeywords.filter(k => !k.is_secondary);
            domProcessedKeywords = sortTableData(primaryOnly, domSortColumn, domSortDirection);

            // Calculate summary stats (primary keywords only)
            const prim = primaryOnly;
            const totalKeywords = prim.length;
            const avgScore = totalKeywords > 0 ? Math.round(prim.reduce((s,k) => s + k.domination, 0) / totalKeywords) : 0;
            const avgTarget = totalKeywords > 0 ? Math.round(prim.reduce((s,k) => s + k.target, 0) / totalKeywords) : 0;
            const avgGap = avgTarget - avgScore;
            const atTarget = prim.filter(k => k.domination >= k.target).length;
            const noPresence = prim.filter(k => k.domination === 0).length;
            const totalRevenue = prim.reduce((s,k) => s + k.revenue, 0);
            const totalLeftOnTable = prim.reduce((s,k) => s + Math.max(0, k.leftOnTable), 0);

            document.getElementById('dom-total-keywords').textContent = totalKeywords;
            document.getElementById('dom-avg-score').textContent = avgScore + '%';
            document.getElementById('dom-avg-target').textContent = avgTarget + '%';
            document.getElementById('dom-avg-gap').textContent = (avgGap > 0 ? '-' : '') + Math.abs(avgGap) + '%';
            document.getElementById('dom-at-target').textContent = atTarget + '/' + totalKeywords;
            document.getElementById('dom-no-presence').textContent = noPresence;
            document.getElementById('dom-total-revenue').textContent = '$' + totalRevenue.toLocaleString();
            document.getElementById('dom-left-on-table').textContent = '$' + Math.round(totalLeftOnTable).toLocaleString();

            // Show keyword source banner
            const kwSourceBanner = document.getElementById('keyword-source-banner');
            const kwSource = auditData?.keyword_source || 'keyword_tracking';
            const sourceLabels = {
                'priority_keywords': 'Priority Keywords DB',
                'keyword_tracking': 'Tracking Config',
                'previous_audit': 'Previous Audit',
                'keywords_master': 'Keywords Master DB'
            };
            kwSourceBanner.innerHTML = `Keywords from: <strong style="color:#e2e8f0;">${sourceLabels[kwSource] || kwSource}</strong> (${processedKeywords.length} total, ${primaryOnly.length} primary)`;
            kwSourceBanner.style.display = 'block';

            // Dynamically add/remove "New Keywords" silo tab
            const existingNewTab = document.querySelector('#dom-silo-filters .tab[data-silo="new_keywords"]');
            const hasNewKws = processedKeywords.some(k => k.silo === 'new_keywords');
            if (hasNewKws && !existingNewTab) {
                const container = document.querySelector('#dom-silo-filters > div');
                const btn = document.createElement('button');
                btn.className = 'tab';
                btn.dataset.silo = 'new_keywords';
                btn.onclick = function() { filterDomBySilo('new_keywords', this); };
                btn.textContent = 'New Keywords';
                btn.style.borderColor = '#facc15';
                container.appendChild(btn);
            } else if (!hasNewKws && existingNewTab) {
                existingNewTab.remove();
            }

            // Show UI
            document.getElementById('domination-stats').style.display = 'grid';
            document.getElementById('dom-summary-container').style.display = 'block';
            document.getElementById('dom-detail-container').style.display = 'block';
            document.getElementById('domination-empty-state').style.display = 'none';
            document.getElementById('dom-silo-filters').style.display = 'block';

            renderDomSummaryTable(domProcessedKeywords);
            renderDomDetailTable(domProcessedKeywords);
            document.getElementById('dom-summary-count').textContent = totalKeywords + ' primary keywords';
            document.getElementById('dom-detail-count').textContent = totalKeywords + ' keywords + secondaries';
            setupDominationTableSorting();
        }

        function filterDomBySilo(silo, btn) {
            domActiveSilo = silo;
            document.querySelectorAll('#dom-silo-filters .tab').forEach(t => t.classList.remove('active'));
            if (btn) btn.classList.add('active');

            let filtered = domAllProcessed.filter(k => !k.is_secondary);
            if (silo !== 'all') filtered = filtered.filter(k => k.silo === silo);
            domProcessedKeywords = sortTableData(filtered, domSortColumn, domSortDirection);
            renderDomSummaryTable(domProcessedKeywords);
            renderDomDetailTable(domProcessedKeywords);
            document.getElementById('dom-summary-count').textContent = domProcessedKeywords.length + ' primary keywords';
            document.getElementById('dom-detail-count').textContent = domProcessedKeywords.length + ' keywords + secondaries';
        }

        async function updateDomTarget(keyword, newTarget) {
            try {
                const resp = await fetch('/api/domination/targets', {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword, target_dom_score: newTarget})
                });
                const data = await resp.json();
                if (data.success) {
                    domTargets[keyword] = {target: newTarget, updated_by: data.updated_by, updated_at: new Date().toISOString()};
                    // Update in-memory data
                    for (const k of domAllProcessed) {
                        if (k.keyword === keyword) {
                            k.target = newTarget;
                            k.gap = newTarget - k.domination;
                            k.targetUpdatedBy = data.updated_by;
                            k.targetUpdatedAt = new Date().toISOString();
                        }
                    }
                    filterDomBySilo(domActiveSilo, document.querySelector(`#dom-silo-filters .tab[data-silo="${domActiveSilo}"]`));
                }
            } catch (e) {
                console.error('Error updating target:', e);
            }
        }

        function setupDominationTableSorting() {
            document.querySelectorAll('#dom-summary-table th[data-sort], #dom-detail-table th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.onclick = function() {
                    const column = this.dataset.sort;

                    // Update sort state
                    if (domSortColumn === column) {
                        domSortDirection = domSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        domSortColumn = column;
                        domSortDirection = 'desc';
                    }

                    // Update header styles
                    document.querySelectorAll('#dom-summary-table th, #dom-detail-table th').forEach(h => {
                        h.classList.remove('sorted', 'asc');
                    });
                    // Highlight matching columns in both tables
                    document.querySelectorAll(`#dom-summary-table th[data-sort="${column}"], #dom-detail-table th[data-sort="${column}"]`).forEach(h => {
                        h.classList.add('sorted');
                        if (domSortDirection === 'asc') h.classList.add('asc');
                    });

                    // Sort and re-render both tables
                    domProcessedKeywords = sortTableData(domProcessedKeywords, domSortColumn, domSortDirection);
                    renderDomSummaryTable(domProcessedKeywords);
                    renderDomDetailTable(domProcessedKeywords);
                };
            });
        }

        function domScoreColor(score) {
            if (score >= 75) return '#4ade80';
            if (score >= 50) return '#60a5fa';
            if (score >= 25) return '#fbbf24';
            if (score > 0) return '#fb923c';
            return '#f87171';
        }

        function gapColor(gap) {
            if (gap <= 0) return '#4ade80';  // At or above target
            if (gap <= 25) return '#fbbf24'; // Close
            return '#f87171';                // Far from target
        }

        function renderDomSummaryTable(keywords) {
            const tbody = document.getElementById('dom-summary-body');

            if (keywords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;padding:40px;color:#94a3b8;">No keywords found for this filter. Try "All" or load ranking data.</td></tr>';
                return;
            }

            let rows = '';
            for (const k of keywords) {
                const scoreColor = domScoreColor(k.domination);
                const gapCol = gapColor(k.gap);
                const siloColor = SILO_COLORS[k.silo] || '#94a3b8';
                const siloLabel = SILO_LABELS[k.silo] || k.silo;
                const targetTitle = k.targetUpdatedBy ? `Last changed by ${k.targetUpdatedBy}${k.targetUpdatedAt ? ' on ' + new Date(k.targetUpdatedAt).toLocaleDateString() : ''}` : 'Click to edit target';

                // Position cells
                const positionCells = [1, 2, 3, 4, 5].map(pos => {
                    const posData = k.positions ? k.positions[pos] : null;
                    if (!posData) return '<td style="color:#64748b;font-size:0.7rem;">-</td>';
                    if (posData.isYours) {
                        return `<td style="background:rgba(34,197,94,0.15);border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#4ade80;font-weight:600;">${escapeHtml(posData.channel.substring(0, 18))}</div>
                            <div style="font-size:0.6rem;color:#64748b;margin-top:2px;">${escapeHtml(posData.title.substring(0, 28))}...</div>
                        </td>`;
                    } else {
                        return `<td style="background:rgba(239,68,68,0.05);">
                            <div style="font-size:0.7rem;color:#94a3b8;">${escapeHtml(posData.channel.substring(0, 18))}</div>
                            <div style="font-size:0.6rem;color:#64748b;margin-top:2px;">${escapeHtml(posData.title.substring(0, 28))}...</div>
                        </td>`;
                    }
                }).join('');

                const channelSummary = k.yourChannels && k.yourChannels.length > 0
                    ? k.yourChannels.map(c => `#${c.position}: ${c.channel.substring(0, 15)}`).join(', ')
                    : '<span style="color:#f87171;">Not ranking</span>';

                const newBadge = k.isNew ? ' <span style="background:#facc15;color:#1e1b4b;padding:1px 6px;border-radius:4px;font-size:0.6rem;font-weight:700;margin-left:4px;">NEW</span>' : '';

                rows += `<tr${k.isNew ? ' style="background:rgba(250,204,21,0.05);"' : ''}>
                    <td class="keyword-cell">
                        <span style="cursor:pointer;border-bottom:1px dashed #64748b;" onclick="showKeywordHistory('${escapeHtml(k.keyword).replace(/'/g, "\\'")}')">${escapeHtml(k.keyword)}</span>${newBadge}
                    </td>
                    <td><span style="background:${siloColor}22;color:${siloColor};padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;">${siloLabel}</span></td>
                    <td class="number-cell" style="color:#4ade80;font-weight:600;">${k.isNew ? '<span style="color:#64748b;font-size:0.75rem;">-</span>' : '$' + k.revenue.toLocaleString()}</td>
                    <td style="text-align:center;">
                        ${k.isNew ? '<span style="color:#facc15;font-size:0.75rem;">No data yet</span>' : `<div style="display:flex;align-items:center;gap:6px;">
                            <div style="width:50px;height:7px;background:rgba(71,85,105,0.5);border-radius:4px;overflow:hidden;">
                                <div style="width:${k.domination}%;height:100%;background:${scoreColor};border-radius:4px;"></div>
                            </div>
                            <span style="color:${scoreColor};font-weight:700;font-size:0.85rem;">${k.domination}%</span>
                        </div>`}
                    </td>
                    <td style="text-align:center;cursor:pointer;" title="${targetTitle}" onclick="promptDomTarget('${escapeHtml(k.keyword).replace(/'/g, "\\'")}', ${k.target})">
                        <span style="color:#94a3b8;font-size:0.85rem;border-bottom:1px dashed #475569;">${k.target}%</span>
                    </td>
                    <td style="text-align:center;color:${gapCol};font-weight:600;font-size:0.85rem;">
                        ${k.isNew ? '<span style="color:#64748b;">-</span>' : (k.gap > 0 ? '-' + k.gap + '%' : k.gap === 0 ? '&#10003;' : '+' + Math.abs(k.gap) + '%')}
                    </td>
                    ${k.isNew ? '<td colspan="5" style="text-align:center;color:#64748b;font-size:0.75rem;">Run audit to get SERP data</td>' : positionCells}
                    <td style="font-size:0.7rem;max-width:180px;">${k.isNew ? '' : channelSummary}</td>
                </tr>`;
            }
            tbody.innerHTML = rows;
        }


        function renderDomDetailTable(keywords) {
            const tbody = document.getElementById('dom-detail-body');

            if (keywords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px;color:#94a3b8;">No keywords found for this filter. Try "All" or load ranking data.</td></tr>';
                return;
            }

            let lastGroup = '';
            let rows = '';

            for (const k of keywords) {
                const scoreColor = domScoreColor(k.domination);
                const siloColor = SILO_COLORS[k.silo] || '#94a3b8';
                const siloLabel = SILO_LABELS[k.silo] || k.silo;

                // Group header row
                if (k.group && k.group !== lastGroup) {
                    lastGroup = k.group;
                    const groupKws = keywords.filter(gk => gk.group === k.group);
                    const groupAvg = groupKws.length > 0 ? Math.round(groupKws.reduce((s,g) => s + g.domination, 0) / groupKws.length) : 0;

                    rows += `<tr style="background:rgba(71,85,105,0.15);border-top:2px solid rgba(71,85,105,0.3);">
                        <td colspan="2" style="font-weight:700;font-size:0.85rem;color:#e2e8f0;padding:8px 12px;">
                            <span style="color:${siloColor};margin-right:6px;">‚óè</span>${escapeHtml(k.group)}
                            <span style="color:#64748b;font-weight:400;font-size:0.75rem;margin-left:8px;">(${groupKws.length} kw)</span>
                        </td>
                        <td style="text-align:center;font-weight:600;color:${domScoreColor(groupAvg)};font-size:0.85rem;">${groupAvg}%</td>
                        <td colspan="6"></td>
                    </tr>`;
                }

                // Check for secondaries
                const secondaries = domAllProcessed.filter(s => s.is_secondary && s.group === k.group && s.silo === k.silo);
                const hasSecondaries = secondaries.length > 0;
                const kwId = k.keyword.replace(/[^a-z0-9]/gi, '_');

                // Position cells
                const positionCells = [1, 2, 3, 4, 5].map(pos => {
                    const posData = k.positions[pos];
                    if (!posData) return '<td style="color:#64748b;font-size:0.7rem;">-</td>';
                    if (posData.isYours) {
                        return `<td style="background:rgba(34,197,94,0.15);border-left:3px solid #22c55e;">
                            <div style="font-size:0.7rem;color:#4ade80;font-weight:600;">${escapeHtml(posData.channel.substring(0, 18))}</div>
                            <div style="font-size:0.6rem;color:#64748b;margin-top:2px;">${escapeHtml(posData.title.substring(0, 28))}...</div>
                        </td>`;
                    } else {
                        return `<td style="background:rgba(239,68,68,0.05);">
                            <div style="font-size:0.7rem;color:#94a3b8;">${escapeHtml(posData.channel.substring(0, 18))}</div>
                            <div style="font-size:0.6rem;color:#64748b;margin-top:2px;">${escapeHtml(posData.title.substring(0, 28))}...</div>
                        </td>`;
                    }
                }).join('');

                const channelSummary = k.yourChannels.length > 0
                    ? k.yourChannels.map(c => `#${c.position}: ${c.channel.substring(0, 15)}`).join(', ')
                    : '<span style="color:#f87171;">Not ranking</span>';

                const detailNewBadge = k.isNew ? ' <span style="background:#facc15;color:#1e1b4b;padding:1px 6px;border-radius:4px;font-size:0.6rem;font-weight:700;margin-left:4px;">NEW</span>' : '';

                rows += `<tr${k.isNew ? ' style="background:rgba(250,204,21,0.05);"' : ''}>
                    <td class="keyword-cell">
                        ${hasSecondaries ? `<span style="cursor:pointer;margin-right:4px;font-size:0.7rem;color:#64748b;" onclick="toggleSecondaries('${kwId}',this)">&#9654;</span>` : '<span style="display:inline-block;width:16px;"></span>'}
                        <span style="cursor:pointer;border-bottom:1px dashed #64748b;" onclick="showKeywordHistory('${escapeHtml(k.keyword).replace(/'/g, "\\'")}')">${escapeHtml(k.keyword)}</span>${detailNewBadge}
                    </td>
                    <td><span style="background:${siloColor}22;color:${siloColor};padding:2px 8px;border-radius:10px;font-size:0.7rem;font-weight:600;">${siloLabel}</span></td>
                    <td style="text-align:center;">
                        ${k.isNew ? '<span style="color:#facc15;font-size:0.75rem;">No data yet</span>' : `<div style="display:flex;align-items:center;gap:6px;">
                            <div style="width:50px;height:7px;background:rgba(71,85,105,0.5);border-radius:4px;overflow:hidden;">
                                <div style="width:${k.domination}%;height:100%;background:${scoreColor};border-radius:4px;"></div>
                            </div>
                            <span style="color:${scoreColor};font-weight:700;font-size:0.85rem;">${k.domination}%</span>
                        </div>`}
                    </td>
                    ${k.isNew ? '<td colspan="5" style="text-align:center;color:#64748b;font-size:0.75rem;">Run audit to get SERP data</td>' : positionCells}
                    <td style="font-size:0.7rem;max-width:180px;">${k.isNew ? '' : channelSummary}</td>
                </tr>`;

                // Secondary keyword rows (collapsed by default)
                if (hasSecondaries) {
                    const secForThisKw = secondaries.filter(s => {
                        const kwEntry = domTrackingConfig?.silos?.flatMap(si => si.groups?.flatMap(g => g.keywords) || []).find(kw => kw.keyword === k.keyword);
                        return kwEntry?.secondary?.includes(s.keyword);
                    });
                    for (const sec of secForThisKw) {
                        const secScoreColor = domScoreColor(sec.domination);
                        const secChannelSummary = sec.yourChannels.length > 0
                            ? sec.yourChannels.map(c => '#'+c.position+': '+c.channel.substring(0,15)).join(', ')
                            : '<span style="color:#64748b;">Not ranking</span>';
                        rows += `<tr class="secondary-row secondary-${kwId}" style="display:none;background:rgba(15,23,42,0.3);">
                            <td style="padding-left:32px;font-size:0.8rem;color:#94a3b8;">‚Ü≥ ${escapeHtml(sec.keyword)}</td>
                            <td></td>
                            <td style="text-align:center;"><span style="color:${secScoreColor};font-size:0.8rem;">${sec.domination}%</span></td>
                            <td colspan="5" style="font-size:0.7rem;color:#64748b;">${secChannelSummary}</td>
                            <td></td>
                        </tr>`;
                    }
                }
            }
            tbody.innerHTML = rows;
        }

        function toggleSecondaries(kwId, el) {
            const rows = document.querySelectorAll(`.secondary-${kwId}`);
            const visible = rows.length > 0 && rows[0].style.display !== 'none';
            rows.forEach(r => r.style.display = visible ? 'none' : 'table-row');
            el.textContent = visible ? '‚ñ∂' : '‚ñº';
        }

        function promptDomTarget(keyword, currentTarget) {
            const newTarget = prompt(`Set target dom score for "${keyword}"\n(0-100, currently ${currentTarget}%):`, currentTarget);
            if (newTarget !== null) {
                const val = parseInt(newTarget);
                if (!isNaN(val) && val >= 0 && val <= 100) {
                    updateDomTarget(keyword, val);
                } else {
                    alert('Please enter a number between 0 and 100');
                }
            }
        }

        // Add domination tab handler - auto-load from DB when tab is opened
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.dataset.tab === 'domination' && !dominationData) {
                    loadDominationData();
                }
            });
        });

        // ============================================
        // HISTORY MODAL
        // ============================================
        let historyChart = null;

        async function showKeywordHistory(keyword) {
            document.getElementById('history-modal-title').textContent = `üìà History: ${keyword}`;
            document.getElementById('history-modal').classList.add('active');

            try {
                const response = await fetch(`/api/domination/history?keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();

                if (data.success && data.history && data.history.length > 0) {
                    renderHistoryChart(data.history, keyword);
                    renderHistoryTable(data.history);
                } else {
                    document.getElementById('history-table-body').innerHTML =
                        '<tr><td colspan="4" style="text-align:center;padding:20px;color:#94a3b8;">No historical data yet. Run daily audits to build history.</td></tr>';

                    // Clear chart
                    if (historyChart) {
                        historyChart.destroy();
                        historyChart = null;
                    }
                }
            } catch (error) {
                console.error('Error fetching history:', error);
                document.getElementById('history-table-body').innerHTML =
                    '<tr><td colspan="4" style="text-align:center;padding:20px;color:#f87171;">Error loading history</td></tr>';
            }
        }

        function renderHistoryChart(history, keyword) {
            const ctx = document.getElementById('history-chart').getContext('2d');

            // Destroy existing chart
            if (historyChart) {
                historyChart.destroy();
            }

            // Sort by date (oldest first)
            const sortedHistory = [...history].sort((a, b) =>
                new Date(a.snapshot_date) - new Date(b.snapshot_date)
            );

            const labels = sortedHistory.map(h => {
                const date = new Date(h.snapshot_date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const scores = sortedHistory.map(h => h.domination_score);
            const revenues = sortedHistory.map(h => h.revenue);

            historyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Domination Score (%)',
                            data: scores,
                            borderColor: '#4ade80',
                            backgroundColor: 'rgba(74, 222, 128, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3,
                            fill: true
                        },
                        {
                            label: 'Daily Rev ($)',
                            data: revenues,
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#94a3b8' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#64748b' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 100,
                            ticks: { color: '#4ade80' },
                            grid: { color: 'rgba(71, 85, 105, 0.3)' },
                            title: {
                                display: true,
                                text: 'Dom Score (%)',
                                color: '#4ade80'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#f59e0b' },
                            grid: { drawOnChartArea: false },
                            title: {
                                display: true,
                                text: 'Daily Rev ($)',
                                color: '#f59e0b'
                            }
                        }
                    }
                }
            });
        }

        function renderHistoryTable(history) {
            const tbody = document.getElementById('history-table-body');

            // Sort by date (newest first)
            const sortedHistory = [...history].sort((a, b) =>
                new Date(b.snapshot_date) - new Date(a.snapshot_date)
            );

            tbody.innerHTML = sortedHistory.map(h => {
                const date = new Date(h.snapshot_date);
                const dateStr = date.toLocaleDateString('en-US', {
                    year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                });

                const positions = h.positions_owned && h.positions_owned.length > 0
                    ? h.positions_owned.map(p => `#${p}`).join(', ')
                    : 'None';

                let scoreColor = '#f87171';
                if (h.domination_score >= 75) scoreColor = '#4ade80';
                else if (h.domination_score >= 50) scoreColor = '#60a5fa';
                else if (h.domination_score >= 25) scoreColor = '#fbbf24';
                else if (h.domination_score > 0) scoreColor = '#fb923c';

                return `
                    <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                        <td style="padding:8px;color:#94a3b8;">${dateStr}</td>
                        <td style="padding:8px;text-align:right;color:${scoreColor};font-weight:600;">${h.domination_score}%</td>
                        <td style="padding:8px;text-align:right;color:#4ade80;">$${h.revenue.toLocaleString()}</td>
                        <td style="padding:8px;color:#64748b;">${positions}</td>
                    </tr>
                `;
            }).join('');
        }

        function closeHistoryModal() {
            document.getElementById('history-modal').classList.remove('active');
        }

        // ============================================
        // CONTENT PLANNER
        // ============================================

        // Uses YOUR_CHANNELS defined above

        // Channel niches for recommendations
        const CHANNEL_NICHES = {
            security: ['SH', 'TR', 'TOOP', 'CS'],  // Identity, data broker, parental controls
            pets: ['TPP', 'CC', 'TST']             // Pet related
        };

        // Keywords that indicate pet niche
        const PET_KEYWORDS = ['pet', 'dog', 'cat', 'puppy', 'kitten', 'animal', 'pup', 'crate', 'treat', 'food', 'collar', 'leash', 'toy'];

        function getKeywordNiche(keyword) {
            const lower = keyword.toLowerCase();
            for (const petWord of PET_KEYWORDS) {
                if (lower.includes(petWord)) return 'pets';
            }
            return 'security';  // Default to security niche
        }

        function calculateVideosNeeded(domScore) {
            // Calculate videos needed based on domination score
            // Formula: 100% = 1-2 reserve, 95-99% = 2, 90-94% = 3, 75-89% = 3, <75% = 3
            if (domScore >= 100) {
                return { count: 2, label: '1-2 reserve videos', priority: 'maintain', color: '#4ade80' };
            } else if (domScore >= 95) {
                return { count: 2, label: '1 to 100% + 1 reserve', priority: 'low', color: '#60a5fa' };
            } else if (domScore >= 90) {
                return { count: 3, label: '2 to 100% + 1 reserve', priority: 'medium', color: '#60a5fa' };
            } else if (domScore >= 75) {
                return { count: 3, label: '3 videos to dominate', priority: 'high', color: '#fbbf24' };
            } else {
                return { count: 3, label: '3 videos to dominate', priority: 'critical', color: '#f87171' };
            }
        }

        function getChannelRecommendations(top10, domScore, keyword) {
            // Analyze which channels are NOT in top 5 that should be
            const recommendations = [];
            const inTop5 = [];
            const notInTop5 = [];

            // Determine keyword niche
            const niche = getKeywordNiche(keyword || '');
            const nicheChannels = CHANNEL_NICHES[niche] || CHANNEL_NICHES.security;

            if (!top10 || top10.length === 0) {
                return {
                    recommendations: [`Create for: ${nicheChannels.join(', ')}`],
                    inTop5: [],
                    notInTop5: nicheChannels,
                    niche: niche
                };
            }

            // Check which of our niche-relevant channels are in top 5
            for (const abbrev of nicheChannels) {
                const patterns = CHANNEL_MAP[abbrev];
                let foundInTop5 = false;
                for (let i = 0; i < Math.min(5, top10.length); i++) {
                    const video = top10[i];
                    const channelName = (video.channel || '').toLowerCase();
                    // Check if any pattern matches
                    for (const pattern of patterns) {
                        if (channelName.includes(pattern)) {
                            foundInTop5 = true;
                            inTop5.push({ channel: abbrev, position: i + 1 });
                            break;
                        }
                    }
                    if (foundInTop5) break;
                }
                if (!foundInTop5) {
                    notInTop5.push(abbrev);
                }
            }

            // Generate recommendations - prioritize missing channels
            if (domScore >= 100) {
                recommendations.push('‚úÖ Full domination - maintain with reserve content');
            } else if (notInTop5.length > 0) {
                // Prioritize channels NOT in top 5
                recommendations.push(`Create for: ${notInTop5.join(', ')}`);
            } else {
                // All niche channels are in top 5, recommend all
                recommendations.push(`Boost all: ${nicheChannels.join(', ')}`);
            }

            return { recommendations, inTop5, notInTop5, niche };
        }

        // ============================================
        // KEYWORD MANAGER
        // ============================================
        let kmAllKeywords = [];
        let kmFilteredKeywords = [];
        let kmSortCol = 'is_active';
        let kmSortDir = 'desc';

        async function openKeywordManager() {
            const btn = document.getElementById('manage-kw-btn-text');
            const spinner = document.getElementById('manage-kw-spinner');
            btn.textContent = 'Loading...';
            spinner.style.display = 'inline-block';

            try {
                const resp = await fetch('/api/keywords/available');
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Failed to load keywords');

                kmAllKeywords = data.keywords;

                // Populate niche filter with keyword counts
                const nicheCounts = {};
                kmAllKeywords.forEach(k => {
                    if (k.niche) {
                        if (!nicheCounts[k.niche]) nicheCounts[k.niche] = {total: 0, active: 0};
                        nicheCounts[k.niche].total++;
                        if (k.is_active) nicheCounts[k.niche].active++;
                    }
                });
                const niches = Object.keys(nicheCounts).sort();
                const nicheSelect = document.getElementById('km-niche-filter');
                nicheSelect.innerHTML = '<option value="">All Niches (' + kmAllKeywords.length + ')</option>' +
                    niches.map(n => `<option value="${n}">${n} (${nicheCounts[n].active}/${nicheCounts[n].total})</option>`).join('');

                document.getElementById('km-search').value = '';
                document.getElementById('km-status-filter').value = 'all';
                document.getElementById('km-tier-filter').value = '';
                kmSortCol = 'is_active';
                kmSortDir = 'desc';

                // Snapshot original active state and reset pending changes
                kmOriginalState = {};
                kmPendingChanges = {};
                kmAllKeywords.forEach(k => { kmOriginalState[k.keyword] = k.is_active; });
                updateSaveButton();

                // Set initial sort arrow indicators
                for (const [key, label] of Object.entries(kmSortLabels)) {
                    const th = document.getElementById('km-th-' + key);
                    if (th) th.innerHTML = key === kmSortCol ? label + ' <span style="font-size:0.7rem;">&#9660;</span>' : label;
                }

                filterKmKeywords();
                document.getElementById('keyword-manager-modal').classList.add('active');
            } catch (e) {
                alert('Error loading keywords: ' + e.message);
            } finally {
                btn.textContent = 'Manage Keywords';
                spinner.style.display = 'none';
            }
        }

        function closeKeywordManager() {
            document.getElementById('keyword-manager-modal').classList.remove('active');
            if (kmDashboardDirty) {
                kmDashboardDirty = false;
                reloadDominationDashboard();
            }
        }

        async function reloadDominationDashboard() {
            try {
                const response = await fetch('/api/domination/data');
                const data = await response.json();
                if (data.success) {
                    domTrackingConfig = data.tracking;
                    domTargets = data.targets || {};
                    domAuditResults = data.audit_results_by_keyword || {};
                    dominationData = data.audit_data;
                    displayDominationData(data);
                }
            } catch (e) {
                console.error('Dashboard reload error:', e);
            }
        }

        function filterKmKeywords() {
            const search = (document.getElementById('km-search').value || '').toLowerCase().trim();
            const niche = document.getElementById('km-niche-filter').value;
            const status = document.getElementById('km-status-filter').value;
            const tier = document.getElementById('km-tier-filter').value;

            let filtered = kmAllKeywords;

            // Status filter
            if (status === 'active') filtered = filtered.filter(k => k.is_active);
            else if (status === 'inactive') filtered = filtered.filter(k => !k.is_active);
            else if (status === 'bq') filtered = filtered.filter(k => k.in_bigquery);

            // Tier filter
            if (tier) filtered = filtered.filter(k => k.tier === tier);

            // Search filter
            if (search) filtered = filtered.filter(k => k.keyword.includes(search));

            // Niche filter
            if (niche) filtered = filtered.filter(k => k.niche === niche);

            // Sort
            filtered.sort((a, b) => {
                let va = a[kmSortCol], vb = b[kmSortCol];
                if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb||'').toLowerCase(); }
                if (va < vb) return kmSortDir === 'asc' ? -1 : 1;
                if (va > vb) return kmSortDir === 'asc' ? 1 : -1;
                return 0;
            });

            kmFilteredKeywords = filtered;
            renderKmTable(filtered);
            updateKmCounts();
        }

        const kmSortLabels = {is_active:'Active',keyword:'Keyword',tier:'Tier',niche:'Niche',priority_score:'Score',search_volume:'Volume',source:'Source',in_bigquery:'Data'};

        function sortKmTable(col) {
            if (kmSortCol === col) kmSortDir = kmSortDir === 'asc' ? 'desc' : 'asc';
            else { kmSortCol = col; kmSortDir = 'desc'; }
            // Update sort indicators on all headers
            for (const [key, label] of Object.entries(kmSortLabels)) {
                const th = document.getElementById('km-th-' + key);
                if (th) th.innerHTML = key === kmSortCol ? label + ' <span style="font-size:0.7rem;">' + (kmSortDir === 'asc' ? '&#9650;' : '&#9660;') + '</span>' : label;
            }
            filterKmKeywords();
        }

        const TIER_COLORS = {A:'#10b981', B:'#3b82f6', C:'#f59e0b', D:'#6b7280', custom:'#8b5cf6', '':'#475569'};

        const TIER_TOOLTIPS = {A:'Top Priority',B:'High Potential',C:'Medium',D:'Low Priority',custom:'User-added','':''};

        function renderKmTable(keywords) {
            const tbody = document.getElementById('km-table-body');
            if (!keywords.length) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;color:#64748b;">No keywords match current filters</td></tr>';
                return;
            }

            // Limit render to 500 for performance
            const display = keywords.slice(0, 500);
            tbody.innerHTML = display.map((k, idx) => {
                const tierColor = TIER_COLORS[k.tier] || TIER_COLORS[''];
                const tierLabel = k.tier || '-';
                const tierTip = TIER_TOOLTIPS[k.tier] || '';
                const srcLabel = k.source === 'tracking' ? 'TRK' : k.source === 'csv' ? 'CSV' : k.source === 'bigquery' ? 'BQ' : k.source === 'custom' ? 'USR' : k.source || '-';
                const srcTip = k.source === 'tracking' ? 'From keyword tracking list' : k.source === 'csv' ? 'Imported from CSV' : k.source === 'bigquery' ? 'Added from BigQuery' : k.source === 'custom' ? 'Custom user-added' : '';
                const escKw = k.keyword.replace(/'/g,"\\'");
                const deleteBtn = k.source === 'custom' ? `<button onclick="deleteKmKeyword('${escKw}')" style="background:none;border:none;color:#ef4444;cursor:pointer;font-size:1rem;padding:0 4px;" title="Delete this keyword">&times;</button>` : '';
                const dataIcon = k.in_bigquery ? '<span style="color:#10b981;" title="Has historical SERP data">&#10003;</span>' : '<span style="color:#475569;">-</span>';
                const scoreTip = k.priority_score ? `Priority Score: ${Math.round(k.priority_score)} ‚Äî Higher = better opportunity` : '';
                let roleTag = '';
                if (k.is_primary && k.secondaries && k.secondaries.length) {
                    roleTag = ` <span style="color:#64748b;font-size:0.65rem;background:rgba(100,116,139,0.15);padding:1px 5px;border-radius:3px;cursor:help;" title="Secondary keywords:\n${k.secondaries.join('\n')}">primary</span>`;
                } else if (k.secondary_of && k.secondary_of.length) {
                    roleTag = ` <span style="color:#64748b;font-size:0.65rem;background:rgba(100,116,139,0.15);padding:1px 5px;border-radius:3px;cursor:help;" title="Secondary of:\n${k.secondary_of.join('\n')}">secondary</span>`;
                }
                return `<tr style="border-bottom:1px solid rgba(71,85,105,0.2);">
                    <td style="text-align:center;padding:6px 8px;color:#475569;font-size:0.75rem;">${idx + 1}</td>
                    <td style="text-align:center;padding:6px 8px;">
                        <input type="checkbox" ${k.is_active ? 'checked' : ''} ${(k.is_primary && k.secondaries && k.secondaries.length) ? 'disabled title="Has secondary keywords ‚Äî remove them first to deactivate"' : ''} onchange="toggleKmKeyword('${escKw}', this.checked)" style="cursor:pointer;width:16px;height:16px;${(k.is_primary && k.secondaries && k.secondaries.length) ? 'opacity:0.6;' : ''}">
                    </td>
                    <td style="padding:6px 8px;color:#e2e8f0;max-width:400px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${k.keyword}${deleteBtn}${roleTag}</td>
                    <td style="text-align:center;padding:6px 8px;" title="${tierTip}"><span style="color:${tierColor};font-weight:600;font-size:0.8rem;">${tierLabel}</span></td>
                    <td style="padding:6px 8px;color:#94a3b8;font-size:0.8rem;">${k.niche || '-'}</td>
                    <td style="text-align:right;padding:6px 8px;color:#e2e8f0;" title="${scoreTip}">${k.priority_score ? Math.round(k.priority_score) : '-'}</td>
                    <td style="text-align:right;padding:6px 8px;color:#e2e8f0;">${k.search_volume ? k.search_volume.toLocaleString() : '-'}</td>
                    <td style="text-align:center;padding:6px 8px;color:#64748b;font-size:0.75rem;" title="${srcTip}">${srcLabel}</td>
                    <td style="text-align:center;padding:6px 8px;">${dataIcon}</td>
                </tr>`;
            }).join('');

            if (keywords.length > 500) {
                tbody.innerHTML += `<tr><td colspan="9" style="text-align:center;padding:12px;color:#64748b;font-size:0.8rem;">Showing 500 of ${keywords.length} ‚Äî use search to narrow down</td></tr>`;
            }
        }

        function updateKmCounts() {
            const activeCount = kmAllKeywords.filter(k => k.is_active).length;
            document.getElementById('km-active-count').textContent = `${activeCount} active / ${kmAllKeywords.length} total`;
            document.getElementById('km-showing-count').textContent = `Showing ${Math.min(kmFilteredKeywords.length, 500)} of ${kmFilteredKeywords.length} keywords`;
        }

        // Track pending changes: {keyword: true/false}
        let kmPendingChanges = {};
        // Snapshot of original is_active state when modal opened
        let kmOriginalState = {};
        // Track if keyword manager made changes that need dashboard refresh
        let kmDashboardDirty = false;

        function toggleKmKeyword(keyword, active) {
            const kw = kmAllKeywords.find(k => k.keyword === keyword);
            // Block deactivation of primary keywords that have secondaries
            if (kw && kw.is_primary && !active && kw.secondaries && kw.secondaries.length) {
                document.getElementById('km-status').textContent = 'Has secondary keywords ‚Äî remove them first to deactivate';
                setTimeout(() => { document.getElementById('km-status').textContent = ''; }, 2000);
                filterKmKeywords();
                return;
            }
            if (kw) kw.is_active = active;

            // Track if this differs from original
            if (kmOriginalState[keyword] !== undefined && kmOriginalState[keyword] !== active) {
                kmPendingChanges[keyword] = active;
            } else {
                delete kmPendingChanges[keyword];
            }

            updateKmCounts();
            updateSaveButton();
        }

        async function deleteKmKeyword(keyword) {
            const kw = kmAllKeywords.find(k => k.keyword === keyword);
            if (kw && kw.is_primary && kw.secondaries && kw.secondaries.length > 0) {
                alert(`Cannot delete "${keyword}" ‚Äî it has ${kw.secondaries.length} secondary keyword(s):\n\n${kw.secondaries.join('\n')}\n\nRemove or reassign the secondary keywords first.`);
                return;
            }
            if (!confirm(`Delete "${keyword}" from your keyword list?`)) return;
            try {
                const resp = await fetch('/api/keywords/priority', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keywords: [keyword]})
                });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error);

                // Remove from local state and cleanup tracking
                kmAllKeywords = kmAllKeywords.filter(k => k.keyword !== keyword);
                kmFilteredKeywords = kmFilteredKeywords.filter(k => k.keyword !== keyword);
                delete kmOriginalState[keyword];
                delete kmPendingChanges[keyword];
                renderKmTable(kmFilteredKeywords);
                updateKmCounts();
                updateSaveButton();
                document.getElementById('km-status').textContent = `"${keyword}" deleted`;
                setTimeout(() => { document.getElementById('km-status').textContent = ''; }, 2000);
                kmDashboardDirty = true;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function updateSaveButton() {
            const btn = document.getElementById('km-save-btn');
            const count = Object.keys(kmPendingChanges).length;
            const countEl = document.getElementById('km-pending-count');
            if (count > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.pointerEvents = 'auto';
                btn.style.background = '#8b5cf6';
                btn.textContent = `Save Changes (${count})`;
                const added = Object.values(kmPendingChanges).filter(v => v).length;
                const removed = Object.values(kmPendingChanges).filter(v => !v).length;
                let parts = [];
                if (added) parts.push(`+${added} added`);
                if (removed) parts.push(`-${removed} removed`);
                countEl.textContent = parts.join(', ');
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.pointerEvents = 'none';
                btn.style.background = '#6b7280';
                btn.textContent = 'Save Changes';
                countEl.textContent = '';
            }
        }

        async function saveKmChanges() {
            const changes = {...kmPendingChanges};
            const activated = Object.entries(changes).filter(([k,v]) => v).map(([k]) => k);
            const deactivated = Object.entries(changes).filter(([k,v]) => !v).map(([k]) => k);

            if (!activated.length && !deactivated.length) return;

            // If there are activated keywords, show role config first
            if (activated.length) {
                showRoleConfigModal(activated, deactivated, changes);
                return;
            }

            // No activated ‚Äî save directly
            await executeSave(activated, deactivated, changes, []);
        }

        function showRoleConfigModal(activated, deactivated, changes) {
            const primaries = kmAllKeywords.filter(k => k.is_primary).sort((a,b) => a.keyword.localeCompare(b.keyword));
            const primaryOpts = primaries.map(p => `<option value="${p.keyword}">${p.keyword}</option>`).join('');

            let html = '<div style="max-height:50vh;overflow-y:auto;">';
            html += `<p style="color:#94a3b8;font-size:0.8rem;margin-bottom:12px;">Set role and silo for newly activated keywords. Primary keywords are always included in audits.</p>`;
            html += activated.map((kw, i) => {
                const k = kmAllKeywords.find(x => x.keyword === kw);
                const hasBQ = k && k.in_bigquery;
                const currentNiche = k ? (k.niche || '') : '';
                const nicheToSilo = {'ID Theft':'id_theft','Dog':'dog','Data Broker':'data_broker','Parental Control':'parental_control'};
                const autoSilo = nicheToSilo[currentNiche] || '';
                return `<div style="display:flex;align-items:center;gap:8px;padding:8px 0;border-bottom:1px solid rgba(71,85,105,0.2);flex-wrap:wrap;">
                    <span style="color:#e2e8f0;font-size:0.83rem;min-width:160px;flex:1;">${kw}${hasBQ ? ' <span style="color:#10b981;font-size:0.7rem;">has data</span>' : ''}</span>
                    <select id="km-role-${i}" onchange="kmRoleSelChanged(${i})" style="padding:4px 6px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.78rem;">
                        <option value="none">No role</option>
                        <option value="primary">Primary</option>
                        <option value="secondary">Secondary</option>
                    </select>
                    <select id="km-silo-${i}" style="padding:4px 6px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.78rem;">
                        <option value=""${!autoSilo ? ' selected' : ''}>Silo...</option>
                        <option value="id_theft"${autoSilo==='id_theft'?' selected':''}>ID Theft</option>
                        <option value="dog"${autoSilo==='dog'?' selected':''}>Dog</option>
                        <option value="data_broker"${autoSilo==='data_broker'?' selected':''}>Data Broker</option>
                        <option value="parental_control"${autoSilo==='parental_control'?' selected':''}>Parental Control</option>
                        <option value="new">New / Other</option>
                    </select>
                    <select id="km-parent-${i}" style="display:none;padding:4px 6px;background:rgba(15,23,42,0.8);border:1px solid rgba(71,85,105,0.5);color:#e2e8f0;border-radius:4px;font-size:0.78rem;max-width:200px;">
                        <option value="">Select primary...</option>
                        ${primaryOpts}
                    </select>
                </div>`;
            }).join('');
            html += '</div>';

            if (deactivated.length) {
                html += `<div style="margin-top:12px;padding:8px 12px;background:rgba(239,68,68,0.08);border-radius:6px;color:#94a3b8;font-size:0.8rem;">${deactivated.length} keyword${deactivated.length > 1 ? 's' : ''} will be deactivated.</div>`;
            }

            const overlay = document.createElement('div');
            overlay.id = 'km-role-config';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10001;display:flex;align-items:center;justify-content:center;';
            overlay.innerHTML = `
                <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;max-width:600px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <h3 style="color:#e2e8f0;margin-bottom:12px;">Configure Keywords (${activated.length} activating)</h3>
                    ${html}
                    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:16px;">
                        <button onclick="document.getElementById('km-role-config').remove()" style="padding:8px 16px;background:transparent;color:#94a3b8;border:1px solid rgba(71,85,105,0.5);border-radius:6px;cursor:pointer;font-size:0.85rem;">Cancel</button>
                        <button onclick="confirmRoleSave()" style="padding:8px 20px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.85rem;">Confirm & Save</button>
                    </div>
                </div>
            `;
            overlay.dataset.activated = JSON.stringify(activated);
            overlay.dataset.deactivated = JSON.stringify(deactivated);
            overlay.dataset.changes = JSON.stringify(changes);
            document.body.appendChild(overlay);
        }

        function kmRoleSelChanged(idx) {
            const role = document.getElementById('km-role-' + idx).value;
            document.getElementById('km-parent-' + idx).style.display = role === 'secondary' ? 'block' : 'none';
        }

        async function confirmRoleSave() {
            const overlay = document.getElementById('km-role-config');
            const activated = JSON.parse(overlay.dataset.activated);
            const deactivated = JSON.parse(overlay.dataset.deactivated);
            const changes = JSON.parse(overlay.dataset.changes);

            const roles = [];
            activated.forEach((kw, i) => {
                const role = document.getElementById('km-role-' + i).value;
                const silo = document.getElementById('km-silo-' + i).value;
                const parent = role === 'secondary' ? document.getElementById('km-parent-' + i).value : '';
                roles.push({keyword: kw, role, parent_keyword: parent, silo});
            });

            const missingParent = roles.find(r => r.role === 'secondary' && !r.parent_keyword);
            if (missingParent) {
                alert(`Please select a primary keyword for "${missingParent.keyword}"`);
                return;
            }

            overlay.remove();
            await executeSave(activated, deactivated, changes, roles);
        }

        async function executeSave(activated, deactivated, changes, roles) {
            const btn = document.getElementById('km-save-btn');
            btn.textContent = 'Saving...';
            btn.disabled = true;

            try {
                if (activated.length) {
                    for (let i = 0; i < activated.length; i += 200) {
                        const batch = activated.slice(i, i + 200);
                        const resp = await fetch('/api/keywords/priority/toggle', {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({keywords: batch, active: true})
                        });
                        const data = await resp.json();
                        if (!data.success) throw new Error(data.error);
                    }
                }

                if (deactivated.length) {
                    for (let i = 0; i < deactivated.length; i += 200) {
                        const batch = deactivated.slice(i, i + 200);
                        const resp = await fetch('/api/keywords/priority/toggle', {
                            method: 'PUT',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({keywords: batch, active: false})
                        });
                        const data = await resp.json();
                        if (!data.success) throw new Error(data.error);
                    }
                }

                // Update roles if any were set
                if (roles.length) {
                    const resp = await fetch('/api/keywords/priority/roles', {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({roles})
                    });
                    const data = await resp.json();
                    if (!data.success) throw new Error(data.error);

                    for (const r of roles) {
                        const kw = kmAllKeywords.find(k => k.keyword === r.keyword);
                        if (kw) {
                            kw.is_primary = r.role === 'primary';
                            kw.parent_keyword = r.parent_keyword || '';
                            if (r.role === 'secondary') kw.secondary_of = [r.parent_keyword];
                        }
                    }
                }

                for (const [kw, active] of Object.entries(changes)) {
                    kmOriginalState[kw] = active;
                }
                kmPendingChanges = {};
                updateSaveButton();
                filterKmKeywords();

                kmDashboardDirty = true;
                showKmSaveSummary(activated, deactivated);

            } catch (e) {
                alert('Error saving: ' + e.message);
                btn.textContent = 'Save Changes';
                btn.disabled = false;
            }
        }

        function showKmSaveSummary(activated, deactivated) {
            // Check which activated keywords have BQ data
            const activatedWithBQ = activated.filter(kw => {
                const k = kmAllKeywords.find(x => x.keyword === kw);
                return k && k.in_bigquery;
            });
            const activatedNoBQ = activated.filter(kw => {
                const k = kmAllKeywords.find(x => x.keyword === kw);
                return !k || !k.in_bigquery;
            });

            // Build summary content
            let html = '<div style="max-height:60vh;overflow-y:auto;">';

            if (activated.length) {
                html += `<div style="margin-bottom:16px;">`;
                html += `<h4 style="color:#10b981;margin-bottom:8px;">Added to Priority (${activated.length})</h4>`;
                html += `<div style="background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.3);border-radius:8px;padding:12px;max-height:200px;overflow-y:auto;">`;
                html += activated.map(kw => {
                    const hasBQ = activatedWithBQ.includes(kw);
                    return `<div style="padding:3px 0;color:#e2e8f0;font-size:0.85rem;">${kw}${hasBQ ? ' <span style="color:#10b981;font-size:0.75rem;">(has historical data)</span>' : ''}</div>`;
                }).join('');
                html += `</div>`;
                if (activatedWithBQ.length) {
                    html += `<div style="margin-top:8px;padding:8px 12px;background:rgba(16,185,129,0.08);border-radius:6px;color:#10b981;font-size:0.8rem;">${activatedWithBQ.length} keyword${activatedWithBQ.length > 1 ? 's have' : ' has'} existing historical data. Results will show immediately in the next domination audit run.</div>`;
                }
                if (activatedNoBQ.length) {
                    html += `<div style="margin-top:6px;padding:8px 12px;background:rgba(245,158,11,0.08);border-radius:6px;color:#f59e0b;font-size:0.8rem;">${activatedNoBQ.length} keyword${activatedNoBQ.length > 1 ? 's are' : ' is'} not yet tracked in BigQuery ‚Äî data will appear once SERP tracking begins.</div>`;
                }
                html += `</div>`;
            }

            if (deactivated.length) {
                const deactivatedWithBQ = deactivated.filter(kw => {
                    const k = kmAllKeywords.find(x => x.keyword === kw);
                    return k && k.in_bigquery;
                });

                html += `<div style="margin-bottom:16px;">`;
                html += `<h4 style="color:#ef4444;margin-bottom:8px;">Removed from Priority (${deactivated.length})</h4>`;
                html += `<div style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:12px;max-height:200px;overflow-y:auto;">`;
                html += deactivated.map(kw => {
                    const hasBQ = deactivatedWithBQ.includes(kw);
                    return `<div style="padding:3px 0;color:#e2e8f0;font-size:0.85rem;">${kw}${hasBQ ? ' <span style="color:#f59e0b;font-size:0.75rem;">(has historical data)</span>' : ''}</div>`;
                }).join('');
                html += `</div>`;
                html += `<div style="margin-top:8px;padding:8px 12px;background:rgba(239,68,68,0.08);border-radius:6px;color:#94a3b8;font-size:0.8rem;">These keywords will be excluded from the next domination audit run.</div>`;
                if (deactivatedWithBQ.length) {
                    html += `<div style="margin-top:6px;padding:8px 12px;background:rgba(245,158,11,0.08);border-radius:6px;color:#f59e0b;font-size:0.8rem;">${deactivatedWithBQ.length} keyword${deactivatedWithBQ.length > 1 ? 's have' : ' has'} historical data that will no longer be visible in audits. You can re-add ${deactivatedWithBQ.length > 1 ? 'them' : 'it'} anytime to restore visibility.</div>`;
                }
                html += `</div>`;
            }

            html += '</div>';

            // Create overlay
            const overlay = document.createElement('div');
            overlay.id = 'km-save-summary';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:10001;display:flex;align-items:center;justify-content:center;';
            overlay.innerHTML = `
                <div style="background:#1e293b;border:1px solid #334155;border-radius:12px;padding:24px;max-width:500px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <h3 style="color:#e2e8f0;margin-bottom:16px;">Changes Saved</h3>
                    ${html}
                    <div style="text-align:right;margin-top:16px;">
                        <button onclick="document.getElementById('km-save-summary').remove()" style="padding:8px 20px;background:#8b5cf6;color:white;border:none;border-radius:6px;cursor:pointer;font-size:0.9rem;">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function kmSearchInput() {
            filterKmKeywords();
            const val = (document.getElementById('km-search').value || '').trim().toLowerCase();
            const addBtn = document.getElementById('km-add-btn');
            if (val.length >= 2 && !kmAllKeywords.find(k => k.keyword === val)) {
                addBtn.style.display = 'block';
                addBtn.textContent = '+ Add "' + (val.length > 20 ? val.substring(0, 20) + '...' : val) + '"';
            } else {
                addBtn.style.display = 'none';
                hideAddKeywordForm();
            }
        }

        function kmSearchEnter() {
            const val = (document.getElementById('km-search').value || '').trim().toLowerCase();
            if (val.length >= 2 && !kmAllKeywords.find(k => k.keyword === val)) {
                showAddKeywordForm();
            }
        }

        function showAddKeywordForm() {
            const val = (document.getElementById('km-search').value || '').trim().toLowerCase();
            if (val.length < 2) return;
            document.getElementById('km-add-kw-label').textContent = '"' + val + '"';
            document.getElementById('km-add-role').value = 'none';
            document.getElementById('km-add-silo').value = '';
            document.getElementById('km-add-parent').style.display = 'none';
            document.getElementById('km-add-auto-info').textContent = '';
            // Populate parent keyword dropdown with all primary keywords
            const parentSelect = document.getElementById('km-add-parent');
            const primaries = kmAllKeywords.filter(k => k.is_primary).sort((a,b) => a.keyword.localeCompare(b.keyword));
            parentSelect.innerHTML = '<option value="">Select primary keyword...</option>' +
                primaries.map(p => `<option value="${p.keyword}">${p.keyword}</option>`).join('');
            document.getElementById('km-add-form').style.display = 'block';
        }

        function hideAddKeywordForm() {
            document.getElementById('km-add-form').style.display = 'none';
        }

        function kmAddRoleChanged() {
            const role = document.getElementById('km-add-role').value;
            const parentSelect = document.getElementById('km-add-parent');
            const info = document.getElementById('km-add-auto-info');
            if (role === 'secondary') {
                parentSelect.style.display = 'block';
                info.textContent = 'Tier & score will inherit from parent primary';
            } else if (role === 'primary') {
                parentSelect.style.display = 'none';
                info.textContent = 'Will be auto-activated as primary keyword';
            } else {
                parentSelect.style.display = 'none';
                info.textContent = '';
            }
        }

        async function addCustomKeyword() {
            const input = document.getElementById('km-search');
            const keyword = (input.value || '').trim().toLowerCase();
            if (!keyword || keyword.length < 2) return;

            const existing = kmAllKeywords.find(k => k.keyword === keyword);
            if (existing) {
                document.getElementById('km-status').textContent = `"${keyword}" already exists`;
                setTimeout(() => { document.getElementById('km-status').textContent = ''; }, 2000);
                return;
            }

            const role = document.getElementById('km-add-role').value;
            const silo = document.getElementById('km-add-silo').value;
            const parentKw = role === 'secondary' ? document.getElementById('km-add-parent').value : '';

            if (!silo) {
                alert('Please select a silo for this keyword');
                return;
            }

            if (role === 'secondary' && !parentKw) {
                alert('Please select a primary keyword for this secondary keyword');
                return;
            }

            try {
                const resp = await fetch('/api/keywords/priority/custom', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword, role, parent_keyword: parentKw, silo})
                });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error);

                // Add to local state with returned values
                const siloLabels = {id_theft:'ID Theft',dog:'Dog',data_broker:'Data Broker',parental_control:'Parental Control',new:''};
                const newKw = {
                    keyword, tier: data.tier || 'custom', niche: data.niche || siloLabels[silo] || '',
                    priority_score: data.priority_score || 0,
                    search_volume: 0, source: 'custom', is_active: true,
                    added_by: '', in_bigquery: false,
                    is_primary: data.is_primary || false,
                    parent_keyword: data.parent_keyword || '',
                    secondary_of: parentKw ? [parentKw] : [],
                    secondaries: []
                };
                kmAllKeywords.push(newKw);

                // If secondary, add to parent's secondaries list
                if (parentKw) {
                    const parent = kmAllKeywords.find(k => k.keyword === parentKw);
                    if (parent && parent.secondaries) parent.secondaries.push(keyword);
                }

                kmOriginalState[keyword] = true;
                delete kmPendingChanges[keyword];
                updateSaveButton();

                input.value = '';
                document.getElementById('km-add-btn').style.display = 'none';
                hideAddKeywordForm();
                filterKmKeywords();

                const roleLabel = role === 'primary' ? ' as primary' : role === 'secondary' ? ` as secondary of "${parentKw}"` : '';
                document.getElementById('km-status').textContent = `Added "${keyword}"${roleLabel}`;
                setTimeout(() => { document.getElementById('km-status').textContent = ''; }, 3000);
                kmDashboardDirty = true;
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadContentPlannerData() {
            const btn = document.getElementById('load-planner-btn');
            const btnText = document.getElementById('planner-btn-text');
            const spinner = document.getElementById('planner-spinner');

            btn.disabled = true;
            btnText.textContent = 'Loading...';
            spinner.style.display = 'inline-block';

            try {
                // Try to use existing domination data first, or fetch from DB
                if (!dominationData) {
                    const response = await fetch('/api/domination/data');
                    const data = await response.json();
                    if (data.success) {
                        dominationData = data.audit_data;
                    }
                }

                if (!dominationData || !dominationData.all_results) {
                    alert('No ranking data found. Load data in the Domination Score tab first.');
                    return;
                }

                displayContentPlannerData(dominationData);
            } catch (error) {
                console.error('Error loading content planner data:', error);
                alert('Error loading data: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üìä Load Content Plan';
                spinner.style.display = 'none';
            }
        }

        function displayContentPlannerData(data) {
            // Build revenue lookup from ranking and not_ranking lists (same as Domination Score tab)
            const revenueMap = {};
            if (data.ranking) {
                data.ranking.forEach(r => {
                    revenueMap[r.keyword.toLowerCase()] = r.revenue || 0;
                });
            }
            if (data.not_ranking) {
                data.not_ranking.forEach(r => {
                    revenueMap[r.keyword.toLowerCase()] = r.revenue || 0;
                });
            }

            // Process all keywords with their domination scores
            const plannerKeywords = [];

            for (const result of data.all_results) {
                const keyword = result.keyword;
                const domScore = calculateDominationScore(result);

                // Find revenue from ranking/not_ranking lists
                const revenue = revenueMap[keyword.toLowerCase()] || 0;

                // Calculate videos needed
                const videosInfo = calculateVideosNeeded(domScore.score);

                // Get channel recommendations (pass keyword for niche detection)
                const channelRecs = getChannelRecommendations(result.top_10, domScore.score, keyword);

                // Calculate money left on table
                let leftOnTable = 0;
                if (domScore.score > 0 && revenue > 0) {
                    const potentialRevenue = revenue / (domScore.score / 100);
                    leftOnTable = potentialRevenue - revenue;
                } else if (domScore.score === 0 && revenue > 0) {
                    leftOnTable = revenue * 5; // Assume 10x potential if not ranking
                }

                plannerKeywords.push({
                    keyword: keyword,
                    domination: domScore.score,
                    revenue: revenue,
                    leftOnTable: leftOnTable,
                    videosNeeded: videosInfo.count,
                    videosLabel: videosInfo.label,
                    priority: videosInfo.priority,
                    priorityColor: videosInfo.color,
                    channelRecs: channelRecs.recommendations,
                    inTop5: channelRecs.inTop5,
                    notInTop5: channelRecs.notInTop5,
                    niche: channelRecs.niche,
                    top10: result.top_10 || []
                });
            }

            // Store for sorting
            plannerKeywordsData = plannerKeywords;

            // Sort by default (domination ascending - lowest first)
            plannerKeywordsData = sortTableData(plannerKeywordsData, plannerSortColumn, plannerSortDirection);

            // Calculate stats
            const totalVideosNeeded = plannerKeywords.reduce((sum, k) => sum + k.videosNeeded, 0);
            const totalRevenueAtRisk = plannerKeywords.reduce((sum, k) => sum + k.leftOnTable, 0);
            const keywordsAt100 = plannerKeywords.filter(k => k.domination >= 100).length;
            const keywordsBelow75 = plannerKeywords.filter(k => k.domination < 75).length;

            const criticalCount = plannerKeywords.filter(k => k.priority === 'critical').length;
            const highCount = plannerKeywords.filter(k => k.priority === 'high').length;
            const mediumCount = plannerKeywords.filter(k => k.priority === 'medium' || k.priority === 'low').length;
            const maintainCount = plannerKeywords.filter(k => k.priority === 'maintain').length;

            // Update stats display
            document.getElementById('total-videos-needed').textContent = totalVideosNeeded;
            document.getElementById('total-revenue-at-risk').textContent = '$' + Math.round(totalRevenueAtRisk).toLocaleString();
            document.getElementById('keywords-at-100').textContent = keywordsAt100;
            document.getElementById('keywords-below-75').textContent = keywordsBelow75;

            document.getElementById('critical-count').textContent = criticalCount;
            document.getElementById('high-count').textContent = highCount;
            document.getElementById('medium-count').textContent = mediumCount;
            document.getElementById('maintain-count').textContent = maintainCount;

            // Show UI elements
            document.getElementById('planner-stats').style.display = 'grid';
            document.getElementById('planner-table-container').style.display = 'block';
            document.getElementById('priority-breakdown').style.display = 'block';
            document.getElementById('planner-empty-state').style.display = 'none';
            document.getElementById('planner-results-count').textContent = plannerKeywords.length + ' keywords';

            // Render table
            renderPlannerTable(plannerKeywordsData);

            // Setup sorting for planner table
            setupPlannerTableSorting();
        }

        function setupPlannerTableSorting() {
            document.querySelectorAll('#planner-table th[data-sort]').forEach(th => {
                th.style.cursor = 'pointer';
                th.onclick = function() {
                    const column = this.dataset.sort;

                    // Update sort state
                    if (plannerSortColumn === column) {
                        plannerSortDirection = plannerSortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        plannerSortColumn = column;
                        plannerSortDirection = 'desc';
                    }

                    // Update header styles
                    document.querySelectorAll('#planner-table th').forEach(h => {
                        h.classList.remove('sorted', 'asc');
                    });
                    this.classList.add('sorted');
                    if (plannerSortDirection === 'asc') this.classList.add('asc');

                    // Sort and re-render
                    plannerKeywordsData = sortTableData(plannerKeywordsData, plannerSortColumn, plannerSortDirection);
                    renderPlannerTable(plannerKeywordsData);
                };
            });
        }

        function renderPlannerTable(keywords) {
            const tbody = document.getElementById('planner-table-body');

            if (keywords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#94a3b8;">No keywords to plan</td></tr>';
                return;
            }

            tbody.innerHTML = keywords.map(k => {
                // Score color
                let scoreColor = '#f87171';
                if (k.domination >= 75) scoreColor = '#4ade80';
                else if (k.domination >= 50) scoreColor = '#60a5fa';
                else if (k.domination >= 25) scoreColor = '#fbbf24';
                else if (k.domination > 0) scoreColor = '#fb923c';

                // Left on table display
                let leftOnTableDisplay = '$' + Math.round(k.leftOnTable).toLocaleString();
                if (k.domination === 0 && k.revenue > 0) {
                    leftOnTableDisplay = '‚àû (not ranking)';
                }

                // Channel recommendations
                const recsHtml = k.channelRecs.map(r => `<div style="font-size:0.75rem;color:#94a3b8;margin-bottom:2px;">${r}</div>`).join('');

                return `
                    <tr style="border-bottom:1px solid rgba(71,85,105,0.3);">
                        <td style="padding:12px;">
                            <div style="font-weight:600;color:#e2e8f0;">${k.keyword}</div>
                        </td>
                        <td style="padding:12px;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div style="width:60px;height:8px;background:rgba(71,85,105,0.5);border-radius:4px;overflow:hidden;">
                                    <div style="width:${k.domination}%;height:100%;background:${scoreColor};border-radius:4px;"></div>
                                </div>
                                <span style="color:${scoreColor};font-weight:700;font-size:0.9rem;">${k.domination}%</span>
                            </div>
                        </td>
                        <td style="padding:12px;text-align:right;color:#4ade80;font-weight:600;">$${k.revenue.toLocaleString()}</td>
                        <td style="padding:12px;text-align:right;color:#fbbf24;font-weight:600;">${leftOnTableDisplay}</td>
                        <td style="padding:12px;text-align:center;">
                            <div style="display:flex;flex-direction:column;align-items:center;gap:4px;">
                                <span style="font-size:1.5rem;font-weight:700;color:${k.priorityColor};">${k.videosNeeded}</span>
                                <span style="font-size:0.7rem;color:#64748b;">${k.videosLabel}</span>
                            </div>
                        </td>
                        <td style="padding:12px;">
                            ${recsHtml}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // ============================================
        // $3K OPPORTUNITY FINDER
        // ============================================
        let opportunityData = [];
        let filteredOpportunities = [];
        let oppDisplayLimit = 25;
        let currentOppFilter = 'all';

        async function loadOpportunities() {
            const btn = document.getElementById('opp-load-btn');
            const btnText = document.getElementById('opp-btn-text');
            const spinner = document.getElementById('opp-spinner');

            btn.disabled = true;
            btnText.textContent = 'Analyzing...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/opportunity-finder');
                const data = await response.json();

                if (data.success) {
                    opportunityData = data.opportunities;
                    filteredOpportunities = [...opportunityData];

                    // Update summary
                    document.getElementById('opp-above-target').textContent = data.summary.above_target;
                    document.getElementById('opp-above-1k').textContent = data.summary.above_1k;
                    document.getElementById('opp-above-500').textContent = data.summary.above_500;
                    document.getElementById('opp-top10-revenue').textContent = '$' + Math.round(data.summary.top_10_combined_revenue).toLocaleString();
                    document.getElementById('opp-top10-feasibility').textContent = data.summary.top_10_feasibility_avg + '/100';
                    document.getElementById('opp-total').textContent = data.summary.total_keywords.toLocaleString();

                    // Goal status
                    const top10Rev = data.summary.top_10_combined_revenue;
                    const goalPct = Math.min(100, (top10Rev / 30000 * 100)).toFixed(0);
                    const goalEl = document.getElementById('opp-goal-status');
                    if (top10Rev >= 30000) {
                        goalEl.innerHTML = `<span style="color:#4ade80;">Your top 10 keywords already estimate $${Math.round(top10Rev).toLocaleString()}/mo ‚Äî above the $30K goal!</span>`;
                    } else {
                        goalEl.innerHTML = `Top 10 keywords estimate $${Math.round(top10Rev).toLocaleString()}/mo (${goalPct}% of $30K goal). Gap: <strong style="color:#f97316;">$${Math.round(30000 - top10Rev).toLocaleString()}/mo</strong>`;
                    }

                    // Render clusters
                    renderNicheClusters(data.clusters || []);

                    // Show results, hide empty state
                    document.getElementById('opp-summary').style.display = 'block';
                    document.getElementById('opp-empty-state').style.display = 'none';

                    // Reset filter to all
                    currentOppFilter = 'all';
                    document.querySelectorAll('.opp-filter-btn').forEach(b => b.classList.remove('active'));
                    document.querySelector('[data-opp-filter="all"]').classList.add('active');

                    // Render cards
                    oppDisplayLimit = 25;
                    renderOpportunityCards();
                }
            } catch (error) {
                console.error('Opportunity finder error:', error);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üîç Analyze All Keywords';
                spinner.style.display = 'none';
            }
        }

        function renderNicheClusters(clusters) {
            const grid = document.getElementById('opp-clusters-grid');
            if (!clusters.length) { grid.innerHTML = '<p style="color:#64748b;">No cluster data.</p>'; return; }

            grid.innerHTML = clusters.map(c => {
                const pct3k = Math.min(100, (c.totalRevenue / 3000 * 100));
                let barColor = '#f87171';
                if (pct3k >= 100) barColor = '#4ade80';
                else if (pct3k >= 50) barColor = '#60a5fa';
                else if (pct3k >= 20) barColor = '#fbbf24';

                return `
                <div style="background:rgba(15,23,42,0.6);padding:16px;border-radius:12px;border:1px solid rgba(148,163,184,0.1);">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong style="color:#e2e8f0;text-transform:capitalize;">${c.niche.replace(/_/g, ' ')}</strong>
                        <span style="font-size:0.75rem;color:#64748b;">${c.count} keywords</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:8px;">
                        <span style="color:#4ade80;">$${Math.round(c.totalRevenue).toLocaleString()}/mo</span>
                        <span style="color:#a78bfa;">Upside: $${Math.round(c.totalUpside).toLocaleString()}</span>
                    </div>
                    <div style="height:6px;background:rgba(71,85,105,0.5);border-radius:3px;overflow:hidden;margin-bottom:8px;">
                        <div style="width:${pct3k}%;height:100%;background:${barColor};border-radius:3px;"></div>
                    </div>
                    <div style="font-size:0.7rem;color:#64748b;">
                        Avg feasibility: ${c.avgFeasibility} | Avg/kw: $${Math.round(c.revenuePerKeyword).toLocaleString()}
                    </div>
                    <div style="font-size:0.7rem;color:#94a3b8;margin-top:4px;">
                        Best: ${escapeHtml(c.bestKeyword)} ($${Math.round(c.bestRevenue).toLocaleString()})
                    </div>
                </div>`;
            }).join('');
        }

        function filterOpportunities(filter, btnEl) {
            currentOppFilter = filter;
            document.querySelectorAll('.opp-filter-btn').forEach(b => b.classList.remove('active'));
            if (btnEl) btnEl.classList.add('active');

            switch (filter) {
                case 'all':
                    filteredOpportunities = [...opportunityData];
                    break;
                case 'top10':
                    filteredOpportunities = opportunityData.slice(0, 10);
                    break;
                case 'top25':
                    filteredOpportunities = opportunityData.slice(0, 25);
                    break;
                case 'realistic':
                    filteredOpportunities = opportunityData.filter(o => o.estRevenue >= 1000);
                    break;
                case 'rising':
                    filteredOpportunities = opportunityData.filter(o => o.trend === 'rising');
                    break;
                case 'deal':
                    filteredOpportunities = opportunityData.filter(o => o.keywordType === 'deal');
                    break;
                case 'comparison':
                    filteredOpportunities = opportunityData.filter(o => o.keywordType === 'comparison');
                    break;
                case 'lowcomp':
                    filteredOpportunities = opportunityData.filter(o => {
                        const comp = parseFloat(o.competition) || 0;
                        const rev = parseFloat(o.estRevenue) || 0;
                        const pattern = o.pattern || 'no_data';
                        const lowComp = comp < 0.3 || pattern === 'distributed';
                        return lowComp && rev >= 100;
                    });
                    filteredOpportunities.sort((a, b) => (b.estRevenue || 0) - (a.estRevenue || 0));
                    break;
            }

            oppDisplayLimit = 25;
            renderOpportunityCards();
        }

        function showMoreOpportunities() {
            oppDisplayLimit += 25;
            renderOpportunityCards();
        }

        function renderOpportunityCards() {
            const container = document.getElementById('opp-cards-container');
            const showing = filteredOpportunities.slice(0, oppDisplayLimit);

            document.getElementById('opp-showing-count').textContent =
                `Showing ${showing.length} of ${filteredOpportunities.length}`;

            // Show/hide "show more" button
            const showMore = document.getElementById('opp-show-more');
            showMore.style.display = showing.length < filteredOpportunities.length ? 'block' : 'none';

            if (showing.length === 0) {
                container.innerHTML = '<div class="research-box" style="text-align:center;padding:40px;color:#94a3b8;">No keywords match this filter.</div>';
                return;
            }

            container.innerHTML = showing.map((opp, idx) => {
                // Feasibility color
                let fColor = '#f87171';
                if (opp.feasibility >= 75) fColor = '#4ade80';
                else if (opp.feasibility >= 55) fColor = '#60a5fa';
                else if (opp.feasibility >= 40) fColor = '#fbbf24';
                else if (opp.feasibility >= 25) fColor = '#f97316';

                // Rank badge color
                let rankBg = 'rgba(71,85,105,0.5)';
                let rankColor = '#94a3b8';
                if (opp.rank <= 3) { rankBg = 'rgba(74,222,128,0.2)'; rankColor = '#4ade80'; }
                else if (opp.rank <= 10) { rankBg = 'rgba(96,165,250,0.2)'; rankColor = '#60a5fa'; }
                else if (opp.rank <= 25) { rankBg = 'rgba(251,191,36,0.2)'; rankColor = '#fbbf24'; }

                // Gap bar percentage (capped at 100%)
                const gapPct = Math.min(100, opp.gapPercentage);
                let gapColor = '#f87171';
                if (gapPct >= 100) gapColor = '#4ade80';
                else if (gapPct >= 50) gapColor = '#60a5fa';
                else if (gapPct >= 20) gapColor = '#fbbf24';

                // Keyword type badge
                const typeColors = {
                    'deal': '#4ade80', 'comparison': '#a78bfa', 'review': '#60a5fa',
                    'best_of': '#fbbf24', 'informational': '#94a3b8', 'other': '#cbd5e1'
                };
                const typeColor = typeColors[opp.keywordType] || '#cbd5e1';

                // Pattern badge
                const patternColors = {
                    'distributed': '#4ade80', 'top_heavy': '#fbbf24',
                    'winner_take_all': '#f87171', 'no_data': '#94a3b8'
                };
                const patternColor = patternColors[opp.pattern] || '#94a3b8';

                // Trend indicator
                let trendHtml = '';
                if (opp.trend === 'rising') {
                    trendHtml = `<span style="color:#4ade80;">‚Üë Rising${opp.trendChange ? ' +' + opp.trendChange + '%' : ''}</span>`;
                } else if (opp.trend === 'stable') {
                    trendHtml = `<span style="color:#60a5fa;">‚Üí Stable</span>`;
                } else if (opp.trend === 'declining') {
                    trendHtml = `<span style="color:#f87171;">‚Üì Declining${opp.trendChange ? ' ' + opp.trendChange + '%' : ''}</span>`;
                } else {
                    trendHtml = `<span style="color:#64748b;">? Unknown</span>`;
                }

                // Levers
                const leversHtml = opp.levers.map(l => `<span class="opp-lever">${escapeHtml(l)}</span>`).join(' ');

                // Vote indicator
                let voteHtml = '';
                if (opp.voteScore > 0) voteHtml = `<span style="color:#4ade80;font-size:0.75rem;">‚ñ≤${opp.voteScore}</span>`;
                else if (opp.voteScore < 0) voteHtml = `<span style="color:#f87171;font-size:0.75rem;">‚ñº${Math.abs(opp.voteScore)}</span>`;

                // Label badge
                let labelHtml = '';
                if (opp.label === 'interested') labelHtml = '<span style="background:rgba(74,222,128,0.2);color:#4ade80;padding:1px 6px;border-radius:4px;font-size:0.65rem;">interested</span>';
                else if (opp.label === 'maybe') labelHtml = '<span style="background:rgba(251,191,36,0.2);color:#fbbf24;padding:1px 6px;border-radius:4px;font-size:0.65rem;">maybe</span>';
                else if (opp.favorite) labelHtml = '<span style="font-size:0.75rem;">‚≠ê</span>';

                return `
                <div class="opp-card">
                    <div class="opp-card-header">
                        <div style="display:flex;align-items:center;gap:12px;">
                            <div class="opp-card-rank" style="background:${rankBg};color:${rankColor};">#${opp.rank}</div>
                            <div>
                                <div style="font-weight:600;font-size:1rem;color:#e2e8f0;">
                                    ${escapeHtml(opp.keyword)}
                                    ${voteHtml} ${labelHtml}
                                </div>
                                <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;">
                                    <span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:${typeColor}22;color:${typeColor};border:1px solid ${typeColor}44;">${opp.keywordType.replace(/_/g, ' ')}</span>
                                    <span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:rgba(148,163,184,0.1);color:#94a3b8;">${opp.niche.replace(/_/g, ' ')}</span>
                                    ${opp.nicheMult > 1 ? `<span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:rgba(74,222,128,0.1);color:#4ade80;">${opp.nicheMult}x niche</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div style="text-align:right;">
                            <div style="display:flex;align-items:center;gap:8px;">
                                <div class="feasibility-bar">
                                    <div class="feasibility-fill" style="width:${opp.feasibility}%;background:${fColor};"></div>
                                </div>
                                <span style="font-weight:700;font-size:1.1rem;color:${fColor};">${opp.feasibility}</span>
                            </div>
                            <div style="font-size:0.65rem;color:#64748b;margin-top:2px;">Feasibility Score</div>
                        </div>
                    </div>

                    <!-- Revenue Progress Bar -->
                    <div style="margin-bottom:14px;">
                        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                            <span style="font-size:0.75rem;color:#94a3b8;">Revenue vs $3K target</span>
                            <span style="font-size:0.75rem;font-weight:600;color:${gapColor};">$${Math.round(opp.estRevenue).toLocaleString()}/mo (${gapPct.toFixed(0)}%)</span>
                        </div>
                        <div class="opp-gap-bar">
                            <div class="opp-gap-fill" style="width:${gapPct}%;background:${gapColor};"></div>
                            ${gapPct < 95 ? `<span class="opp-gap-target">$3K</span>` : ''}
                        </div>
                        ${opp.upsideRevenue > opp.estRevenue ? `<div style="font-size:0.7rem;color:#64748b;margin-top:4px;">Upside (75th pct EPV): <span style="color:#a78bfa;">$${Math.round(opp.upsideRevenue).toLocaleString()}/mo</span></div>` : ''}
                    </div>

                    <!-- Metrics Grid -->
                    <div class="opp-card-metrics">
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:#e2e8f0;">${opp.volume ? opp.volume.toLocaleString() : 'N/A'}</div>
                            <div class="opp-metric-label">Search Volume</div>
                        </div>
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:#4ade80;">$${opp.epv.toFixed(2)}</div>
                            <div class="opp-metric-label">EPV ($/visitor)</div>
                        </div>
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:#60a5fa;">${opp.captureRate}%</div>
                            <div class="opp-metric-label">Capture Rate</div>
                        </div>
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:${patternColor};">${(opp.pattern || 'no data').replace(/_/g, ' ')}</div>
                            <div class="opp-metric-label">Competition</div>
                        </div>
                        <div class="opp-metric">
                            <div class="opp-metric-value">${(opp.willingness * 100).toFixed(0)}%</div>
                            <div class="opp-metric-label">Buyer Intent</div>
                        </div>
                        <div class="opp-metric">
                            <div class="opp-metric-value">${trendHtml}</div>
                            <div class="opp-metric-label">Google Trend</div>
                        </div>
                        ${opp.domScore > 0 ? `
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:#fbbf24;">${opp.domScore}%</div>
                            <div class="opp-metric-label">Domination</div>
                        </div>` : ''}
                        ${opp.volumeNeeded ? `
                        <div class="opp-metric">
                            <div class="opp-metric-value" style="color:${opp.volume >= opp.volumeNeeded ? '#4ade80' : '#f97316'};">${Math.round(opp.volumeNeeded).toLocaleString()}</div>
                            <div class="opp-metric-label">Volume Needed for $3K</div>
                        </div>` : ''}
                    </div>

                    <!-- Levers to Pull -->
                    ${leversHtml ? `
                    <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(71,85,105,0.3);">
                        <span style="font-size:0.7rem;color:#64748b;margin-right:4px;">Key actions:</span>
                        ${leversHtml}
                    </div>` : ''}
                </div>
                `;
            }).join('');
        }

        // ============================================
        // SMART PICKS
        // ============================================
        let smartPicksData = [];
        let smartDisplayLimit = 20;

        async function loadSmartPicks() {
            const btn = document.getElementById('smart-load-btn');
            const btnText = document.getElementById('smart-btn-text');
            const spinner = document.getElementById('smart-spinner');
            const niche = document.getElementById('smart-niche-filter').value;

            btn.disabled = true;
            btnText.textContent = 'Finding best keywords...';
            spinner.style.display = 'block';

            try {
                const url = '/api/smart-picks' + (niche ? '?niche=' + niche : '');
                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    smartPicksData = data.picks;
                    smartDisplayLimit = 20;

                    // Niche overview cards
                    if (!niche && data.nicheSummary) {
                        renderNicheOverview(data.nicheSummary);
                        document.getElementById('smart-niche-overview').style.display = 'block';
                    } else {
                        document.getElementById('smart-niche-overview').style.display = 'none';
                    }

                    // Results header
                    const nicheLabel = niche ? niche.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'All Niches';
                    document.getElementById('smart-results-title').textContent =
                        'Top Picks' + (niche ? ' for ' + nicheLabel : '');
                    document.getElementById('smart-results-header').style.display = 'block';

                    renderSmartPicks();
                }
            } catch (error) {
                console.error('Smart picks error:', error);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Show Me the Best Keywords';
                spinner.style.display = 'none';
            }
        }

        function renderNicheOverview(nicheSummary) {
            const container = document.getElementById('smart-niche-cards');
            container.innerHTML = nicheSummary.map(n => {
                let scoreColor = '#f87171';
                if (n.avgScore >= 60) scoreColor = '#4ade80';
                else if (n.avgScore >= 45) scoreColor = '#60a5fa';
                else if (n.avgScore >= 30) scoreColor = '#fbbf24';

                return `
                <div style="background:rgba(15,23,42,0.6);padding:14px;border-radius:10px;border:1px solid rgba(148,163,184,0.1);cursor:pointer;transition:border-color 0.2s;"
                     onclick="document.getElementById('smart-niche-filter').value='${n.niche}';loadSmartPicks();"
                     onmouseover="this.style.borderColor='rgba(139,92,246,0.4)'"
                     onmouseout="this.style.borderColor='rgba(148,163,184,0.1)'">
                    <div style="font-weight:600;color:#e2e8f0;text-transform:capitalize;font-size:0.85rem;margin-bottom:6px;">${n.niche.replace(/_/g, ' ')}</div>
                    <div style="display:flex;justify-content:space-between;font-size:0.75rem;">
                        <span style="color:#64748b;">${n.count} keywords</span>
                        <span style="color:${scoreColor};font-weight:600;">Score: ${n.avgScore}</span>
                    </div>
                    <div style="font-size:0.7rem;color:#64748b;margin-top:4px;">Top: $${Math.round(n.topRevenue).toLocaleString()}/mo</div>
                </div>`;
            }).join('');
        }

        function sortSmartPicks(sortBy) {
            if (sortBy === 'revenue') {
                smartPicksData.sort((a, b) => b.revenue - a.revenue);
            } else if (sortBy === 'easy') {
                // Easy = distributed first, then by score
                const diffOrder = {'Easy': 0, 'Unknown': 1, 'Medium': 2, 'Hard': 3};
                smartPicksData.sort((a, b) => {
                    const da = diffOrder[a.difficulty] || 2;
                    const db = diffOrder[b.difficulty] || 2;
                    if (da !== db) return da - db;
                    return b.smartScore - a.smartScore;
                });
            } else {
                smartPicksData.sort((a, b) => b.smartScore - a.smartScore);
            }
            // Re-rank
            smartPicksData.forEach((p, i) => p.rank = i + 1);
            smartDisplayLimit = 20;
            renderSmartPicks();
        }

        function showMoreSmartPicks() {
            smartDisplayLimit += 20;
            renderSmartPicks();
        }

        function renderSmartPicks() {
            const container = document.getElementById('smart-picks-container');
            const showing = smartPicksData.slice(0, smartDisplayLimit);

            document.getElementById('smart-results-count').textContent =
                showing.length + ' of ' + smartPicksData.length + ' keywords';

            document.getElementById('smart-show-more').style.display =
                showing.length < smartPicksData.length ? 'block' : 'none';

            if (showing.length === 0) {
                container.innerHTML = '<div class="research-box" style="text-align:center;padding:40px;color:#94a3b8;">No keywords found for this niche.</div>';
                return;
            }

            container.innerHTML = showing.map(p => {
                // Score color
                let scoreColor = '#f87171';
                let scoreBg = 'rgba(248,113,113,0.1)';
                if (p.smartScore >= 75) { scoreColor = '#4ade80'; scoreBg = 'rgba(74,222,128,0.15)'; }
                else if (p.smartScore >= 55) { scoreColor = '#60a5fa'; scoreBg = 'rgba(96,165,250,0.15)'; }
                else if (p.smartScore >= 40) { scoreColor = '#fbbf24'; scoreBg = 'rgba(251,191,36,0.15)'; }
                else if (p.smartScore >= 25) { scoreColor = '#f97316'; scoreBg = 'rgba(249,115,22,0.15)'; }

                // Rank colors
                let rankBg = 'rgba(71,85,105,0.5)';
                let rankColor = '#94a3b8';
                if (p.rank <= 3) { rankBg = 'rgba(74,222,128,0.2)'; rankColor = '#4ade80'; }
                else if (p.rank <= 10) { rankBg = 'rgba(96,165,250,0.2)'; rankColor = '#60a5fa'; }
                else if (p.rank <= 25) { rankBg = 'rgba(251,191,36,0.2)'; rankColor = '#fbbf24'; }

                // Money display
                const moneyStr = '$'.repeat(p.moneyRating) + '<span style="opacity:0.2;">' + '$'.repeat(5 - p.moneyRating) + '</span>';

                // Difficulty class
                const diffClass = p.difficulty.toLowerCase();

                // Reasons
                const reasonsHtml = p.reasons.slice(0, 4).map(r =>
                    `<div class="smart-reason">${escapeHtml(r)}</div>`
                ).join('');

                // Video titles
                const titlesHtml = p.videoTitles.map((t, i) =>
                    `<div class="smart-video-title" style="${i > 0 ? 'margin-top:6px;' : ''}" onclick="navigator.clipboard.writeText(this.textContent.trim()).then(() => { this.style.borderColor='#4ade80'; setTimeout(() => this.style.borderColor='', 1000); })" title="Click to copy">
                        ${escapeHtml(t)}
                    </div>`
                ).join('');

                // Type badge
                const typeColors = {
                    'deal': '#4ade80', 'comparison': '#a78bfa', 'review': '#60a5fa',
                    'best_of': '#fbbf24', 'informational': '#94a3b8', 'other': '#cbd5e1'
                };
                const typeColor = typeColors[p.keywordType] || '#cbd5e1';

                // Trend
                let trendHtml = '';
                if (p.trend === 'rising') trendHtml = '<span style="color:#4ade80;font-size:0.75rem;">‚Üë Rising</span>';
                else if (p.trend === 'declining') trendHtml = '<span style="color:#f87171;font-size:0.75rem;">‚Üì Declining</span>';
                else if (p.trend === 'stable') trendHtml = '<span style="color:#60a5fa;font-size:0.75rem;">‚Üí Stable</span>';

                return `
                <div class="smart-card">
                    <div style="display:flex;gap:16px;align-items:flex-start;">
                        <!-- Left: Rank + Score -->
                        <div style="display:flex;flex-direction:column;align-items:center;gap:8px;min-width:50px;">
                            <div class="smart-rank" style="background:${rankBg};color:${rankColor};">#${p.rank}</div>
                            <div class="smart-score-ring" style="background:${scoreBg};color:${scoreColor};">
                                ${p.smartScore}
                            </div>
                        </div>

                        <!-- Center: Content -->
                        <div style="flex:1;min-width:0;">
                            <!-- Header row -->
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;flex-wrap:wrap;gap:8px;">
                                <div>
                                    <div style="font-weight:600;font-size:1.05rem;color:#e2e8f0;">
                                        ${escapeHtml(p.keyword)}
                                        ${p.voteScore > 0 ? '<span style="color:#4ade80;font-size:0.75rem;margin-left:6px;">‚ñ≤' + p.voteScore + '</span>' : ''}
                                    </div>
                                    <div style="display:flex;gap:6px;margin-top:4px;flex-wrap:wrap;align-items:center;">
                                        <span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:${typeColor}22;color:${typeColor};border:1px solid ${typeColor}44;">${p.keywordType.replace(/_/g, ' ')}</span>
                                        <span style="font-size:0.65rem;padding:2px 6px;border-radius:4px;background:rgba(148,163,184,0.1);color:#94a3b8;text-transform:capitalize;">${p.niche.replace(/_/g, ' ')}</span>
                                        ${trendHtml}
                                    </div>
                                </div>
                                <div style="display:flex;gap:12px;align-items:center;">
                                    <span class="smart-difficulty ${diffClass}">${p.difficulty}</span>
                                    <span class="smart-money" style="color:#4ade80;">${moneyStr}</span>
                                </div>
                            </div>

                            <!-- Quick stats -->
                            <div style="display:flex;gap:20px;margin-bottom:10px;font-size:0.8rem;flex-wrap:wrap;">
                                <span style="color:#4ade80;"><strong>$${Math.round(p.revenue).toLocaleString()}</strong><span style="color:#64748b;">/mo est.</span></span>
                                <span style="color:#e2e8f0;">${p.volume ? p.volume.toLocaleString() + ' searches/mo' : 'Volume unknown'}</span>
                                <span style="color:#94a3b8;">${Math.round(p.willingness * 100)}% buyer intent</span>
                            </div>

                            <!-- Why this keyword -->
                            <div style="margin-bottom:12px;">
                                ${reasonsHtml}
                            </div>

                            <!-- Video title suggestions -->
                            <div>
                                <div style="font-size:0.7rem;color:#64748b;margin-bottom:6px;">Suggested video titles (click to copy):</div>
                                ${titlesHtml}
                            </div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // ============================================
        // KEYWORD UNIVERSE MAP
        // ============================================
        let universeData = null;

        async function loadUniverse() {
            const btn = document.getElementById('universe-load-btn');
            const btnText = document.getElementById('universe-btn-text');
            const spinner = document.getElementById('universe-spinner');

            btn.disabled = true;
            btnText.textContent = 'Mapping...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/keyword-universe');
                const data = await response.json();

                if (data.success) {
                    universeData = data;

                    // Grand totals
                    const gt = data.grandTotals;
                    document.getElementById('ug-universe').textContent = gt.totalUniverse.toLocaleString();
                    document.getElementById('ug-existing').textContent = gt.totalExisting.toLocaleString();
                    document.getElementById('ug-gap').textContent = gt.totalGap.toLocaleString();
                    document.getElementById('ug-coverage').textContent = gt.coveragePct + '%';
                    document.getElementById('ug-gap-revenue').textContent = '$' + Math.round(gt.totalGapRevenue).toLocaleString() + '/mo';

                    // Coverage bar
                    const bar = document.getElementById('ug-coverage-bar');
                    bar.style.width = Math.max(2, gt.coveragePct) + '%';
                    bar.textContent = gt.coveragePct + '%';
                    bar.style.background = gt.coveragePct > 50 ? '#4ade80' : gt.coveragePct > 20 ? '#fbbf24' : '#f87171';
                    document.getElementById('ug-coverage-label').textContent =
                        gt.totalExisting.toLocaleString() + ' of ' + gt.totalUniverse.toLocaleString() + ' keywords';
                    document.getElementById('ug-coverage-label').style.color =
                        gt.coveragePct > 50 ? '#4ade80' : gt.coveragePct > 20 ? '#fbbf24' : '#f87171';
                    document.getElementById('ug-coverage-detail').textContent =
                        'Your CSV has ' + gt.csvTotal.toLocaleString() + ' keywords total. ' +
                        gt.totalExisting.toLocaleString() + ' match our generated universe. ' +
                        (gt.csvTotal - gt.totalExisting).toLocaleString() + ' are unique keywords outside our matrix (problem keywords, long-tail variations, etc.)';

                    // Render niche cards
                    renderUniverseNiches(data.niches);

                    // Show results
                    document.getElementById('universe-results').style.display = 'block';
                    document.getElementById('universe-empty-state').style.display = 'none';
                }
            } catch (error) {
                console.error('Universe map error:', error);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'üåê Map the Universe';
                spinner.style.display = 'none';
            }
        }

        function renderUniverseNiches(niches) {
            const container = document.getElementById('universe-niches-container');

            container.innerHTML = niches.map(n => {
                // Coverage color
                let covColor = '#f87171';
                if (n.coveragePct >= 50) covColor = '#4ade80';
                else if (n.coveragePct >= 20) covColor = '#fbbf24';
                else if (n.coveragePct >= 10) covColor = '#f97316';

                // Category bars
                const catOrder = ['comparisons', 'review', 'pricing', 'deal', 'alternative', 'best_of', 'cancel', 'setup', 'problems'];
                const catColors = {
                    'comparisons': '#a78bfa', 'review': '#60a5fa', 'pricing': '#4ade80',
                    'deal': '#fbbf24', 'alternative': '#f97316', 'best_of': '#f472b6',
                    'cancel': '#94a3b8', 'setup': '#38bdf8', 'problems': '#fb923c'
                };

                let catBarsHtml = '';
                for (const cat of catOrder) {
                    const cd = n.categories[cat];
                    if (!cd) continue;
                    const pct = cd.coverage_pct;
                    const color = catColors[cat] || '#94a3b8';
                    catBarsHtml += `
                    <div class="category-bar-container">
                        <span style="font-size:0.75rem;color:${color};text-transform:capitalize;">${cat.replace(/_/g, ' ')}</span>
                        <div class="cat-bar">
                            <div class="cat-bar-fill" style="width:${Math.max(1, pct)}%;background:${color};"></div>
                        </div>
                        <span style="font-size:0.7rem;color:${pct > 0 ? color : '#64748b'};">${cd.existing}/${cd.total}</span>
                    </div>`;
                }

                // Gap keyword chips
                let gapsHtml = '';
                if (n.topGaps && n.topGaps.length > 0) {
                    const gapsByCategory = {};
                    n.topGaps.forEach(g => {
                        if (!gapsByCategory[g.category]) gapsByCategory[g.category] = [];
                        gapsByCategory[g.category].push(g.keyword);
                    });

                    for (const [cat, kws] of Object.entries(gapsByCategory)) {
                        gapsHtml += `<div style="margin-top:6px;"><span style="font-size:0.65rem;color:#64748b;text-transform:capitalize;">${cat.replace(/_/g, ' ')}:</span> `;
                        gapsHtml += kws.slice(0, 5).map(k => `<span class="gap-keyword-chip">${escapeHtml(k)}</span>`).join('');
                        if (kws.length > 5) gapsHtml += `<span style="font-size:0.65rem;color:#64748b;"> +${kws.length - 5} more</span>`;
                        gapsHtml += '</div>';
                    }
                }

                // Revenue breakdown by category
                let revBreakdown = '';
                const sortedCats = Object.entries(n.gapRevenueEstimates)
                    .sort((a, b) => b[1] - a[1])
                    .filter(([_, v]) => v > 0);

                if (sortedCats.length > 0) {
                    revBreakdown = sortedCats.slice(0, 4).map(([cat, rev]) => {
                        const color = catColors[cat] || '#94a3b8';
                        return `<span style="font-size:0.7rem;color:${color};">${cat.replace(/_/g, ' ')}: $${Math.round(rev).toLocaleString()}</span>`;
                    }).join(' ¬∑ ');
                }

                return `
                <div class="niche-universe-card">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                        <div>
                            <h3 style="color:#e2e8f0;text-transform:capitalize;font-size:1.1rem;">
                                ${n.niche.replace(/_/g, ' ')}
                                ${n.nicheMult > 1 ? `<span style="font-size:0.7rem;color:#4ade80;margin-left:6px;">${n.nicheMult}x niche</span>` : ''}
                            </h3>
                            <span style="font-size:0.8rem;color:#64748b;">${n.brands} brands tracked</span>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:1.5rem;font-weight:700;color:${covColor};">${n.coveragePct}%</div>
                            <div style="font-size:0.7rem;color:#64748b;">coverage</div>
                        </div>
                    </div>

                    <!-- Stats row -->
                    <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;margin-bottom:16px;">
                        <div style="text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#a78bfa;">${n.universeSize.toLocaleString()}</div>
                            <div style="font-size:0.65rem;color:#64748b;">Universe</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#4ade80;">${n.existing.toLocaleString()}</div>
                            <div style="font-size:0.65rem;color:#64748b;">You Have</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#f97316;">${n.gap.toLocaleString()}</div>
                            <div style="font-size:0.65rem;color:#64748b;">Missing</div>
                        </div>
                        <div style="text-align:center;">
                            <div style="font-size:1.1rem;font-weight:600;color:#fbbf24;">$${Math.round(n.totalGapRevenue).toLocaleString()}</div>
                            <div style="font-size:0.65rem;color:#64748b;">Gap Revenue</div>
                        </div>
                    </div>

                    <!-- Coverage bar -->
                    <div class="coverage-bar" style="margin-bottom:16px;height:20px;">
                        <div class="coverage-fill" style="width:${Math.max(2, n.coveragePct)}%;background:${covColor};">
                            ${n.existing}/${n.universeSize}
                        </div>
                    </div>

                    <!-- Category breakdown -->
                    <div style="margin-bottom:12px;">
                        <h4 style="font-size:0.8rem;color:#94a3b8;margin-bottom:8px;">Category Coverage</h4>
                        ${catBarsHtml}
                    </div>

                    ${revBreakdown ? `
                    <div style="margin-bottom:12px;padding-top:8px;border-top:1px solid rgba(71,85,105,0.3);">
                        <span style="font-size:0.7rem;color:#64748b;">Gap revenue by type: </span>${revBreakdown}
                    </div>` : ''}

                    <!-- Sample gap keywords -->
                    ${gapsHtml ? `
                    <details style="margin-top:8px;">
                        <summary style="cursor:pointer;font-size:0.8rem;color:#fbbf24;user-select:none;">
                            Sample missing keywords (${n.gap.toLocaleString()} total gaps)
                        </summary>
                        <div style="margin-top:8px;padding:12px;background:rgba(15,23,42,0.5);border-radius:8px;">
                            ${gapsHtml}
                        </div>
                    </details>` : ''}
                </div>
                `;
            }).join('');
        }

        // ============================================
        // CONTENT GAP ANALYSIS
        // ============================================
        let cgCompetitors = [];
        let cgSelectedCompetitors = [];
        let cgAnalysisData = null;
        let cgGapDisplayLimit = 30;
        let cgSiloCounts = {};

        async function loadGapCompetitors(silo) {
            const btn = document.getElementById('cg-load-competitors-btn');
            const btnText = document.getElementById('cg-comp-btn-text');
            const spinner = document.getElementById('cg-comp-spinner');

            btn.disabled = true;
            btnText.textContent = 'Discovering...';
            spinner.style.display = 'block';

            const siloParam = silo ? '?silo=' + encodeURIComponent(silo) : '';

            try {
                const response = await fetch('/api/content-gap/competitors' + siloParam);
                if (!response.ok) { alert('Error ' + response.status + ': ' + response.statusText); return; }
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { alert('Server returned invalid response. Check if you are logged in.'); console.error('Response:', text.substring(0, 200)); return; }

                if (data.success) {
                    cgCompetitors = data.competitors;
                    cgSelectedCompetitors = [];
                    renderCompetitorCards(data.competitors);
                    document.getElementById('cg-competitor-selection').style.display = 'block';
                    document.getElementById('cg-empty-state').style.display = 'none';
                    document.getElementById('cg-selected-count').textContent = '0 selected';
                    document.getElementById('cg-analyze-btn').disabled = true;
                    if (!silo) {
                        if (data.silo_counts) cgSiloCounts = data.silo_counts;
                        populateCgSiloFilter();
                    }
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch (error) {
                console.error('Content gap competitors error:', error);
                alert('Error loading competitors: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Discover Top Competitors';
                spinner.style.display = 'none';
            }
        }

        function onCgSiloChange() {
            const silo = document.getElementById('cg-silo-filter').value;
            loadGapCompetitors(silo);
        }

        function renderCompetitorCards(competitors) {
            const container = document.getElementById('cg-competitor-list');
            container.innerHTML = competitors.map((c, i) => `
                <div class="cg-comp-card" onclick="toggleCompetitor(this, '${escapeHtml(c.channel)}')" data-channel="${escapeHtml(c.channel)}">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <strong style="color:#e2e8f0;font-size:0.9rem;">${escapeHtml(c.channel)}</strong>
                        <span style="font-size:0.75rem;color:#a78bfa;">#${i + 1}</span>
                    </div>
                    <div style="display:flex;gap:12px;margin-top:8px;font-size:0.8rem;flex-wrap:wrap;">
                        <span style="color:#f87171;font-weight:600;">${c.gap_count} gaps</span>
                        <span style="color:#60a5fa;">${c.overlap_count} overlap</span>
                        <span style="color:#4ade80;">${c.win_count} we win</span>
                        <span style="color:#94a3b8;">Avg #${c.avg_rank}</span>
                        <span style="color:#fbbf24;">${(c.total_views / 1000000).toFixed(1)}M views</span>
                    </div>
                </div>
            `).join('');
        }

        function toggleCompetitor(el, channel) {
            const idx = cgSelectedCompetitors.indexOf(channel);
            if (idx > -1) {
                cgSelectedCompetitors.splice(idx, 1);
                el.classList.remove('selected');
            } else {
                cgSelectedCompetitors.push(channel);
                el.classList.add('selected');
            }
            document.getElementById('cg-selected-count').textContent = cgSelectedCompetitors.length + ' selected';
            document.getElementById('cg-analyze-btn').disabled = cgSelectedCompetitors.length === 0;
        }

        function selectAllCompetitors() {
            cgSelectedCompetitors = cgCompetitors.map(c => c.channel);
            document.querySelectorAll('.cg-comp-card').forEach(el => el.classList.add('selected'));
            document.getElementById('cg-selected-count').textContent = cgSelectedCompetitors.length + ' selected';
            document.getElementById('cg-analyze-btn').disabled = false;
        }

        function deselectAllCompetitors() {
            cgSelectedCompetitors = [];
            document.querySelectorAll('.cg-comp-card').forEach(el => el.classList.remove('selected'));
            document.getElementById('cg-selected-count').textContent = '0 selected';
            document.getElementById('cg-analyze-btn').disabled = true;
        }

        function populateCgSiloFilter() {
            const select = document.getElementById('cg-silo-filter');
            const totalComps = cgCompetitors.length;
            select.innerHTML = `<option value="">All Silos (${totalComps})</option>`;
            // Use BigQuery silo names directly, show gap keyword count
            // Sort by gap count descending so highest-opportunity silos are first
            const sorted = Object.entries(cgSiloCounts).sort((a, b) => b[1].gaps - a[1].gaps);
            sorted.forEach(([s, data]) => {
                const label = s.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                select.innerHTML += `<option value="${s}">${label} ‚Äî ${data.gaps} gaps, ${data.competitors} comps</option>`;
            });
        }

        async function runGapAnalysis() {
            const btn = document.getElementById('cg-analyze-btn');
            const btnText = document.getElementById('cg-analyze-btn-text');
            const spinner = document.getElementById('cg-analyze-spinner');

            btn.disabled = true;
            btnText.textContent = 'Analyzing...';
            spinner.style.display = 'block';

            try {
                const response = await fetch('/api/content-gap/analysis', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        competitors: cgSelectedCompetitors,
                        silo_filter: document.getElementById('cg-silo-filter').value,
                    })
                });
                if (!response.ok) { alert('Error ' + response.status + ': ' + response.statusText); return; }
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { alert('Server returned invalid response. Check if you are logged in.'); console.error('Response:', text.substring(0, 200)); return; }

                if (data.success) {
                    cgAnalysisData = data;
                    cgGapDisplayLimit = 30;
                    renderGapSummary(data);
                    renderGapTable(data);
                    document.getElementById('cg-results').style.display = 'block';
                } else {
                    alert('Error: ' + (data.error || 'Unknown'));
                }
            } catch (error) {
                console.error('Content gap analysis error:', error);
                alert('Error running analysis: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Analyze Content Gaps';
                spinner.style.display = 'none';
            }
        }

        function renderGapSummary(data) {
            const s = data.summary;
            document.getElementById('cg-gap-count').textContent = s.gap_count.toLocaleString();
            document.getElementById('cg-winning-count').textContent = s.winning_count.toLocaleString();
            document.getElementById('cg-overlap-count').textContent = s.overlap_count.toLocaleString();
            document.getElementById('cg-gap-volume').textContent = s.total_gap_volume.toLocaleString();
            document.getElementById('cg-gap-revenue').textContent = '$' + Math.round(s.top_30_gap_revenue).toLocaleString() + '/mo';
            document.getElementById('cg-total-compared').textContent = s.total_keywords_compared.toLocaleString();

            document.getElementById('cg-library-status').textContent =
                s.gap_not_in_library + ' gap keywords are NOT in your library';
            document.getElementById('cg-library-detail').textContent =
                s.gap_in_library + ' gap keywords already tracked. ' + s.gap_not_in_library + ' are completely new opportunities.';

            document.getElementById('cg-gaps-badge').textContent = s.gap_count;
            document.getElementById('cg-overlap-badge').textContent = s.overlap_count;
            document.getElementById('cg-winning-badge').textContent = s.winning_count;
        }

        function cgRankBadge(rank) {
            if (!rank) return '<span class="cg-rank-badge none">-</span>';
            const cls = rank <= 3 ? 'top3' : rank <= 5 ? 'top5' : 'top10';
            return `<span class="cg-rank-badge ${cls}">#${rank}</span>`;
        }

        function renderGapTable(data) {
            const comps = data.competitors;
            const gaps = data.gap_keywords.slice(0, cgGapDisplayLimit);
            const typeColors = {comparison:'#a78bfa', review:'#60a5fa', deal:'#fbbf24', best_of:'#f472b6', informational:'#94a3b8', other:'#64748b'};
            const th = 'style="text-align:center;padding:10px;color:#94a3b8;font-size:0.75rem;"';

            // Build dynamic header
            let headerHtml = `<tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                <th style="text-align:left;padding:10px;color:#94a3b8;font-size:0.75rem;">KEYWORD</th>
                <th ${th}>VOL</th>
                <th ${th}>TYPE</th>`;
            comps.forEach(c => { headerHtml += `<th ${th}>${escapeHtml(c)}</th>`; });
            headerHtml += `<th ${th}>EST. REV</th><th ${th}>SILO</th><th ${th}>IN LIB</th></tr>`;
            document.getElementById('cg-gap-thead').innerHTML = headerHtml;

            // Build rows
            document.getElementById('cg-gap-tbody').innerHTML = gaps.map(g => {
                const revStr = g.revenue_estimate ? '$' + Math.round(g.revenue_estimate).toLocaleString() : '-';
                let compCells = '';
                comps.forEach(c => {
                    const cd = g.competitors[c];
                    compCells += `<td style="padding:10px;text-align:center;">${cd ? cgRankBadge(cd.rank) : '-'}</td>`;
                });
                return `<tr style="border-bottom:1px solid rgba(71,85,105,0.2);">
                    <td style="padding:10px;color:#e2e8f0;">${escapeHtml(g.keyword)}</td>
                    <td style="padding:10px;text-align:center;color:#60a5fa;">${(g.search_volume || 0).toLocaleString()}</td>
                    <td style="padding:10px;text-align:center;"><span style="color:${typeColors[g.keyword_type] || '#94a3b8'};font-size:0.8rem;">${(g.keyword_type || '').replace(/_/g,' ')}</span></td>
                    ${compCells}
                    <td style="padding:10px;text-align:center;color:#4ade80;font-weight:600;">${revStr}</td>
                    <td style="padding:10px;text-align:center;font-size:0.8rem;color:#94a3b8;">${g.silo || '-'}</td>
                    <td style="padding:10px;text-align:center;">${g.in_library ? '<span style="color:#4ade80;">Y</span>' : '<span style="color:#f87171;">N</span>'}</td>
                </tr>`;
            }).join('');

            document.getElementById('cg-gap-show-more').style.display =
                data.gap_keywords.length > cgGapDisplayLimit ? 'block' : 'none';

            renderOverlapTable(data);
            renderWinningTable(data);
        }

        function renderOverlapTable(data) {
            const comps = data.competitors;
            const th = 'style="text-align:center;padding:10px;color:#94a3b8;font-size:0.75rem;"';

            // Dynamic header
            let headerHtml = `<tr style="border-bottom:1px solid rgba(71,85,105,0.5);">
                <th style="text-align:left;padding:10px;color:#94a3b8;font-size:0.75rem;">KEYWORD</th>
                <th ${th}>VOL</th>
                <th style="text-align:center;padding:10px;color:#f97316;font-size:0.75rem;">DIGIDOM</th>`;
            comps.forEach(c => { headerHtml += `<th ${th}>${escapeHtml(c)}</th>`; });
            headerHtml += `<th ${th}>STATUS</th></tr>`;
            document.getElementById('cg-overlap-thead').innerHTML = headerHtml;

            document.getElementById('cg-overlap-tbody').innerHTML = data.overlap_keywords.slice(0, 50).map(o => {
                const compRanks = Object.values(o.competitors).map(c => c.rank);
                const bestCompRank = Math.min(...compRanks);
                let status = '', statusColor = '#94a3b8';
                if (o.digidom_rank < bestCompRank) { status = 'Winning'; statusColor = '#4ade80'; }
                else if (o.digidom_rank > bestCompRank) { status = 'Losing'; statusColor = '#f87171'; }
                else { status = 'Tied'; statusColor = '#fbbf24'; }

                let compCells = '';
                comps.forEach(c => {
                    const cd = o.competitors[c];
                    compCells += `<td style="padding:10px;text-align:center;">${cd ? cgRankBadge(cd.rank) : '-'}</td>`;
                });

                return `<tr style="border-bottom:1px solid rgba(71,85,105,0.2);">
                    <td style="padding:10px;color:#e2e8f0;">${escapeHtml(o.keyword)}</td>
                    <td style="padding:10px;text-align:center;color:#60a5fa;">${(o.search_volume || 0).toLocaleString()}</td>
                    <td style="padding:10px;text-align:center;">${cgRankBadge(o.digidom_rank)}</td>
                    ${compCells}
                    <td style="padding:10px;text-align:center;color:${statusColor};font-weight:600;">${status}</td>
                </tr>`;
            }).join('');
        }

        function renderWinningTable(data) {
            const tbody = document.getElementById('cg-winning-tbody');
            tbody.innerHTML = data.winning_keywords.slice(0, 50).map(w => `
                <tr style="border-bottom:1px solid rgba(71,85,105,0.2);">
                    <td style="padding:10px;color:#e2e8f0;">${escapeHtml(w.keyword)}</td>
                    <td style="padding:10px;text-align:center;color:#60a5fa;">${(w.search_volume || 0).toLocaleString()}</td>
                    <td style="padding:10px;text-align:center;">${cgRankBadge(w.digidom_rank)}</td>
                    <td style="padding:10px;text-align:center;font-size:0.8rem;color:#94a3b8;">${w.silo || '-'}</td>
                </tr>
            `).join('');
        }

        function switchGapView(view, btnEl) {
            document.querySelectorAll('[data-cg-view]').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');
            document.getElementById('cg-gaps-view').style.display = view === 'gaps' ? 'block' : 'none';
            document.getElementById('cg-overlap-view').style.display = view === 'overlap' ? 'block' : 'none';
            document.getElementById('cg-winning-view').style.display = view === 'winning' ? 'block' : 'none';
        }

        function showMoreGapKeywords() {
            cgGapDisplayLimit += 30;
            renderGapTable(cgAnalysisData);
        }

        async function enrichGapKeywords() {
            if (!cgAnalysisData || !cgAnalysisData.gap_keywords.length) {
                alert('Run gap analysis first');
                return;
            }

            const btn = document.getElementById('cg-enrich-btn');
            const btnText = document.getElementById('cg-enrich-btn-text');
            const spinner = document.getElementById('cg-enrich-spinner');

            btn.disabled = true;
            btnText.textContent = 'Enriching...';
            spinner.style.display = 'block';

            const topGapKeywords = cgAnalysisData.gap_keywords.slice(0, 20).map(g => g.keyword);

            try {
                const response = await fetch('/api/content-gap/enrich', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ keywords: topGapKeywords })
                });
                if (!response.ok) { alert('Error ' + response.status); return; }
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); } catch(e) { alert('Server returned invalid response'); return; }

                if (data.success) {
                    renderEnrichedResults(data, topGapKeywords);
                    document.getElementById('cg-enriched-results').style.display = 'block';
                }
            } catch (error) {
                console.error('Enrich error:', error);
                alert('Error enriching keywords: ' + error.message);
            } finally {
                btn.disabled = false;
                btnText.textContent = 'Enrich Top 20 Gap Keywords';
                spinner.style.display = 'none';
            }
        }

        function renderEnrichedResults(data, keywords) {
            const container = document.getElementById('cg-enriched-results');
            let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:12px;">';

            keywords.forEach(kw => {
                const info = data.enriched[kw.toLowerCase()] || {};
                const trendIcon = info.trend === 'rising' ? 'üìà' : info.trend === 'declining' ? 'üìâ' : '‚û°Ô∏è';
                const trendColor = info.trend === 'rising' ? '#4ade80' : info.trend === 'declining' ? '#f87171' : '#94a3b8';

                html += `
                <div style="background:rgba(15,23,42,0.6);border:1px solid rgba(148,163,184,0.1);border-radius:12px;padding:16px;">
                    <div style="font-weight:600;color:#e2e8f0;margin-bottom:8px;">${escapeHtml(kw)}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:0.8rem;">
                        <span style="color:#94a3b8;">Volume:</span><span style="color:#60a5fa;">${(info.volume || 0).toLocaleString()}</span>
                        <span style="color:#94a3b8;">Competition:</span><span style="color:#fbbf24;">${info.competition || '-'}</span>
                        <span style="color:#94a3b8;">CPC:</span><span style="color:#4ade80;">$${info.cpc || '0'}</span>
                        <span style="color:#94a3b8;">Trend:</span><span style="color:${trendColor};">${trendIcon} ${info.trend || 'unknown'} (${info.trend_change_pct || 0}%)</span>
                    </div>`;

                const related = data.related_keywords[kw.toLowerCase()];
                if (related && related.length > 0) {
                    html += `<div style="margin-top:8px;"><span style="color:#64748b;font-size:0.7rem;">Related:</span> `;
                    html += related.slice(0, 5).map(r => {
                        const rkw = typeof r === 'string' ? r : (r.keyword || r);
                        return `<span style="display:inline-block;background:rgba(96,165,250,0.1);color:#60a5fa;padding:2px 8px;border-radius:4px;font-size:0.75rem;margin:2px;">${escapeHtml(rkw)}</span>`;
                    }).join('');
                    html += '</div>';
                }

                html += '</div>';
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Auto-load data when switching tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                if (this.dataset.tab === 'planner') {
                    if (dominationData) {
                        displayContentPlannerData(dominationData);
                    }
                }
                if (this.dataset.tab === 'opportunity') {
                    if (opportunityData.length === 0) {
                        loadOpportunities();
                    }
                }
                if (this.dataset.tab === 'universe') {
                    if (!universeData) {
                        loadUniverse();
                    }
                }
                if (this.dataset.tab === 'contentgap') {
                    if (!cgCompetitors.length) {
                        loadGapCompetitors();
                    }
                }
            });
        });

        // Initialize
        loadData();

        // Auto-load Smart Picks on page load (it's the default tab)
        loadSmartPicks();

        // Auto-load domination data on page load
        loadDominationData();
        checkDataFreshness();
    </script>

<!-- ============================================ -->
<!-- CHATBOT WIDGET - FAQ + Claude AI Fallback    -->
<!-- ============================================ -->
<style>
    #chatbot-bubble {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white;
        border: none;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(99, 102, 241, 0.4);
        z-index: 10010;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    #chatbot-bubble:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 28px rgba(99, 102, 241, 0.6);
    }
    #chatbot-panel {
        position: fixed;
        bottom: 92px;
        right: 24px;
        width: 380px;
        max-height: 520px;
        background: #1e1b4b;
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 16px;
        box-shadow: 0 8px 40px rgba(0,0,0,0.5);
        z-index: 10010;
        display: none;
        flex-direction: column;
        overflow: hidden;
        font-family: 'Inter', sans-serif;
    }
    #chatbot-panel.open { display: flex; }

    #chatbot-header {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        padding: 16px 18px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-shrink: 0;
    }
    #chatbot-header h3 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        color: #fff;
    }
    #chatbot-header span {
        font-size: 12px;
        color: rgba(255,255,255,0.7);
    }
    #chatbot-close {
        background: none;
        border: none;
        color: rgba(255,255,255,0.7);
        font-size: 20px;
        cursor: pointer;
        padding: 0 4px;
    }
    #chatbot-close:hover { color: #fff; }

    #chatbot-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        min-height: 200px;
        max-height: 320px;
    }
    .chat-msg {
        max-width: 88%;
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.6;
        word-wrap: break-word;
    }
    .chat-msg p {
        margin: 0 0 8px 0;
    }
    .chat-msg p:last-child {
        margin-bottom: 0;
    }
    .chat-msg strong {
        color: #c7d2fe;
        font-weight: 600;
    }
    .chat-msg.user strong {
        color: #fff;
    }
    .chat-list-num {
        color: #a78bfa;
        font-weight: 700;
        margin-right: 2px;
    }
    .chat-bullet {
        color: #a78bfa;
        margin-right: 4px;
    }
    .chat-msg.bot {
        background: rgba(99, 102, 241, 0.15);
        color: #e0e7ff;
        align-self: flex-start;
        border-bottom-left-radius: 4px;
    }
    .chat-msg.user {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        color: #fff;
        align-self: flex-end;
        border-bottom-right-radius: 4px;
    }

    .chat-suggestions {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        padding: 0 16px 12px;
        flex-shrink: 0;
    }
    .chat-suggestion-btn {
        background: rgba(99, 102, 241, 0.12);
        border: 1px solid rgba(99, 102, 241, 0.25);
        color: #a5b4fc;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    .chat-suggestion-btn:hover {
        background: rgba(99, 102, 241, 0.25);
        color: #c7d2fe;
    }

    #chatbot-input-area {
        display: flex;
        padding: 12px;
        border-top: 1px solid rgba(99, 102, 241, 0.15);
        gap: 8px;
        flex-shrink: 0;
    }
    #chatbot-input {
        flex: 1;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 10px;
        padding: 10px 14px;
        color: #e0e7ff;
        font-size: 13px;
        outline: none;
        font-family: 'Inter', sans-serif;
    }
    #chatbot-input::placeholder { color: rgba(148, 163, 184, 0.5); }
    #chatbot-input:focus { border-color: rgba(99, 102, 241, 0.5); }
    #chatbot-send {
        background: linear-gradient(135deg, #6366f1, #7c3aed);
        border: none;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
        transition: opacity 0.2s;
    }
    #chatbot-send:hover { opacity: 0.85; }
    #chatbot-send:disabled { opacity: 0.4; cursor: not-allowed; }

    .chat-typing {
        display: flex;
        gap: 4px;
        padding: 10px 14px;
        align-self: flex-start;
    }
    .chat-typing span {
        width: 8px;
        height: 8px;
        background: rgba(99, 102, 241, 0.5);
        border-radius: 50%;
        animation: chatTyping 1.2s ease-in-out infinite;
    }
    .chat-typing span:nth-child(2) { animation-delay: 0.2s; }
    .chat-typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes chatTyping {
        0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
        30% { transform: translateY(-6px); opacity: 1; }
    }
</style>

<button id="chatbot-bubble" onclick="toggleChatbot()" title="Need help?">?</button>

<div id="chatbot-panel">
    <div id="chatbot-header">
        <div>
            <h3>AI Help Assistant</h3>
            <span>Powered by Claude AI</span>
        </div>
        <button id="chatbot-close" onclick="toggleChatbot()">&times;</button>
    </div>
    <div id="chatbot-messages">
        <div class="chat-msg bot">Hi! I can help you find things and use features in the KW Command Center. Ask me anything or pick a topic below!</div>
    </div>
    <div class="chat-suggestions" id="chatbot-suggestions">
        <button class="chat-suggestion-btn" onclick="askSuggestion(this)">How do I add keywords?</button>
        <button class="chat-suggestion-btn" onclick="askSuggestion(this)">What is Domination Score?</button>
        <button class="chat-suggestion-btn" onclick="askSuggestion(this)">How to find trending topics?</button>
        <button class="chat-suggestion-btn" onclick="askSuggestion(this)">How to analyze competitors?</button>
    </div>
    <div id="chatbot-input-area">
        <input type="text" id="chatbot-input" placeholder="Type your question..." onkeydown="if(event.key==='Enter')sendChatMessage()">
        <button id="chatbot-send" onclick="sendChatMessage()">&#10148;</button>
    </div>
</div>

<script>
// ============================================
// FAQ Knowledge Base + Claude AI Fallback
// ============================================
const FAQ_DATA = [
    {
        keywords: ['add keyword', 'add keywords', 'new keyword', 'create keyword'],
        answer: 'To add keywords, go to the **Keyword Library** tab and click the **"+ Add Keywords"** button in the top-right.\n\nEnter your keywords, select a source and niche/silo, then save.\n\nYou can also add keywords from **Channel Analysis** in the Research tab.'
    },
    {
        keywords: ['smart picks', 'best keywords', 'recommendations', 'suggested keywords'],
        answer: 'Go to the **Smart Picks** tab (the default tab).\n\n1. Click **"Show Me the Best Keywords"**\n2. Use the niche filter to narrow results\n3. Sort by Best Overall, Highest Revenue, or Easiest to Rank'
    },
    {
        keywords: ['domination', 'domination score', 'serp position', 'my rankings', 'check rankings', 'where do i rank', 'ranking position', 'track rankings'],
        answer: 'The **Domination Score** tab tracks your YouTube SERP positions.\n\n1. Click **"Load Ranking Data"** to see scores\n2. Use **"Manage Keywords"** to set which keywords to track\n\n**Scoring:** Position 1 = 50%, Pos 2 = 25%, Pos 3 = 15%, Pos 4&5 = 5% each.\n\nClick any keyword row to see its history over time.'
    },
    {
        keywords: ['research', 'seed keyword', 'keyword research', 'find keywords', 'discover keywords'],
        answer: 'Go to the **Research** tab.\n\n1. Under **"Seed Keyword Research"**, enter a keyword\n2. Select a niche\n3. Click **"Research Keyword"**\n\nThis finds related keywords with volume and competition data.'
    },
    {
        keywords: ['trending', 'trends', 'trending topics', 'google trends', 'discover trends', 'trending topics not covering', 'rising topics'],
        answer: 'To find **trending topics you\'re not covering yet**:\n\nGo to the **Research** tab > **"Trending Topics Not Covered"**.\n\n1. Click **"Discover Trending Gaps"**\n2. Use the **silo filter** to narrow by niche (ID Theft, Dog, Data Broker, etc.)\n\nThis finds **rising Google Trends topics** you haven\'t made videos about yet - great for getting ahead of the competition!\n\nYou can also use **"Collect Trends"** in the Keyword Library to update trend data for your existing keywords.'
    },
    {
        keywords: ['channel analysis', 'analyze channel', 'competitor channel', 'youtube channel'],
        answer: 'Go to the **Research** tab and scroll to **"Channel Keyword Analysis"**.\n\n1. Enter a YouTube channel name or @handle\n2. Click analyze\n\nIt shows their publishing stats, top keywords, and hot keywords. You can add their keywords to your library.'
    },
    {
        keywords: ['library', 'keyword library', 'browse keywords', 'all keywords', 'manage keywords'],
        answer: 'The **Keyword Library** tab shows all 20K+ keywords.\n\n**Filters available:**\n- Search box\n- Niche dropdown\n- Tier buttons (A/B/C/D)\n- Label buttons (Interested/Maybe/Not Interested/Favorites)\n- Source dropdown\n\nClick column headers to sort.'
    },
    {
        keywords: ['content planner', 'video plan', 'content plan', 'how many videos', 'videos needed'],
        answer: 'The **Content Planner** tab creates a strategic video plan.\n\n1. Click **"Load Content Plan"**\n\n**Priority levels:**\n- Critical (<75%) - needs 3 videos\n- High (75-89%) - needs 3 videos\n- Medium (90-99%) - needs 2-3 videos\n- Maintain (100%) - needs 1-2 reserve'
    },
    {
        keywords: ['3k finder', '$3k', '3000', 'high earning', 'money keywords', 'opportunity'],
        answer: 'The **$3K Finder** tab finds keywords likely to earn $3,000/month each.\n\n1. Click **"Analyze All Keywords"**\n2. Use filters like **"Low Comp + High Rev"** (green button) for easy wins\n\nGoal: 10 keywords x $3K = $30K/month'
    },
    {
        keywords: ['universe', 'universe map', 'coverage', 'keyword gaps', 'missing keywords', 'how many keywords'],
        answer: 'The **Universe Map** tab shows every possible keyword in your niches.\n\n1. Click **"Map the Universe"**\n2. See your coverage % per niche\n3. Identify missing keywords (gaps) to target'
    },
    {
        keywords: ['content gap', 'competitor', 'competitors', 'compare', 'gap analysis', 'they rank', 'what am i missing', 'ranking that we are not', 'side by side', 'competitor channels', 'competitor comparison'],
        answer: 'The **Content Gap** tab does side-by-side comparison with competitor channels.\n\n**How to use it:**\n1. Click **"Discover Top Competitors"** to find top YouTube channels in your niches\n2. Select 2-3 competitors from the list\n3. Use the **Silo filter** to focus on a specific niche\n4. Click **"Analyze Content Gaps"**\n\n**3 views available:**\n- **Gaps** - keywords they rank for that you don\'t (your biggest opportunities!)\n- **Overlap** - keywords you both rank for\n- **Winning** - keywords you rank for that they don\'t\n\n**Bonus:** Click **"Enrich Top 20 Gap Keywords"** to get volume, competition, CPC, and trends for the best gap keywords.'
    },
    {
        keywords: ['not covering', 'not covered', 'keywords we don\'t have', 'what keywords are ranking', 'identify keywords', 'keywords ranking that we are not', 'keywords we are missing'],
        answer: 'To find keywords that are ranking but you\'re **not covering yet**:\n\n**Best method - Content Gap tab:**\n1. Click **"Discover Top Competitors"**\n2. Select 2-3 competitor channels\n3. Click **"Analyze Content Gaps"**\n4. Look at the **"Gaps"** view - these are keywords they rank for that you don\'t\n\n**Also useful:**\n- **Universe Map** tab > **"Map the Universe"** - shows all possible keywords per niche and your coverage %\n- **Research** tab > **"Trending Topics Not Covered"** - rising topics you haven\'t made videos about'
    },
    {
        keywords: ['low competition', 'less competition', 'good revenue', 'easy to rank', 'easy wins', 'low comp high rev', 'low competition high revenue'],
        answer: 'To find **low competition + good revenue** keywords:\n\n**Method 1 - $3K Finder tab:**\n1. Click **"Analyze All Keywords"**\n2. Click the green **"Low Comp + High Rev"** filter button\n3. These are your easiest wins with highest revenue potential\n\n**Method 2 - Smart Picks tab:**\n1. Click **"Show Me the Best Keywords"**\n2. Sort by **"Easiest to Rank"**\n3. These are AI-ranked by ease of ranking vs revenue\n\n**Method 3 - Keyword Library:**\n- Sort by competition column (low to high)\n- Cross-reference with revenue column'
    },
    {
        keywords: ['related keywords', 'high search volume', 'high volume low competition', 'search volume', 'volume but low competition', 'high volume'],
        answer: 'To find **related keywords with high volume but low competition**:\n\n**Method 1 - Research tab:**\n1. Enter a seed keyword under **"Seed Keyword Research"**\n2. Click **"Research Keyword"**\n3. Results show related keywords with volume and competition data\n\n**Method 2 - Content Gap tab:**\n1. Run a gap analysis against competitors\n2. Click **"Enrich Top 20 Gap Keywords"** to get volume, competition, CPC, and related keywords\n\n**Method 3 - Keyword Library:**\n- Sort by **Volume** column (high to low)\n- Filter by **Tier A** (best opportunity) keywords'
    },
    {
        keywords: ['analytics', 'revenue', 'revenue model', 'earnings', 'how much'],
        answer: 'The **Analytics** tab shows a calibrated revenue model based on actual data.\n\nIt breaks down revenue by keyword type:\n- Comparison\n- Review\n- Deal\n- Best Of\n- Informational'
    },
    {
        keywords: ['favorite', 'star', 'interested', 'label', 'tag keyword', 'mark keyword'],
        answer: 'In the **Keyword Library**, each keyword row has action buttons:\n\n- Star icon = Favorite\n- Checkmark = Interested\n- X = Not interested\n- ? = Maybe\n\nUse the label filter buttons at the top to view by label.'
    },
    {
        keywords: ['note', 'notes', 'comment', 'comments'],
        answer: 'In the **Keyword Library**, each keyword row has:\n\n- **Notes icon** - add/edit a personal note\n- **Comments icon** - add or view comments\n\nClick either icon to open the editor.'
    },
    {
        keywords: ['export', 'csv', 'download'],
        answer: 'In the **Keyword Library** tab, click the **"Export CSV"** button in the top toolbar to download all your keywords as a CSV file.'
    },
    {
        keywords: ['primary', 'secondary', 'parent keyword', 'silo', 'niche'],
        answer: 'Go to **Domination Score** > **"Manage Keywords"** to set up:\n\n- **Primary keywords** - your main ranking targets\n- **Secondary keywords** - support primary keywords\n- **Silos** - organize keywords by niche\n\nA primary keyword with secondaries can\'t be deactivated.'
    },
    {
        keywords: ['import', 'import json', 'rankings json', 'check rankings'],
        answer: 'Go to the **Domination Score** tab and click **"Import Results JSON"**.\n\nPaste the JSON output from the check_rankings.py script to update your SERP position data.'
    },
    {
        keywords: ['tier', 'a tier', 'b tier', 'c tier', 'd tier'],
        answer: 'Keywords are categorized into tiers:\n\n- **A** - Best opportunity\n- **B** - Good\n- **C** - Moderate\n- **D** - Low priority\n\nFilter by tier using the A/B/C/D buttons in the Keyword Library.'
    },
    {
        keywords: ['enrich', 'enrich keywords', 'get volume', 'keyword data', 'cpc'],
        answer: 'In the **Content Gap** tab, after finding gap keywords:\n\n1. Click **"Enrich Top 20 Gap Keywords"**\n2. Gets: search volume, competition score, CPC, trends, and related keywords'
    },
    {
        keywords: ['tabs', 'features', 'what can', 'overview', 'help', 'how to use', 'what does this do'],
        answer: 'The app has **9 main tabs:**\n\n1. **Smart Picks** - AI keyword recommendations\n2. **Research** - seed research, trends, channel analysis\n3. **Keyword Library** - browse/manage all keywords\n4. **Domination Score** - SERP tracking\n5. **Content Planner** - video planning\n6. **Analytics** - revenue model\n7. **$3K Finder** - high-earner opportunities\n8. **Universe Map** - coverage gaps\n9. **Content Gap** - competitor comparison\n\nAsk me about any specific tab!'
    }
];

function searchFAQ(question) {
    const q = question.toLowerCase();
    let bestMatch = null;
    let bestScore = 0;

    for (const faq of FAQ_DATA) {
        let score = 0;
        for (const kw of faq.keywords) {
            if (q.includes(kw)) {
                score += kw.split(' ').length;
            }
        }
        if (score > bestScore) {
            bestScore = score;
            bestMatch = faq;
        }
    }
    return bestScore >= 1 ? bestMatch : null;
}

let chatbotOpen = false;

function toggleChatbot() {
    chatbotOpen = !chatbotOpen;
    document.getElementById('chatbot-panel').classList.toggle('open', chatbotOpen);
    if (chatbotOpen) {
        document.getElementById('chatbot-input').focus();
    }
}

function askSuggestion(btn) {
    const text = btn.textContent;
    document.getElementById('chatbot-input').value = text;
    sendChatMessage();
}

function formatBotMessage(text) {
    // Escape HTML first
    let html = text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    // Bold text: **text** or *text*
    html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
    html = html.replace(/\*(.+?)\*/g, '<strong>$1</strong>');
    // Numbered lists: lines starting with 1. 2. etc
    html = html.replace(/^(\d+)\.\s+/gm, '<span class="chat-list-num">$1.</span> ');
    // Bullet points: lines starting with - or ‚Ä¢
    html = html.replace(/^[-‚Ä¢]\s+/gm, '<span class="chat-bullet">&#8226;</span> ');
    // Double newlines = paragraph break, single newline = line break
    html = html.replace(/\n\n/g, '</p><p>');
    html = html.replace(/\n/g, '<br>');
    html = '<p>' + html + '</p>';
    return html;
}

function addChatMessage(text, type) {
    const messages = document.getElementById('chatbot-messages');
    const div = document.createElement('div');
    div.className = `chat-msg ${type}`;
    div.innerHTML = type === 'bot' ? formatBotMessage(text) : text;
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function showTyping() {
    const messages = document.getElementById('chatbot-messages');
    const div = document.createElement('div');
    div.className = 'chat-typing';
    div.id = 'chatbot-typing';
    div.innerHTML = '<span></span><span></span><span></span>';
    messages.appendChild(div);
    messages.scrollTop = messages.scrollHeight;
}

function hideTyping() {
    const el = document.getElementById('chatbot-typing');
    if (el) el.remove();
}

async function sendChatMessage() {
    const input = document.getElementById('chatbot-input');
    const sendBtn = document.getElementById('chatbot-send');
    const question = input.value.trim();
    if (!question) return;

    // Show user message
    addChatMessage(question, 'user');
    input.value = '';

    // Hide suggestions after first message
    document.getElementById('chatbot-suggestions').style.display = 'none';

    // Try FAQ first (instant, no API needed)
    const faqResult = searchFAQ(question);
    if (faqResult) {
        addChatMessage(faqResult.answer, 'bot');
        return;
    }

    // Fallback to Claude AI for unknown questions
    sendBtn.disabled = true;
    input.disabled = true;
    showTyping();

    try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 35000);
        const resp = await fetch('/api/chatbot', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({question}),
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        const data = await resp.json();
        hideTyping();

        if (data.success) {
            addChatMessage(data.answer, 'bot');
        } else {
            addChatMessage("Sorry, something went wrong. Please try again.", 'bot');
        }
    } catch (err) {
        hideTyping();
        addChatMessage("Sorry, I couldn't reach the server. Please try again.", 'bot');
    } finally {
        sendBtn.disabled = false;
        input.disabled = false;
        input.focus();
    }
}
</script>
</body>
</html>
